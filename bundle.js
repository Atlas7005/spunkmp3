(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,(function(r){var n=e[i][1][r];return o(n||r)}),p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){const ytdl=require("ytdl-core");const ffmpeg=require("fluent-ffmpeg");const sanitize=require("sanitize-filename");const readline=require("readline");const rl=readline.createInterface({input:process.stdin,output:process.stdout});function ask(error=null){console.clear();if(error)console.log(error);console.log(` _______  _______           _        _           _______  _______  ______  \n(  ____ \\(  ____ )|\\     /|( (    /|| \\    /\\   (       )(  ____ )/ ___  \\ \n| (    \\/| (    )|| )   ( ||  \\  ( ||  \\  / /   | () () || (    )|\\/   \\  \\\n| (_____ | (____)|| |   | ||   \\ | ||  (_/ /    | || || || (____)|   ___) /\n(_____  )|  _____)| |   | || (\\ \\) ||   _ (     | |(_)| ||  _____)  (___ ( \n        ) || (      | |   | || | \\   ||  ( \\ \\    | |   | || (            ) \\\n/\\____) || )      | (___) || )  \\  ||  /  \\ \\ _ | )   ( || )      /\\___/  /\n\\_______)|/       (_______)|/    )_)|_/    \\/(_)|/     \\||/       \\______/ `);rl.question("Please provide a YouTube Video Link (e.g. https://www.youtube.com/watch?v=XheZVrhHr74):",(answer=>{if(["exit","none","quit","stop"].includes(answer.toLowerCase()))return rl.close();let url=answer;if(!/^((?:https?:)?\/\/)?((?:www|m)\.)?((?:youtube(-nocookie)?\.com|youtu.be))(\/(?:[\w\-]+\?v=|embed\/|v\/)?)([\w\-]+)(\S+)?$/i.test(url))return ask("Invalid URL");rl.question("Please provide a file format (e.g. mp3 or mp4):",(answer=>{if(["exit","none","quit","stop"].includes(answer.toLowerCase()))return rl.close();let format=answer;if(!["mp3","mp4"].includes(format.trim().toLowerCase()))return ask("Invalid file format. Please provide a valid file format (e.g. mp3 or mp4)");download(url,format)}))}))}async function download(url,format){const vidInfo=await ytdl.getInfo(url);const title=vidInfo.player_response.videoDetails.title;const author=vidInfo.player_response.videoDetails.author.replace(" - Topic","");var start;const video=ytdl(url,{quality:format.toLowerCase()==="mp3"?"highestaudio":"highestvideo"});if(format=="mp3"){const audio=ffmpeg(video).audioBitrate(320).format("mp3").once("start",(()=>{console.log(`Downloading ${title} by ${author}...`);start=new Date})).on("error",(function(err){console.log("An error occurred: "+err.message)})).on("progress",(function(progress){console.log(`${progress.timemark} - ${progress.percent}% done.`)})).on("end",(function(){console.log("Processing finished! Downloaded in "+(new Date-start)+"ms");return setTimeout((()=>ask()),2500)}));audio.save(sanitize(`${author} - ${title}.mp3`))}else if(format=="mp4"){const vid=ffmpeg(video).format("mp4").once("start",(()=>{console.log(`Downloading ${title} by ${author}...`);start=new Date})).on("error",(function(err){console.log("An error occurred: "+err.message)})).on("progress",(function(progress){console.log(`${progress.timemark} - ${progress.percent}% done.`)})).on("end",(function(){console.log("Processing finished! Downloaded in "+(new Date-start)+"ms");return setTimeout((()=>ask()),2500)}));vid.save(sanitize(`${author} - ${title}.mp4`))}}ask()},{"fluent-ffmpeg":3,readline:undefined,"sanitize-filename":26,"ytdl-core":34}],2:[function(require,module,exports){(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(exports):typeof define==="function"&&define.amd?define(["exports"],factory):factory(global.async={})})(this,(function(exports){"use strict";function apply(fn,...args){return(...callArgs)=>fn(...args,...callArgs)}function initialParams(fn){return function(...args){var callback=args.pop();return fn.call(this,args,callback)}}var hasQueueMicrotask=typeof queueMicrotask==="function"&&queueMicrotask;var hasSetImmediate=typeof setImmediate==="function"&&setImmediate;var hasNextTick=typeof process==="object"&&typeof process.nextTick==="function";function fallback(fn){setTimeout(fn,0)}function wrap(defer){return(fn,...args)=>defer((()=>fn(...args)))}var _defer;if(hasQueueMicrotask){_defer=queueMicrotask}else if(hasSetImmediate){_defer=setImmediate}else if(hasNextTick){_defer=process.nextTick}else{_defer=fallback}var setImmediate$1=wrap(_defer);function asyncify(func){if(isAsync(func)){return function(...args){const callback=args.pop();const promise=func.apply(this,args);return handlePromise(promise,callback)}}return initialParams((function(args,callback){var result;try{result=func.apply(this,args)}catch(e){return callback(e)}if(result&&typeof result.then==="function"){return handlePromise(result,callback)}else{callback(null,result)}}))}function handlePromise(promise,callback){return promise.then((value=>{invokeCallback(callback,null,value)}),(err=>{invokeCallback(callback,err&&err.message?err:new Error(err))}))}function invokeCallback(callback,error,value){try{callback(error,value)}catch(err){setImmediate$1((e=>{throw e}),err)}}function isAsync(fn){return fn[Symbol.toStringTag]==="AsyncFunction"}function isAsyncGenerator(fn){return fn[Symbol.toStringTag]==="AsyncGenerator"}function isAsyncIterable(obj){return typeof obj[Symbol.asyncIterator]==="function"}function wrapAsync(asyncFn){if(typeof asyncFn!=="function")throw new Error("expected a function");return isAsync(asyncFn)?asyncify(asyncFn):asyncFn}function awaitify(asyncFn,arity=asyncFn.length){if(!arity)throw new Error("arity is undefined");function awaitable(...args){if(typeof args[arity-1]==="function"){return asyncFn.apply(this,args)}return new Promise(((resolve,reject)=>{args[arity-1]=(err,...cbArgs)=>{if(err)return reject(err);resolve(cbArgs.length>1?cbArgs:cbArgs[0])};asyncFn.apply(this,args)}))}return awaitable}function applyEach(eachfn){return function applyEach(fns,...callArgs){const go=awaitify((function(callback){var that=this;return eachfn(fns,((fn,cb)=>{wrapAsync(fn).apply(that,callArgs.concat(cb))}),callback)}));return go}}function _asyncMap(eachfn,arr,iteratee,callback){arr=arr||[];var results=[];var counter=0;var _iteratee=wrapAsync(iteratee);return eachfn(arr,((value,_,iterCb)=>{var index=counter++;_iteratee(value,((err,v)=>{results[index]=v;iterCb(err)}))}),(err=>{callback(err,results)}))}function isArrayLike(value){return value&&typeof value.length==="number"&&value.length>=0&&value.length%1===0}const breakLoop={};function once(fn){function wrapper(...args){if(fn===null)return;var callFn=fn;fn=null;callFn.apply(this,args)}Object.assign(wrapper,fn);return wrapper}function getIterator(coll){return coll[Symbol.iterator]&&coll[Symbol.iterator]()}function createArrayIterator(coll){var i=-1;var len=coll.length;return function next(){return++i<len?{value:coll[i],key:i}:null}}function createES2015Iterator(iterator){var i=-1;return function next(){var item=iterator.next();if(item.done)return null;i++;return{value:item.value,key:i}}}function createObjectIterator(obj){var okeys=obj?Object.keys(obj):[];var i=-1;var len=okeys.length;return function next(){var key=okeys[++i];if(key==="__proto__"){return next()}return i<len?{value:obj[key],key:key}:null}}function createIterator(coll){if(isArrayLike(coll)){return createArrayIterator(coll)}var iterator=getIterator(coll);return iterator?createES2015Iterator(iterator):createObjectIterator(coll)}function onlyOnce(fn){return function(...args){if(fn===null)throw new Error("Callback was already called.");var callFn=fn;fn=null;callFn.apply(this,args)}}function asyncEachOfLimit(generator,limit,iteratee,callback){let done=false;let canceled=false;let awaiting=false;let running=0;let idx=0;function replenish(){if(running>=limit||awaiting||done)return;awaiting=true;generator.next().then((({value:value,done:iterDone})=>{if(canceled||done)return;awaiting=false;if(iterDone){done=true;if(running<=0){callback(null)}return}running++;iteratee(value,idx,iterateeCallback);idx++;replenish()})).catch(handleError)}function iterateeCallback(err,result){running-=1;if(canceled)return;if(err)return handleError(err);if(err===false){done=true;canceled=true;return}if(result===breakLoop||done&&running<=0){done=true;return callback(null)}replenish()}function handleError(err){if(canceled)return;awaiting=false;done=true;callback(err)}replenish()}var eachOfLimit=limit=>(obj,iteratee,callback)=>{callback=once(callback);if(limit<=0){throw new RangeError("concurrency limit cannot be less than 1")}if(!obj){return callback(null)}if(isAsyncGenerator(obj)){return asyncEachOfLimit(obj,limit,iteratee,callback)}if(isAsyncIterable(obj)){return asyncEachOfLimit(obj[Symbol.asyncIterator](),limit,iteratee,callback)}var nextElem=createIterator(obj);var done=false;var canceled=false;var running=0;var looping=false;function iterateeCallback(err,value){if(canceled)return;running-=1;if(err){done=true;callback(err)}else if(err===false){done=true;canceled=true}else if(value===breakLoop||done&&running<=0){done=true;return callback(null)}else if(!looping){replenish()}}function replenish(){looping=true;while(running<limit&&!done){var elem=nextElem();if(elem===null){done=true;if(running<=0){callback(null)}return}running+=1;iteratee(elem.value,elem.key,onlyOnce(iterateeCallback))}looping=false}replenish()};function eachOfLimit$1(coll,limit,iteratee,callback){return eachOfLimit(limit)(coll,wrapAsync(iteratee),callback)}var eachOfLimit$2=awaitify(eachOfLimit$1,4);function eachOfArrayLike(coll,iteratee,callback){callback=once(callback);var index=0,completed=0,{length:length}=coll,canceled=false;if(length===0){callback(null)}function iteratorCallback(err,value){if(err===false){canceled=true}if(canceled===true)return;if(err){callback(err)}else if(++completed===length||value===breakLoop){callback(null)}}for(;index<length;index++){iteratee(coll[index],index,onlyOnce(iteratorCallback))}}function eachOfGeneric(coll,iteratee,callback){return eachOfLimit$2(coll,Infinity,iteratee,callback)}function eachOf(coll,iteratee,callback){var eachOfImplementation=isArrayLike(coll)?eachOfArrayLike:eachOfGeneric;return eachOfImplementation(coll,wrapAsync(iteratee),callback)}var eachOf$1=awaitify(eachOf,3);function map(coll,iteratee,callback){return _asyncMap(eachOf$1,coll,iteratee,callback)}var map$1=awaitify(map,3);var applyEach$1=applyEach(map$1);function eachOfSeries(coll,iteratee,callback){return eachOfLimit$2(coll,1,iteratee,callback)}var eachOfSeries$1=awaitify(eachOfSeries,3);function mapSeries(coll,iteratee,callback){return _asyncMap(eachOfSeries$1,coll,iteratee,callback)}var mapSeries$1=awaitify(mapSeries,3);var applyEachSeries=applyEach(mapSeries$1);const PROMISE_SYMBOL=Symbol("promiseCallback");function promiseCallback(){let resolve,reject;function callback(err,...args){if(err)return reject(err);resolve(args.length>1?args:args[0])}callback[PROMISE_SYMBOL]=new Promise(((res,rej)=>{resolve=res,reject=rej}));return callback}function auto(tasks,concurrency,callback){if(typeof concurrency!=="number"){callback=concurrency;concurrency=null}callback=once(callback||promiseCallback());var numTasks=Object.keys(tasks).length;if(!numTasks){return callback(null)}if(!concurrency){concurrency=numTasks}var results={};var runningTasks=0;var canceled=false;var hasError=false;var listeners=Object.create(null);var readyTasks=[];var readyToCheck=[];var uncheckedDependencies={};Object.keys(tasks).forEach((key=>{var task=tasks[key];if(!Array.isArray(task)){enqueueTask(key,[task]);readyToCheck.push(key);return}var dependencies=task.slice(0,task.length-1);var remainingDependencies=dependencies.length;if(remainingDependencies===0){enqueueTask(key,task);readyToCheck.push(key);return}uncheckedDependencies[key]=remainingDependencies;dependencies.forEach((dependencyName=>{if(!tasks[dependencyName]){throw new Error("async.auto task `"+key+"` has a non-existent dependency `"+dependencyName+"` in "+dependencies.join(", "))}addListener(dependencyName,(()=>{remainingDependencies--;if(remainingDependencies===0){enqueueTask(key,task)}}))}))}));checkForDeadlocks();processQueue();function enqueueTask(key,task){readyTasks.push((()=>runTask(key,task)))}function processQueue(){if(canceled)return;if(readyTasks.length===0&&runningTasks===0){return callback(null,results)}while(readyTasks.length&&runningTasks<concurrency){var run=readyTasks.shift();run()}}function addListener(taskName,fn){var taskListeners=listeners[taskName];if(!taskListeners){taskListeners=listeners[taskName]=[]}taskListeners.push(fn)}function taskComplete(taskName){var taskListeners=listeners[taskName]||[];taskListeners.forEach((fn=>fn()));processQueue()}function runTask(key,task){if(hasError)return;var taskCallback=onlyOnce(((err,...result)=>{runningTasks--;if(err===false){canceled=true;return}if(result.length<2){[result]=result}if(err){var safeResults={};Object.keys(results).forEach((rkey=>{safeResults[rkey]=results[rkey]}));safeResults[key]=result;hasError=true;listeners=Object.create(null);if(canceled)return;callback(err,safeResults)}else{results[key]=result;taskComplete(key)}}));runningTasks++;var taskFn=wrapAsync(task[task.length-1]);if(task.length>1){taskFn(results,taskCallback)}else{taskFn(taskCallback)}}function checkForDeadlocks(){var currentTask;var counter=0;while(readyToCheck.length){currentTask=readyToCheck.pop();counter++;getDependents(currentTask).forEach((dependent=>{if(--uncheckedDependencies[dependent]===0){readyToCheck.push(dependent)}}))}if(counter!==numTasks){throw new Error("async.auto cannot execute tasks due to a recursive dependency")}}function getDependents(taskName){var result=[];Object.keys(tasks).forEach((key=>{const task=tasks[key];if(Array.isArray(task)&&task.indexOf(taskName)>=0){result.push(key)}}));return result}return callback[PROMISE_SYMBOL]}var FN_ARGS=/^(?:async\s+)?(?:function)?\s*\w*\s*\(\s*([^)]+)\s*\)(?:\s*{)/;var ARROW_FN_ARGS=/^(?:async\s+)?\(?\s*([^)=]+)\s*\)?(?:\s*=>)/;var FN_ARG_SPLIT=/,/;var FN_ARG=/(=.+)?(\s*)$/;function stripComments(string){let stripped="";let index=0;let endBlockComment=string.indexOf("*/");while(index<string.length){if(string[index]==="/"&&string[index+1]==="/"){let endIndex=string.indexOf("\n",index);index=endIndex===-1?string.length:endIndex}else if(endBlockComment!==-1&&string[index]==="/"&&string[index+1]==="*"){let endIndex=string.indexOf("*/",index);if(endIndex!==-1){index=endIndex+2;endBlockComment=string.indexOf("*/",index)}else{stripped+=string[index];index++}}else{stripped+=string[index];index++}}return stripped}function parseParams(func){const src=stripComments(func.toString());let match=src.match(FN_ARGS);if(!match){match=src.match(ARROW_FN_ARGS)}if(!match)throw new Error("could not parse args in autoInject\nSource:\n"+src);let[,args]=match;return args.replace(/\s/g,"").split(FN_ARG_SPLIT).map((arg=>arg.replace(FN_ARG,"").trim()))}function autoInject(tasks,callback){var newTasks={};Object.keys(tasks).forEach((key=>{var taskFn=tasks[key];var params;var fnIsAsync=isAsync(taskFn);var hasNoDeps=!fnIsAsync&&taskFn.length===1||fnIsAsync&&taskFn.length===0;if(Array.isArray(taskFn)){params=[...taskFn];taskFn=params.pop();newTasks[key]=params.concat(params.length>0?newTask:taskFn)}else if(hasNoDeps){newTasks[key]=taskFn}else{params=parseParams(taskFn);if(taskFn.length===0&&!fnIsAsync&&params.length===0){throw new Error("autoInject task functions require explicit parameters.")}if(!fnIsAsync)params.pop();newTasks[key]=params.concat(newTask)}function newTask(results,taskCb){var newArgs=params.map((name=>results[name]));newArgs.push(taskCb);wrapAsync(taskFn)(...newArgs)}}));return auto(newTasks,callback)}class DLL{constructor(){this.head=this.tail=null;this.length=0}removeLink(node){if(node.prev)node.prev.next=node.next;else this.head=node.next;if(node.next)node.next.prev=node.prev;else this.tail=node.prev;node.prev=node.next=null;this.length-=1;return node}empty(){while(this.head)this.shift();return this}insertAfter(node,newNode){newNode.prev=node;newNode.next=node.next;if(node.next)node.next.prev=newNode;else this.tail=newNode;node.next=newNode;this.length+=1}insertBefore(node,newNode){newNode.prev=node.prev;newNode.next=node;if(node.prev)node.prev.next=newNode;else this.head=newNode;node.prev=newNode;this.length+=1}unshift(node){if(this.head)this.insertBefore(this.head,node);else setInitial(this,node)}push(node){if(this.tail)this.insertAfter(this.tail,node);else setInitial(this,node)}shift(){return this.head&&this.removeLink(this.head)}pop(){return this.tail&&this.removeLink(this.tail)}toArray(){return[...this]}*[Symbol.iterator](){var cur=this.head;while(cur){yield cur.data;cur=cur.next}}remove(testFn){var curr=this.head;while(curr){var{next:next}=curr;if(testFn(curr)){this.removeLink(curr)}curr=next}return this}}function setInitial(dll,node){dll.length=1;dll.head=dll.tail=node}function queue(worker,concurrency,payload){if(concurrency==null){concurrency=1}else if(concurrency===0){throw new RangeError("Concurrency must not be zero")}var _worker=wrapAsync(worker);var numRunning=0;var workersList=[];const events={error:[],drain:[],saturated:[],unsaturated:[],empty:[]};function on(event,handler){events[event].push(handler)}function once(event,handler){const handleAndRemove=(...args)=>{off(event,handleAndRemove);handler(...args)};events[event].push(handleAndRemove)}function off(event,handler){if(!event)return Object.keys(events).forEach((ev=>events[ev]=[]));if(!handler)return events[event]=[];events[event]=events[event].filter((ev=>ev!==handler))}function trigger(event,...args){events[event].forEach((handler=>handler(...args)))}var processingScheduled=false;function _insert(data,insertAtFront,rejectOnError,callback){if(callback!=null&&typeof callback!=="function"){throw new Error("task callback must be a function")}q.started=true;var res,rej;function promiseCallback(err,...args){if(err)return rejectOnError?rej(err):res();if(args.length<=1)return res(args[0]);res(args)}var item={data:data,callback:rejectOnError?promiseCallback:callback||promiseCallback};if(insertAtFront){q._tasks.unshift(item)}else{q._tasks.push(item)}if(!processingScheduled){processingScheduled=true;setImmediate$1((()=>{processingScheduled=false;q.process()}))}if(rejectOnError||!callback){return new Promise(((resolve,reject)=>{res=resolve;rej=reject}))}}function _createCB(tasks){return function(err,...args){numRunning-=1;for(var i=0,l=tasks.length;i<l;i++){var task=tasks[i];var index=workersList.indexOf(task);if(index===0){workersList.shift()}else if(index>0){workersList.splice(index,1)}task.callback(err,...args);if(err!=null){trigger("error",err,task.data)}}if(numRunning<=q.concurrency-q.buffer){trigger("unsaturated")}if(q.idle()){trigger("drain")}q.process()}}function _maybeDrain(data){if(data.length===0&&q.idle()){setImmediate$1((()=>trigger("drain")));return true}return false}const eventMethod=name=>handler=>{if(!handler){return new Promise(((resolve,reject)=>{once(name,((err,data)=>{if(err)return reject(err);resolve(data)}))}))}off(name);on(name,handler)};var isProcessing=false;var q={_tasks:new DLL,*[Symbol.iterator](){yield*q._tasks[Symbol.iterator]()},concurrency:concurrency,payload:payload,buffer:concurrency/4,started:false,paused:false,push(data,callback){if(Array.isArray(data)){if(_maybeDrain(data))return;return data.map((datum=>_insert(datum,false,false,callback)))}return _insert(data,false,false,callback)},pushAsync(data,callback){if(Array.isArray(data)){if(_maybeDrain(data))return;return data.map((datum=>_insert(datum,false,true,callback)))}return _insert(data,false,true,callback)},kill(){off();q._tasks.empty()},unshift(data,callback){if(Array.isArray(data)){if(_maybeDrain(data))return;return data.map((datum=>_insert(datum,true,false,callback)))}return _insert(data,true,false,callback)},unshiftAsync(data,callback){if(Array.isArray(data)){if(_maybeDrain(data))return;return data.map((datum=>_insert(datum,true,true,callback)))}return _insert(data,true,true,callback)},remove(testFn){q._tasks.remove(testFn)},process(){if(isProcessing){return}isProcessing=true;while(!q.paused&&numRunning<q.concurrency&&q._tasks.length){var tasks=[],data=[];var l=q._tasks.length;if(q.payload)l=Math.min(l,q.payload);for(var i=0;i<l;i++){var node=q._tasks.shift();tasks.push(node);workersList.push(node);data.push(node.data)}numRunning+=1;if(q._tasks.length===0){trigger("empty")}if(numRunning===q.concurrency){trigger("saturated")}var cb=onlyOnce(_createCB(tasks));_worker(data,cb)}isProcessing=false},length(){return q._tasks.length},running(){return numRunning},workersList(){return workersList},idle(){return q._tasks.length+numRunning===0},pause(){q.paused=true},resume(){if(q.paused===false){return}q.paused=false;setImmediate$1(q.process)}};Object.defineProperties(q,{saturated:{writable:false,value:eventMethod("saturated")},unsaturated:{writable:false,value:eventMethod("unsaturated")},empty:{writable:false,value:eventMethod("empty")},drain:{writable:false,value:eventMethod("drain")},error:{writable:false,value:eventMethod("error")}});return q}function cargo(worker,payload){return queue(worker,1,payload)}function cargo$1(worker,concurrency,payload){return queue(worker,concurrency,payload)}function reduce(coll,memo,iteratee,callback){callback=once(callback);var _iteratee=wrapAsync(iteratee);return eachOfSeries$1(coll,((x,i,iterCb)=>{_iteratee(memo,x,((err,v)=>{memo=v;iterCb(err)}))}),(err=>callback(err,memo)))}var reduce$1=awaitify(reduce,4);function seq(...functions){var _functions=functions.map(wrapAsync);return function(...args){var that=this;var cb=args[args.length-1];if(typeof cb=="function"){args.pop()}else{cb=promiseCallback()}reduce$1(_functions,args,((newargs,fn,iterCb)=>{fn.apply(that,newargs.concat(((err,...nextargs)=>{iterCb(err,nextargs)})))}),((err,results)=>cb(err,...results)));return cb[PROMISE_SYMBOL]}}function compose(...args){return seq(...args.reverse())}function mapLimit(coll,limit,iteratee,callback){return _asyncMap(eachOfLimit(limit),coll,iteratee,callback)}var mapLimit$1=awaitify(mapLimit,4);function concatLimit(coll,limit,iteratee,callback){var _iteratee=wrapAsync(iteratee);return mapLimit$1(coll,limit,((val,iterCb)=>{_iteratee(val,((err,...args)=>{if(err)return iterCb(err);return iterCb(err,args)}))}),((err,mapResults)=>{var result=[];for(var i=0;i<mapResults.length;i++){if(mapResults[i]){result=result.concat(...mapResults[i])}}return callback(err,result)}))}var concatLimit$1=awaitify(concatLimit,4);function concat(coll,iteratee,callback){return concatLimit$1(coll,Infinity,iteratee,callback)}var concat$1=awaitify(concat,3);function concatSeries(coll,iteratee,callback){return concatLimit$1(coll,1,iteratee,callback)}var concatSeries$1=awaitify(concatSeries,3);function constant(...args){return function(...ignoredArgs){var callback=ignoredArgs.pop();return callback(null,...args)}}function _createTester(check,getResult){return(eachfn,arr,_iteratee,cb)=>{var testPassed=false;var testResult;const iteratee=wrapAsync(_iteratee);eachfn(arr,((value,_,callback)=>{iteratee(value,((err,result)=>{if(err||err===false)return callback(err);if(check(result)&&!testResult){testPassed=true;testResult=getResult(true,value);return callback(null,breakLoop)}callback()}))}),(err=>{if(err)return cb(err);cb(null,testPassed?testResult:getResult(false))}))}}function detect(coll,iteratee,callback){return _createTester((bool=>bool),((res,item)=>item))(eachOf$1,coll,iteratee,callback)}var detect$1=awaitify(detect,3);function detectLimit(coll,limit,iteratee,callback){return _createTester((bool=>bool),((res,item)=>item))(eachOfLimit(limit),coll,iteratee,callback)}var detectLimit$1=awaitify(detectLimit,4);function detectSeries(coll,iteratee,callback){return _createTester((bool=>bool),((res,item)=>item))(eachOfLimit(1),coll,iteratee,callback)}var detectSeries$1=awaitify(detectSeries,3);function consoleFunc(name){return(fn,...args)=>wrapAsync(fn)(...args,((err,...resultArgs)=>{if(typeof console==="object"){if(err){if(console.error){console.error(err)}}else if(console[name]){resultArgs.forEach((x=>console[name](x)))}}}))}var dir=consoleFunc("dir");function doWhilst(iteratee,test,callback){callback=onlyOnce(callback);var _fn=wrapAsync(iteratee);var _test=wrapAsync(test);var results;function next(err,...args){if(err)return callback(err);if(err===false)return;results=args;_test(...args,check)}function check(err,truth){if(err)return callback(err);if(err===false)return;if(!truth)return callback(null,...results);_fn(next)}return check(null,true)}var doWhilst$1=awaitify(doWhilst,3);function doUntil(iteratee,test,callback){const _test=wrapAsync(test);return doWhilst$1(iteratee,((...args)=>{const cb=args.pop();_test(...args,((err,truth)=>cb(err,!truth)))}),callback)}function _withoutIndex(iteratee){return(value,index,callback)=>iteratee(value,callback)}function eachLimit(coll,iteratee,callback){return eachOf$1(coll,_withoutIndex(wrapAsync(iteratee)),callback)}var each=awaitify(eachLimit,3);function eachLimit$1(coll,limit,iteratee,callback){return eachOfLimit(limit)(coll,_withoutIndex(wrapAsync(iteratee)),callback)}var eachLimit$2=awaitify(eachLimit$1,4);function eachSeries(coll,iteratee,callback){return eachLimit$2(coll,1,iteratee,callback)}var eachSeries$1=awaitify(eachSeries,3);function ensureAsync(fn){if(isAsync(fn))return fn;return function(...args){var callback=args.pop();var sync=true;args.push(((...innerArgs)=>{if(sync){setImmediate$1((()=>callback(...innerArgs)))}else{callback(...innerArgs)}}));fn.apply(this,args);sync=false}}function every(coll,iteratee,callback){return _createTester((bool=>!bool),(res=>!res))(eachOf$1,coll,iteratee,callback)}var every$1=awaitify(every,3);function everyLimit(coll,limit,iteratee,callback){return _createTester((bool=>!bool),(res=>!res))(eachOfLimit(limit),coll,iteratee,callback)}var everyLimit$1=awaitify(everyLimit,4);function everySeries(coll,iteratee,callback){return _createTester((bool=>!bool),(res=>!res))(eachOfSeries$1,coll,iteratee,callback)}var everySeries$1=awaitify(everySeries,3);function filterArray(eachfn,arr,iteratee,callback){var truthValues=new Array(arr.length);eachfn(arr,((x,index,iterCb)=>{iteratee(x,((err,v)=>{truthValues[index]=!!v;iterCb(err)}))}),(err=>{if(err)return callback(err);var results=[];for(var i=0;i<arr.length;i++){if(truthValues[i])results.push(arr[i])}callback(null,results)}))}function filterGeneric(eachfn,coll,iteratee,callback){var results=[];eachfn(coll,((x,index,iterCb)=>{iteratee(x,((err,v)=>{if(err)return iterCb(err);if(v){results.push({index:index,value:x})}iterCb(err)}))}),(err=>{if(err)return callback(err);callback(null,results.sort(((a,b)=>a.index-b.index)).map((v=>v.value)))}))}function _filter(eachfn,coll,iteratee,callback){var filter=isArrayLike(coll)?filterArray:filterGeneric;return filter(eachfn,coll,wrapAsync(iteratee),callback)}function filter(coll,iteratee,callback){return _filter(eachOf$1,coll,iteratee,callback)}var filter$1=awaitify(filter,3);function filterLimit(coll,limit,iteratee,callback){return _filter(eachOfLimit(limit),coll,iteratee,callback)}var filterLimit$1=awaitify(filterLimit,4);function filterSeries(coll,iteratee,callback){return _filter(eachOfSeries$1,coll,iteratee,callback)}var filterSeries$1=awaitify(filterSeries,3);function forever(fn,errback){var done=onlyOnce(errback);var task=wrapAsync(ensureAsync(fn));function next(err){if(err)return done(err);if(err===false)return;task(next)}return next()}var forever$1=awaitify(forever,2);function groupByLimit(coll,limit,iteratee,callback){var _iteratee=wrapAsync(iteratee);return mapLimit$1(coll,limit,((val,iterCb)=>{_iteratee(val,((err,key)=>{if(err)return iterCb(err);return iterCb(err,{key:key,val:val})}))}),((err,mapResults)=>{var result={};var{hasOwnProperty:hasOwnProperty}=Object.prototype;for(var i=0;i<mapResults.length;i++){if(mapResults[i]){var{key:key}=mapResults[i];var{val:val}=mapResults[i];if(hasOwnProperty.call(result,key)){result[key].push(val)}else{result[key]=[val]}}}return callback(err,result)}))}var groupByLimit$1=awaitify(groupByLimit,4);function groupBy(coll,iteratee,callback){return groupByLimit$1(coll,Infinity,iteratee,callback)}function groupBySeries(coll,iteratee,callback){return groupByLimit$1(coll,1,iteratee,callback)}var log=consoleFunc("log");function mapValuesLimit(obj,limit,iteratee,callback){callback=once(callback);var newObj={};var _iteratee=wrapAsync(iteratee);return eachOfLimit(limit)(obj,((val,key,next)=>{_iteratee(val,key,((err,result)=>{if(err)return next(err);newObj[key]=result;next(err)}))}),(err=>callback(err,newObj)))}var mapValuesLimit$1=awaitify(mapValuesLimit,4);function mapValues(obj,iteratee,callback){return mapValuesLimit$1(obj,Infinity,iteratee,callback)}function mapValuesSeries(obj,iteratee,callback){return mapValuesLimit$1(obj,1,iteratee,callback)}function memoize(fn,hasher=(v=>v)){var memo=Object.create(null);var queues=Object.create(null);var _fn=wrapAsync(fn);var memoized=initialParams(((args,callback)=>{var key=hasher(...args);if(key in memo){setImmediate$1((()=>callback(null,...memo[key])))}else if(key in queues){queues[key].push(callback)}else{queues[key]=[callback];_fn(...args,((err,...resultArgs)=>{if(!err){memo[key]=resultArgs}var q=queues[key];delete queues[key];for(var i=0,l=q.length;i<l;i++){q[i](err,...resultArgs)}}))}}));memoized.memo=memo;memoized.unmemoized=fn;return memoized}var _defer$1;if(hasNextTick){_defer$1=process.nextTick}else if(hasSetImmediate){_defer$1=setImmediate}else{_defer$1=fallback}var nextTick=wrap(_defer$1);var _parallel=awaitify(((eachfn,tasks,callback)=>{var results=isArrayLike(tasks)?[]:{};eachfn(tasks,((task,key,taskCb)=>{wrapAsync(task)(((err,...result)=>{if(result.length<2){[result]=result}results[key]=result;taskCb(err)}))}),(err=>callback(err,results)))}),3);function parallel(tasks,callback){return _parallel(eachOf$1,tasks,callback)}function parallelLimit(tasks,limit,callback){return _parallel(eachOfLimit(limit),tasks,callback)}function queue$1(worker,concurrency){var _worker=wrapAsync(worker);return queue(((items,cb)=>{_worker(items[0],cb)}),concurrency,1)}class Heap{constructor(){this.heap=[];this.pushCount=Number.MIN_SAFE_INTEGER}get length(){return this.heap.length}empty(){this.heap=[];return this}percUp(index){let p;while(index>0&&smaller(this.heap[index],this.heap[p=parent(index)])){let t=this.heap[index];this.heap[index]=this.heap[p];this.heap[p]=t;index=p}}percDown(index){let l;while((l=leftChi(index))<this.heap.length){if(l+1<this.heap.length&&smaller(this.heap[l+1],this.heap[l])){l=l+1}if(smaller(this.heap[index],this.heap[l])){break}let t=this.heap[index];this.heap[index]=this.heap[l];this.heap[l]=t;index=l}}push(node){node.pushCount=++this.pushCount;this.heap.push(node);this.percUp(this.heap.length-1)}unshift(node){return this.heap.push(node)}shift(){let[top]=this.heap;this.heap[0]=this.heap[this.heap.length-1];this.heap.pop();this.percDown(0);return top}toArray(){return[...this]}*[Symbol.iterator](){for(let i=0;i<this.heap.length;i++){yield this.heap[i].data}}remove(testFn){let j=0;for(let i=0;i<this.heap.length;i++){if(!testFn(this.heap[i])){this.heap[j]=this.heap[i];j++}}this.heap.splice(j);for(let i=parent(this.heap.length-1);i>=0;i--){this.percDown(i)}return this}}function leftChi(i){return(i<<1)+1}function parent(i){return(i+1>>1)-1}function smaller(x,y){if(x.priority!==y.priority){return x.priority<y.priority}else{return x.pushCount<y.pushCount}}function priorityQueue(worker,concurrency){var q=queue$1(worker,concurrency);var processingScheduled=false;q._tasks=new Heap;q.push=function(data,priority=0,callback=(()=>{})){if(typeof callback!=="function"){throw new Error("task callback must be a function")}q.started=true;if(!Array.isArray(data)){data=[data]}if(data.length===0&&q.idle()){return setImmediate$1((()=>q.drain()))}for(var i=0,l=data.length;i<l;i++){var item={data:data[i],priority:priority,callback:callback};q._tasks.push(item)}if(!processingScheduled){processingScheduled=true;setImmediate$1((()=>{processingScheduled=false;q.process()}))}};delete q.unshift;return q}function race(tasks,callback){callback=once(callback);if(!Array.isArray(tasks))return callback(new TypeError("First argument to race must be an array of functions"));if(!tasks.length)return callback();for(var i=0,l=tasks.length;i<l;i++){wrapAsync(tasks[i])(callback)}}var race$1=awaitify(race,2);function reduceRight(array,memo,iteratee,callback){var reversed=[...array].reverse();return reduce$1(reversed,memo,iteratee,callback)}function reflect(fn){var _fn=wrapAsync(fn);return initialParams((function reflectOn(args,reflectCallback){args.push(((error,...cbArgs)=>{let retVal={};if(error){retVal.error=error}if(cbArgs.length>0){var value=cbArgs;if(cbArgs.length<=1){[value]=cbArgs}retVal.value=value}reflectCallback(null,retVal)}));return _fn.apply(this,args)}))}function reflectAll(tasks){var results;if(Array.isArray(tasks)){results=tasks.map(reflect)}else{results={};Object.keys(tasks).forEach((key=>{results[key]=reflect.call(this,tasks[key])}))}return results}function reject(eachfn,arr,_iteratee,callback){const iteratee=wrapAsync(_iteratee);return _filter(eachfn,arr,((value,cb)=>{iteratee(value,((err,v)=>{cb(err,!v)}))}),callback)}function reject$1(coll,iteratee,callback){return reject(eachOf$1,coll,iteratee,callback)}var reject$2=awaitify(reject$1,3);function rejectLimit(coll,limit,iteratee,callback){return reject(eachOfLimit(limit),coll,iteratee,callback)}var rejectLimit$1=awaitify(rejectLimit,4);function rejectSeries(coll,iteratee,callback){return reject(eachOfSeries$1,coll,iteratee,callback)}var rejectSeries$1=awaitify(rejectSeries,3);function constant$1(value){return function(){return value}}const DEFAULT_TIMES=5;const DEFAULT_INTERVAL=0;function retry(opts,task,callback){var options={times:DEFAULT_TIMES,intervalFunc:constant$1(DEFAULT_INTERVAL)};if(arguments.length<3&&typeof opts==="function"){callback=task||promiseCallback();task=opts}else{parseTimes(options,opts);callback=callback||promiseCallback()}if(typeof task!=="function"){throw new Error("Invalid arguments for async.retry")}var _task=wrapAsync(task);var attempt=1;function retryAttempt(){_task(((err,...args)=>{if(err===false)return;if(err&&attempt++<options.times&&(typeof options.errorFilter!="function"||options.errorFilter(err))){setTimeout(retryAttempt,options.intervalFunc(attempt-1))}else{callback(err,...args)}}))}retryAttempt();return callback[PROMISE_SYMBOL]}function parseTimes(acc,t){if(typeof t==="object"){acc.times=+t.times||DEFAULT_TIMES;acc.intervalFunc=typeof t.interval==="function"?t.interval:constant$1(+t.interval||DEFAULT_INTERVAL);acc.errorFilter=t.errorFilter}else if(typeof t==="number"||typeof t==="string"){acc.times=+t||DEFAULT_TIMES}else{throw new Error("Invalid arguments for async.retry")}}function retryable(opts,task){if(!task){task=opts;opts=null}let arity=opts&&opts.arity||task.length;if(isAsync(task)){arity+=1}var _task=wrapAsync(task);return initialParams(((args,callback)=>{if(args.length<arity-1||callback==null){args.push(callback);callback=promiseCallback()}function taskFn(cb){_task(...args,cb)}if(opts)retry(opts,taskFn,callback);else retry(taskFn,callback);return callback[PROMISE_SYMBOL]}))}function series(tasks,callback){return _parallel(eachOfSeries$1,tasks,callback)}function some(coll,iteratee,callback){return _createTester(Boolean,(res=>res))(eachOf$1,coll,iteratee,callback)}var some$1=awaitify(some,3);function someLimit(coll,limit,iteratee,callback){return _createTester(Boolean,(res=>res))(eachOfLimit(limit),coll,iteratee,callback)}var someLimit$1=awaitify(someLimit,4);function someSeries(coll,iteratee,callback){return _createTester(Boolean,(res=>res))(eachOfSeries$1,coll,iteratee,callback)}var someSeries$1=awaitify(someSeries,3);function sortBy(coll,iteratee,callback){var _iteratee=wrapAsync(iteratee);return map$1(coll,((x,iterCb)=>{_iteratee(x,((err,criteria)=>{if(err)return iterCb(err);iterCb(err,{value:x,criteria:criteria})}))}),((err,results)=>{if(err)return callback(err);callback(null,results.sort(comparator).map((v=>v.value)))}));function comparator(left,right){var a=left.criteria,b=right.criteria;return a<b?-1:a>b?1:0}}var sortBy$1=awaitify(sortBy,3);function timeout(asyncFn,milliseconds,info){var fn=wrapAsync(asyncFn);return initialParams(((args,callback)=>{var timedOut=false;var timer;function timeoutCallback(){var name=asyncFn.name||"anonymous";var error=new Error('Callback function "'+name+'" timed out.');error.code="ETIMEDOUT";if(info){error.info=info}timedOut=true;callback(error)}args.push(((...cbArgs)=>{if(!timedOut){callback(...cbArgs);clearTimeout(timer)}}));timer=setTimeout(timeoutCallback,milliseconds);fn(...args)}))}function range(size){var result=Array(size);while(size--){result[size]=size}return result}function timesLimit(count,limit,iteratee,callback){var _iteratee=wrapAsync(iteratee);return mapLimit$1(range(count),limit,_iteratee,callback)}function times(n,iteratee,callback){return timesLimit(n,Infinity,iteratee,callback)}function timesSeries(n,iteratee,callback){return timesLimit(n,1,iteratee,callback)}function transform(coll,accumulator,iteratee,callback){if(arguments.length<=3&&typeof accumulator==="function"){callback=iteratee;iteratee=accumulator;accumulator=Array.isArray(coll)?[]:{}}callback=once(callback||promiseCallback());var _iteratee=wrapAsync(iteratee);eachOf$1(coll,((v,k,cb)=>{_iteratee(accumulator,v,k,cb)}),(err=>callback(err,accumulator)));return callback[PROMISE_SYMBOL]}function tryEach(tasks,callback){var error=null;var result;return eachSeries$1(tasks,((task,taskCb)=>{wrapAsync(task)(((err,...args)=>{if(err===false)return taskCb(err);if(args.length<2){[result]=args}else{result=args}error=err;taskCb(err?null:{})}))}),(()=>callback(error,result)))}var tryEach$1=awaitify(tryEach);function unmemoize(fn){return(...args)=>(fn.unmemoized||fn)(...args)}function whilst(test,iteratee,callback){callback=onlyOnce(callback);var _fn=wrapAsync(iteratee);var _test=wrapAsync(test);var results=[];function next(err,...rest){if(err)return callback(err);results=rest;if(err===false)return;_test(check)}function check(err,truth){if(err)return callback(err);if(err===false)return;if(!truth)return callback(null,...results);_fn(next)}return _test(check)}var whilst$1=awaitify(whilst,3);function until(test,iteratee,callback){const _test=wrapAsync(test);return whilst$1((cb=>_test(((err,truth)=>cb(err,!truth)))),iteratee,callback)}function waterfall(tasks,callback){callback=once(callback);if(!Array.isArray(tasks))return callback(new Error("First argument to waterfall must be an array of functions"));if(!tasks.length)return callback();var taskIndex=0;function nextTask(args){var task=wrapAsync(tasks[taskIndex++]);task(...args,onlyOnce(next))}function next(err,...args){if(err===false)return;if(err||taskIndex===tasks.length){return callback(err,...args)}nextTask(args)}nextTask([])}var waterfall$1=awaitify(waterfall);var index={apply:apply,applyEach:applyEach$1,applyEachSeries:applyEachSeries,asyncify:asyncify,auto:auto,autoInject:autoInject,cargo:cargo,cargoQueue:cargo$1,compose:compose,concat:concat$1,concatLimit:concatLimit$1,concatSeries:concatSeries$1,constant:constant,detect:detect$1,detectLimit:detectLimit$1,detectSeries:detectSeries$1,dir:dir,doUntil:doUntil,doWhilst:doWhilst$1,each:each,eachLimit:eachLimit$2,eachOf:eachOf$1,eachOfLimit:eachOfLimit$2,eachOfSeries:eachOfSeries$1,eachSeries:eachSeries$1,ensureAsync:ensureAsync,every:every$1,everyLimit:everyLimit$1,everySeries:everySeries$1,filter:filter$1,filterLimit:filterLimit$1,filterSeries:filterSeries$1,forever:forever$1,groupBy:groupBy,groupByLimit:groupByLimit$1,groupBySeries:groupBySeries,log:log,map:map$1,mapLimit:mapLimit$1,mapSeries:mapSeries$1,mapValues:mapValues,mapValuesLimit:mapValuesLimit$1,mapValuesSeries:mapValuesSeries,memoize:memoize,nextTick:nextTick,parallel:parallel,parallelLimit:parallelLimit,priorityQueue:priorityQueue,queue:queue$1,race:race$1,reduce:reduce$1,reduceRight:reduceRight,reflect:reflect,reflectAll:reflectAll,reject:reject$2,rejectLimit:rejectLimit$1,rejectSeries:rejectSeries$1,retry:retry,retryable:retryable,seq:seq,series:series,setImmediate:setImmediate$1,some:some$1,someLimit:someLimit$1,someSeries:someSeries$1,sortBy:sortBy$1,timeout:timeout,times:times,timesLimit:timesLimit,timesSeries:timesSeries,transform:transform,tryEach:tryEach$1,unmemoize:unmemoize,until:until,waterfall:waterfall$1,whilst:whilst$1,all:every$1,allLimit:everyLimit$1,allSeries:everySeries$1,any:some$1,anyLimit:someLimit$1,anySeries:someSeries$1,find:detect$1,findLimit:detectLimit$1,findSeries:detectSeries$1,flatMap:concat$1,flatMapLimit:concatLimit$1,flatMapSeries:concatSeries$1,forEach:each,forEachSeries:eachSeries$1,forEachLimit:eachLimit$2,forEachOf:eachOf$1,forEachOfSeries:eachOfSeries$1,forEachOfLimit:eachOfLimit$2,inject:reduce$1,foldl:reduce$1,foldr:reduceRight,select:filter$1,selectLimit:filterLimit$1,selectSeries:filterSeries$1,wrapSync:asyncify,during:whilst$1,doDuring:doWhilst$1};exports.default=index;exports.apply=apply;exports.applyEach=applyEach$1;exports.applyEachSeries=applyEachSeries;exports.asyncify=asyncify;exports.auto=auto;exports.autoInject=autoInject;exports.cargo=cargo;exports.cargoQueue=cargo$1;exports.compose=compose;exports.concat=concat$1;exports.concatLimit=concatLimit$1;exports.concatSeries=concatSeries$1;exports.constant=constant;exports.detect=detect$1;exports.detectLimit=detectLimit$1;exports.detectSeries=detectSeries$1;exports.dir=dir;exports.doUntil=doUntil;exports.doWhilst=doWhilst$1;exports.each=each;exports.eachLimit=eachLimit$2;exports.eachOf=eachOf$1;exports.eachOfLimit=eachOfLimit$2;exports.eachOfSeries=eachOfSeries$1;exports.eachSeries=eachSeries$1;exports.ensureAsync=ensureAsync;exports.every=every$1;exports.everyLimit=everyLimit$1;exports.everySeries=everySeries$1;exports.filter=filter$1;exports.filterLimit=filterLimit$1;exports.filterSeries=filterSeries$1;exports.forever=forever$1;exports.groupBy=groupBy;exports.groupByLimit=groupByLimit$1;exports.groupBySeries=groupBySeries;exports.log=log;exports.map=map$1;exports.mapLimit=mapLimit$1;exports.mapSeries=mapSeries$1;exports.mapValues=mapValues;exports.mapValuesLimit=mapValuesLimit$1;exports.mapValuesSeries=mapValuesSeries;exports.memoize=memoize;exports.nextTick=nextTick;exports.parallel=parallel;exports.parallelLimit=parallelLimit;exports.priorityQueue=priorityQueue;exports.queue=queue$1;exports.race=race$1;exports.reduce=reduce$1;exports.reduceRight=reduceRight;exports.reflect=reflect;exports.reflectAll=reflectAll;exports.reject=reject$2;exports.rejectLimit=rejectLimit$1;exports.rejectSeries=rejectSeries$1;exports.retry=retry;exports.retryable=retryable;exports.seq=seq;exports.series=series;exports.setImmediate=setImmediate$1;exports.some=some$1;exports.someLimit=someLimit$1;exports.someSeries=someSeries$1;exports.sortBy=sortBy$1;exports.timeout=timeout;exports.times=times;exports.timesLimit=timesLimit;exports.timesSeries=timesSeries;exports.transform=transform;exports.tryEach=tryEach$1;exports.unmemoize=unmemoize;exports.until=until;exports.waterfall=waterfall$1;exports.whilst=whilst$1;exports.all=every$1;exports.allLimit=everyLimit$1;exports.allSeries=everySeries$1;exports.any=some$1;exports.anyLimit=someLimit$1;exports.anySeries=someSeries$1;exports.find=detect$1;exports.findLimit=detectLimit$1;exports.findSeries=detectSeries$1;exports.flatMap=concat$1;exports.flatMapLimit=concatLimit$1;exports.flatMapSeries=concatSeries$1;exports.forEach=each;exports.forEachSeries=eachSeries$1;exports.forEachLimit=eachLimit$2;exports.forEachOf=eachOf$1;exports.forEachOfSeries=eachOfSeries$1;exports.forEachOfLimit=eachOfLimit$2;exports.inject=reduce$1;exports.foldl=reduce$1;exports.foldr=reduceRight;exports.select=filter$1;exports.selectLimit=filterLimit$1;exports.selectSeries=filterSeries$1;exports.wrapSync=asyncify;exports.during=whilst$1;exports.doDuring=doWhilst$1;Object.defineProperty(exports,"__esModule",{value:true})}))},{}],3:[function(require,module,exports){module.exports=process.env.FLUENTFFMPEG_COV?require("./lib-cov/fluent-ffmpeg"):require("./lib/fluent-ffmpeg")},{"./lib-cov/fluent-ffmpeg":undefined,"./lib/fluent-ffmpeg":6}],4:[function(require,module,exports){"use strict";var fs=require("fs");var path=require("path");var async=require("async");var utils=require("./utils");var avCodecRegexp=/^\s*([D ])([E ])([VAS])([S ])([D ])([T ]) ([^ ]+) +(.*)$/;var ffCodecRegexp=/^\s*([D\.])([E\.])([VAS])([I\.])([L\.])([S\.]) ([^ ]+) +(.*)$/;var ffEncodersRegexp=/\(encoders:([^\)]+)\)/;var ffDecodersRegexp=/\(decoders:([^\)]+)\)/;var encodersRegexp=/^\s*([VAS\.])([F\.])([S\.])([X\.])([B\.])([D\.]) ([^ ]+) +(.*)$/;var formatRegexp=/^\s*([D ])([E ]) ([^ ]+) +(.*)$/;var lineBreakRegexp=/\r\n|\r|\n/;var filterRegexp=/^(?: [T\.][S\.][C\.] )?([^ ]+) +(AA?|VV?|\|)->(AA?|VV?|\|) +(.*)$/;var cache={};module.exports=function(proto){proto.setFfmpegPath=function(ffmpegPath){cache.ffmpegPath=ffmpegPath;return this};proto.setFfprobePath=function(ffprobePath){cache.ffprobePath=ffprobePath;return this};proto.setFlvtoolPath=function(flvtool){cache.flvtoolPath=flvtool;return this};proto._forgetPaths=function(){delete cache.ffmpegPath;delete cache.ffprobePath;delete cache.flvtoolPath};proto._getFfmpegPath=function(callback){if("ffmpegPath"in cache){return callback(null,cache.ffmpegPath)}async.waterfall([function(cb){if(process.env.FFMPEG_PATH){fs.exists(process.env.FFMPEG_PATH,(function(exists){if(exists){cb(null,process.env.FFMPEG_PATH)}else{cb(null,"")}}))}else{cb(null,"")}},function(ffmpeg,cb){if(ffmpeg.length){return cb(null,ffmpeg)}utils.which("ffmpeg",(function(err,ffmpeg){cb(err,ffmpeg)}))}],(function(err,ffmpeg){if(err){callback(err)}else{callback(null,cache.ffmpegPath=ffmpeg||"")}}))};proto._getFfprobePath=function(callback){var self=this;if("ffprobePath"in cache){return callback(null,cache.ffprobePath)}async.waterfall([function(cb){if(process.env.FFPROBE_PATH){fs.exists(process.env.FFPROBE_PATH,(function(exists){cb(null,exists?process.env.FFPROBE_PATH:"")}))}else{cb(null,"")}},function(ffprobe,cb){if(ffprobe.length){return cb(null,ffprobe)}utils.which("ffprobe",(function(err,ffprobe){cb(err,ffprobe)}))},function(ffprobe,cb){if(ffprobe.length){return cb(null,ffprobe)}self._getFfmpegPath((function(err,ffmpeg){if(err){cb(err)}else if(ffmpeg.length){var name=utils.isWindows?"ffprobe.exe":"ffprobe";var ffprobe=path.join(path.dirname(ffmpeg),name);fs.exists(ffprobe,(function(exists){cb(null,exists?ffprobe:"")}))}else{cb(null,"")}}))}],(function(err,ffprobe){if(err){callback(err)}else{callback(null,cache.ffprobePath=ffprobe||"")}}))};proto._getFlvtoolPath=function(callback){if("flvtoolPath"in cache){return callback(null,cache.flvtoolPath)}async.waterfall([function(cb){if(process.env.FLVMETA_PATH){fs.exists(process.env.FLVMETA_PATH,(function(exists){cb(null,exists?process.env.FLVMETA_PATH:"")}))}else{cb(null,"")}},function(flvtool,cb){if(flvtool.length){return cb(null,flvtool)}if(process.env.FLVTOOL2_PATH){fs.exists(process.env.FLVTOOL2_PATH,(function(exists){cb(null,exists?process.env.FLVTOOL2_PATH:"")}))}else{cb(null,"")}},function(flvtool,cb){if(flvtool.length){return cb(null,flvtool)}utils.which("flvmeta",(function(err,flvmeta){cb(err,flvmeta)}))},function(flvtool,cb){if(flvtool.length){return cb(null,flvtool)}utils.which("flvtool2",(function(err,flvtool2){cb(err,flvtool2)}))}],(function(err,flvtool){if(err){callback(err)}else{callback(null,cache.flvtoolPath=flvtool||"")}}))};proto.availableFilters=proto.getAvailableFilters=function(callback){if("filters"in cache){return callback(null,cache.filters)}this._spawnFfmpeg(["-filters"],{captureStdout:true,stdoutLines:0},(function(err,stdoutRing){if(err){return callback(err)}var stdout=stdoutRing.get();var lines=stdout.split("\n");var data={};var types={A:"audio",V:"video","|":"none"};lines.forEach((function(line){var match=line.match(filterRegexp);if(match){data[match[1]]={description:match[4],input:types[match[2].charAt(0)],multipleInputs:match[2].length>1,output:types[match[3].charAt(0)],multipleOutputs:match[3].length>1}}}));callback(null,cache.filters=data)}))};proto.availableCodecs=proto.getAvailableCodecs=function(callback){if("codecs"in cache){return callback(null,cache.codecs)}this._spawnFfmpeg(["-codecs"],{captureStdout:true,stdoutLines:0},(function(err,stdoutRing){if(err){return callback(err)}var stdout=stdoutRing.get();var lines=stdout.split(lineBreakRegexp);var data={};lines.forEach((function(line){var match=line.match(avCodecRegexp);if(match&&match[7]!=="="){data[match[7]]={type:{V:"video",A:"audio",S:"subtitle"}[match[3]],description:match[8],canDecode:match[1]==="D",canEncode:match[2]==="E",drawHorizBand:match[4]==="S",directRendering:match[5]==="D",weirdFrameTruncation:match[6]==="T"}}match=line.match(ffCodecRegexp);if(match&&match[7]!=="="){var codecData=data[match[7]]={type:{V:"video",A:"audio",S:"subtitle"}[match[3]],description:match[8],canDecode:match[1]==="D",canEncode:match[2]==="E",intraFrameOnly:match[4]==="I",isLossy:match[5]==="L",isLossless:match[6]==="S"};var encoders=codecData.description.match(ffEncodersRegexp);encoders=encoders?encoders[1].trim().split(" "):[];var decoders=codecData.description.match(ffDecodersRegexp);decoders=decoders?decoders[1].trim().split(" "):[];if(encoders.length||decoders.length){var coderData={};utils.copy(codecData,coderData);delete coderData.canEncode;delete coderData.canDecode;encoders.forEach((function(name){data[name]={};utils.copy(coderData,data[name]);data[name].canEncode=true}));decoders.forEach((function(name){if(name in data){data[name].canDecode=true}else{data[name]={};utils.copy(coderData,data[name]);data[name].canDecode=true}}))}}}));callback(null,cache.codecs=data)}))};proto.availableEncoders=proto.getAvailableEncoders=function(callback){if("encoders"in cache){return callback(null,cache.encoders)}this._spawnFfmpeg(["-encoders"],{captureStdout:true,stdoutLines:0},(function(err,stdoutRing){if(err){return callback(err)}var stdout=stdoutRing.get();var lines=stdout.split(lineBreakRegexp);var data={};lines.forEach((function(line){var match=line.match(encodersRegexp);if(match&&match[7]!=="="){data[match[7]]={type:{V:"video",A:"audio",S:"subtitle"}[match[1]],description:match[8],frameMT:match[2]==="F",sliceMT:match[3]==="S",experimental:match[4]==="X",drawHorizBand:match[5]==="B",directRendering:match[6]==="D"}}}));callback(null,cache.encoders=data)}))};proto.availableFormats=proto.getAvailableFormats=function(callback){if("formats"in cache){return callback(null,cache.formats)}this._spawnFfmpeg(["-formats"],{captureStdout:true,stdoutLines:0},(function(err,stdoutRing){if(err){return callback(err)}var stdout=stdoutRing.get();var lines=stdout.split(lineBreakRegexp);var data={};lines.forEach((function(line){var match=line.match(formatRegexp);if(match){match[3].split(",").forEach((function(format){if(!(format in data)){data[format]={description:match[4],canDemux:false,canMux:false}}if(match[1]==="D"){data[format].canDemux=true}if(match[2]==="E"){data[format].canMux=true}}))}}));callback(null,cache.formats=data)}))};proto._checkCapabilities=function(callback){var self=this;async.waterfall([function(cb){self.availableFormats(cb)},function(formats,cb){var unavailable;unavailable=self._outputs.reduce((function(fmts,output){var format=output.options.find("-f",1);if(format){if(!(format[0]in formats)||!formats[format[0]].canMux){fmts.push(format)}}return fmts}),[]);if(unavailable.length===1){return cb(new Error("Output format "+unavailable[0]+" is not available"))}else if(unavailable.length>1){return cb(new Error("Output formats "+unavailable.join(", ")+" are not available"))}unavailable=self._inputs.reduce((function(fmts,input){var format=input.options.find("-f",1);if(format){if(!(format[0]in formats)||!formats[format[0]].canDemux){fmts.push(format[0])}}return fmts}),[]);if(unavailable.length===1){return cb(new Error("Input format "+unavailable[0]+" is not available"))}else if(unavailable.length>1){return cb(new Error("Input formats "+unavailable.join(", ")+" are not available"))}cb()},function(cb){self.availableEncoders(cb)},function(encoders,cb){var unavailable;unavailable=self._outputs.reduce((function(cdcs,output){var acodec=output.audio.find("-acodec",1);if(acodec&&acodec[0]!=="copy"){if(!(acodec[0]in encoders)||encoders[acodec[0]].type!=="audio"){cdcs.push(acodec[0])}}return cdcs}),[]);if(unavailable.length===1){return cb(new Error("Audio codec "+unavailable[0]+" is not available"))}else if(unavailable.length>1){return cb(new Error("Audio codecs "+unavailable.join(", ")+" are not available"))}unavailable=self._outputs.reduce((function(cdcs,output){var vcodec=output.video.find("-vcodec",1);if(vcodec&&vcodec[0]!=="copy"){if(!(vcodec[0]in encoders)||encoders[vcodec[0]].type!=="video"){cdcs.push(vcodec[0])}}return cdcs}),[]);if(unavailable.length===1){return cb(new Error("Video codec "+unavailable[0]+" is not available"))}else if(unavailable.length>1){return cb(new Error("Video codecs "+unavailable.join(", ")+" are not available"))}cb()}],callback)}}},{"./utils":16,async:2,fs:undefined,path:undefined}],5:[function(require,module,exports){"use strict";var spawn=require("child_process").spawn;function legacyTag(key){return key.match(/^TAG:/)}function legacyDisposition(key){return key.match(/^DISPOSITION:/)}function parseFfprobeOutput(out){var lines=out.split(/\r\n|\r|\n/);lines=lines.filter((function(line){return line.length>0}));var data={streams:[],format:{},chapters:[]};function parseBlock(name){var data={};var line=lines.shift();while(typeof line!=="undefined"){if(line.toLowerCase()=="[/"+name+"]"){return data}else if(line.match(/^\[/)){line=lines.shift();continue}var kv=line.match(/^([^=]+)=(.*)$/);if(kv){if(!kv[1].match(/^TAG:/)&&kv[2].match(/^[0-9]+(\.[0-9]+)?$/)){data[kv[1]]=Number(kv[2])}else{data[kv[1]]=kv[2]}}line=lines.shift()}return data}var line=lines.shift();while(typeof line!=="undefined"){if(line.match(/^\[stream/i)){var stream=parseBlock("stream");data.streams.push(stream)}else if(line.match(/^\[chapter/i)){var chapter=parseBlock("chapter");data.chapters.push(chapter)}else if(line.toLowerCase()==="[format]"){data.format=parseBlock("format")}line=lines.shift()}return data}module.exports=function(proto){proto.ffprobe=function(){var input,index=null,options=[],callback;var callback=arguments[arguments.length-1];var ended=false;function handleCallback(err,data){if(!ended){ended=true;callback(err,data)}}switch(arguments.length){case 3:index=arguments[0];options=arguments[1];break;case 2:if(typeof arguments[0]==="number"){index=arguments[0]}else if(Array.isArray(arguments[0])){options=arguments[0]}break}if(index===null){if(!this._currentInput){return handleCallback(new Error("No input specified"))}input=this._currentInput}else{input=this._inputs[index];if(!input){return handleCallback(new Error("Invalid input index"))}}this._getFfprobePath((function(err,path){if(err){return handleCallback(err)}else if(!path){return handleCallback(new Error("Cannot find ffprobe"))}var stdout="";var stdoutClosed=false;var stderr="";var stderrClosed=false;var src=input.isStream?"pipe:0":input.source;var ffprobe=spawn(path,["-show_streams","-show_format"].concat(options,src));if(input.isStream){ffprobe.stdin.on("error",(function(err){if(["ECONNRESET","EPIPE"].indexOf(err.code)>=0){return}handleCallback(err)}));ffprobe.stdin.on("close",(function(){input.source.pause();input.source.unpipe(ffprobe.stdin)}));input.source.pipe(ffprobe.stdin)}ffprobe.on("error",callback);var exitError=null;function handleExit(err){if(err){exitError=err}if(processExited&&stdoutClosed&&stderrClosed){if(exitError){if(stderr){exitError.message+="\n"+stderr}return handleCallback(exitError)}var data=parseFfprobeOutput(stdout);[data.format].concat(data.streams).forEach((function(target){if(target){var legacyTagKeys=Object.keys(target).filter(legacyTag);if(legacyTagKeys.length){target.tags=target.tags||{};legacyTagKeys.forEach((function(tagKey){target.tags[tagKey.substr(4)]=target[tagKey];delete target[tagKey]}))}var legacyDispositionKeys=Object.keys(target).filter(legacyDisposition);if(legacyDispositionKeys.length){target.disposition=target.disposition||{};legacyDispositionKeys.forEach((function(dispositionKey){target.disposition[dispositionKey.substr(12)]=target[dispositionKey];delete target[dispositionKey]}))}}}));handleCallback(null,data)}}var processExited=false;ffprobe.on("exit",(function(code,signal){processExited=true;if(code){handleExit(new Error("ffprobe exited with code "+code))}else if(signal){handleExit(new Error("ffprobe was killed with signal "+signal))}else{handleExit()}}));ffprobe.stdout.on("data",(function(data){stdout+=data}));ffprobe.stdout.on("close",(function(){stdoutClosed=true;handleExit()}));ffprobe.stderr.on("data",(function(data){stderr+=data}));ffprobe.stderr.on("close",(function(){stderrClosed=true;handleExit()}))}))}}},{child_process:undefined}],6:[function(require,module,exports){(function(__dirname){(function(){"use strict";var path=require("path");var util=require("util");var EventEmitter=require("events").EventEmitter;var utils=require("./utils");var ARGLISTS=["_global","_audio","_audioFilters","_video","_videoFilters","_sizeFilters","_complexFilters"];function FfmpegCommand(input,options){if(!(this instanceof FfmpegCommand)){return new FfmpegCommand(input,options)}EventEmitter.call(this);if(typeof input==="object"&&!("readable"in input)){options=input}else{options=options||{};options.source=input}this._inputs=[];if(options.source){this.input(options.source)}this._outputs=[];this.output();var self=this;["_global","_complexFilters"].forEach((function(prop){self[prop]=utils.args()}));options.stdoutLines="stdoutLines"in options?options.stdoutLines:100;options.presets=options.presets||options.preset||path.join(__dirname,"presets");options.niceness=options.niceness||options.priority||0;this.options=options;this.logger=options.logger||{debug:function(){},info:function(){},warn:function(){},error:function(){}}}util.inherits(FfmpegCommand,EventEmitter);module.exports=FfmpegCommand;FfmpegCommand.prototype.clone=function(){var clone=new FfmpegCommand;var self=this;clone.options=this.options;clone.logger=this.logger;clone._inputs=this._inputs.map((function(input){return{source:input.source,options:input.options.clone()}}));if("target"in this._outputs[0]){clone._outputs=[];clone.output()}else{clone._outputs=[clone._currentOutput={flags:{}}];["audio","audioFilters","video","videoFilters","sizeFilters","options"].forEach((function(key){clone._currentOutput[key]=self._currentOutput[key].clone()}));if(this._currentOutput.sizeData){clone._currentOutput.sizeData={};utils.copy(this._currentOutput.sizeData,clone._currentOutput.sizeData)}utils.copy(this._currentOutput.flags,clone._currentOutput.flags)}["_global","_complexFilters"].forEach((function(prop){clone[prop]=self[prop].clone()}));return clone};require("./options/inputs")(FfmpegCommand.prototype);require("./options/audio")(FfmpegCommand.prototype);require("./options/video")(FfmpegCommand.prototype);require("./options/videosize")(FfmpegCommand.prototype);require("./options/output")(FfmpegCommand.prototype);require("./options/custom")(FfmpegCommand.prototype);require("./options/misc")(FfmpegCommand.prototype);require("./processor")(FfmpegCommand.prototype);require("./capabilities")(FfmpegCommand.prototype);FfmpegCommand.setFfmpegPath=function(path){(new FfmpegCommand).setFfmpegPath(path)};FfmpegCommand.setFfprobePath=function(path){(new FfmpegCommand).setFfprobePath(path)};FfmpegCommand.setFlvtoolPath=function(path){(new FfmpegCommand).setFlvtoolPath(path)};FfmpegCommand.availableFilters=FfmpegCommand.getAvailableFilters=function(callback){(new FfmpegCommand).availableFilters(callback)};FfmpegCommand.availableCodecs=FfmpegCommand.getAvailableCodecs=function(callback){(new FfmpegCommand).availableCodecs(callback)};FfmpegCommand.availableFormats=FfmpegCommand.getAvailableFormats=function(callback){(new FfmpegCommand).availableFormats(callback)};FfmpegCommand.availableEncoders=FfmpegCommand.getAvailableEncoders=function(callback){(new FfmpegCommand).availableEncoders(callback)};require("./ffprobe")(FfmpegCommand.prototype);FfmpegCommand.ffprobe=function(file){var instance=new FfmpegCommand(file);instance.ffprobe.apply(instance,Array.prototype.slice.call(arguments,1))};require("./recipes")(FfmpegCommand.prototype)}).call(this)}).call(this,require("path").join(__dirname,"node_modules","fluent-ffmpeg","lib"))},{"./capabilities":4,"./ffprobe":5,"./options/audio":7,"./options/custom":8,"./options/inputs":9,"./options/misc":10,"./options/output":11,"./options/video":12,"./options/videosize":13,"./processor":14,"./recipes":15,"./utils":16,events:undefined,path:undefined,util:undefined}],7:[function(require,module,exports){"use strict";var utils=require("../utils");module.exports=function(proto){proto.withNoAudio=proto.noAudio=function(){this._currentOutput.audio.clear();this._currentOutput.audioFilters.clear();this._currentOutput.audio("-an");return this};proto.withAudioCodec=proto.audioCodec=function(codec){this._currentOutput.audio("-acodec",codec);return this};proto.withAudioBitrate=proto.audioBitrate=function(bitrate){this._currentOutput.audio("-b:a",(""+bitrate).replace(/k?$/,"k"));return this};proto.withAudioChannels=proto.audioChannels=function(channels){this._currentOutput.audio("-ac",channels);return this};proto.withAudioFrequency=proto.audioFrequency=function(freq){this._currentOutput.audio("-ar",freq);return this};proto.withAudioQuality=proto.audioQuality=function(quality){this._currentOutput.audio("-aq",quality);return this};proto.withAudioFilter=proto.withAudioFilters=proto.audioFilter=proto.audioFilters=function(filters){if(arguments.length>1){filters=[].slice.call(arguments)}if(!Array.isArray(filters)){filters=[filters]}this._currentOutput.audioFilters(utils.makeFilterStrings(filters));return this}}},{"../utils":16}],8:[function(require,module,exports){"use strict";var utils=require("../utils");module.exports=function(proto){proto.addInputOption=proto.addInputOptions=proto.withInputOption=proto.withInputOptions=proto.inputOption=proto.inputOptions=function(options){if(!this._currentInput){throw new Error("No input specified")}var doSplit=true;if(arguments.length>1){options=[].slice.call(arguments);doSplit=false}if(!Array.isArray(options)){options=[options]}this._currentInput.options(options.reduce((function(options,option){var split=String(option).split(" ");if(doSplit&&split.length===2){options.push(split[0],split[1])}else{options.push(option)}return options}),[]));return this};proto.addOutputOption=proto.addOutputOptions=proto.addOption=proto.addOptions=proto.withOutputOption=proto.withOutputOptions=proto.withOption=proto.withOptions=proto.outputOption=proto.outputOptions=function(options){var doSplit=true;if(arguments.length>1){options=[].slice.call(arguments);doSplit=false}if(!Array.isArray(options)){options=[options]}this._currentOutput.options(options.reduce((function(options,option){var split=String(option).split(" ");if(doSplit&&split.length===2){options.push(split[0],split[1])}else{options.push(option)}return options}),[]));return this};proto.filterGraph=proto.complexFilter=function(spec,map){this._complexFilters.clear();if(!Array.isArray(spec)){spec=[spec]}this._complexFilters("-filter_complex",utils.makeFilterStrings(spec).join(";"));if(Array.isArray(map)){var self=this;map.forEach((function(streamSpec){self._complexFilters("-map",streamSpec.replace(utils.streamRegexp,"[$1]"))}))}else if(typeof map==="string"){this._complexFilters("-map",map.replace(utils.streamRegexp,"[$1]"))}return this}}},{"../utils":16}],9:[function(require,module,exports){"use strict";var utils=require("../utils");module.exports=function(proto){proto.mergeAdd=proto.addInput=proto.input=function(source){var isFile=false;var isStream=false;if(typeof source!=="string"){if(!("readable"in source)||!source.readable){throw new Error("Invalid input")}var hasInputStream=this._inputs.some((function(input){return input.isStream}));if(hasInputStream){throw new Error("Only one input stream is supported")}isStream=true;source.pause()}else{var protocol=source.match(/^([a-z]{2,}):/i);isFile=!protocol||protocol[0]==="file"}this._inputs.push(this._currentInput={source:source,isFile:isFile,isStream:isStream,options:utils.args()});return this};proto.withInputFormat=proto.inputFormat=proto.fromFormat=function(format){if(!this._currentInput){throw new Error("No input specified")}this._currentInput.options("-f",format);return this};proto.withInputFps=proto.withInputFPS=proto.withFpsInput=proto.withFPSInput=proto.inputFPS=proto.inputFps=proto.fpsInput=proto.FPSInput=function(fps){if(!this._currentInput){throw new Error("No input specified")}this._currentInput.options("-r",fps);return this};proto.nativeFramerate=proto.withNativeFramerate=proto.native=function(){if(!this._currentInput){throw new Error("No input specified")}this._currentInput.options("-re");return this};proto.setStartTime=proto.seekInput=function(seek){if(!this._currentInput){throw new Error("No input specified")}this._currentInput.options("-ss",seek);return this};proto.loop=function(duration){if(!this._currentInput){throw new Error("No input specified")}this._currentInput.options("-loop","1");if(typeof duration!=="undefined"){this.duration(duration)}return this}}},{"../utils":16}],10:[function(require,module,exports){"use strict";var path=require("path");module.exports=function(proto){proto.usingPreset=proto.preset=function(preset){if(typeof preset==="function"){preset(this)}else{try{var modulePath=path.join(this.options.presets,preset);var module=require(modulePath);if(typeof module.load==="function"){module.load(this)}else{throw new Error("preset "+modulePath+" has no load() function")}}catch(err){throw new Error("preset "+modulePath+" could not be loaded: "+err.message)}}return this}}},{path:undefined}],11:[function(require,module,exports){"use strict";var utils=require("../utils");module.exports=function(proto){proto.addOutput=proto.output=function(target,pipeopts){var isFile=false;if(!target&&this._currentOutput){throw new Error("Invalid output")}if(target&&typeof target!=="string"){if(!("writable"in target)||!target.writable){throw new Error("Invalid output")}}else if(typeof target==="string"){var protocol=target.match(/^([a-z]{2,}):/i);isFile=!protocol||protocol[0]==="file"}if(target&&!("target"in this._currentOutput)){this._currentOutput.target=target;this._currentOutput.isFile=isFile;this._currentOutput.pipeopts=pipeopts||{}}else{if(target&&typeof target!=="string"){var hasOutputStream=this._outputs.some((function(output){return typeof output.target!=="string"}));if(hasOutputStream){throw new Error("Only one output stream is supported")}}this._outputs.push(this._currentOutput={target:target,isFile:isFile,flags:{},pipeopts:pipeopts||{}});var self=this;["audio","audioFilters","video","videoFilters","sizeFilters","options"].forEach((function(key){self._currentOutput[key]=utils.args()}));if(!target){delete this._currentOutput.target}}return this};proto.seekOutput=proto.seek=function(seek){this._currentOutput.options("-ss",seek);return this};proto.withDuration=proto.setDuration=proto.duration=function(duration){this._currentOutput.options("-t",duration);return this};proto.toFormat=proto.withOutputFormat=proto.outputFormat=proto.format=function(format){this._currentOutput.options("-f",format);return this};proto.map=function(spec){this._currentOutput.options("-map",spec.replace(utils.streamRegexp,"[$1]"));return this};proto.updateFlvMetadata=proto.flvmeta=function(){this._currentOutput.flags.flvmeta=true;return this}}},{"../utils":16}],12:[function(require,module,exports){"use strict";var utils=require("../utils");module.exports=function(proto){proto.withNoVideo=proto.noVideo=function(){this._currentOutput.video.clear();this._currentOutput.videoFilters.clear();this._currentOutput.video("-vn");return this};proto.withVideoCodec=proto.videoCodec=function(codec){this._currentOutput.video("-vcodec",codec);return this};proto.withVideoBitrate=proto.videoBitrate=function(bitrate,constant){bitrate=(""+bitrate).replace(/k?$/,"k");this._currentOutput.video("-b:v",bitrate);if(constant){this._currentOutput.video("-maxrate",bitrate,"-minrate",bitrate,"-bufsize","3M")}return this};proto.withVideoFilter=proto.withVideoFilters=proto.videoFilter=proto.videoFilters=function(filters){if(arguments.length>1){filters=[].slice.call(arguments)}if(!Array.isArray(filters)){filters=[filters]}this._currentOutput.videoFilters(utils.makeFilterStrings(filters));return this};proto.withOutputFps=proto.withOutputFPS=proto.withFpsOutput=proto.withFPSOutput=proto.withFps=proto.withFPS=proto.outputFPS=proto.outputFps=proto.fpsOutput=proto.FPSOutput=proto.fps=proto.FPS=function(fps){this._currentOutput.video("-r",fps);return this};proto.takeFrames=proto.withFrames=proto.frames=function(frames){this._currentOutput.video("-vframes",frames);return this}}},{"../utils":16}],13:[function(require,module,exports){"use strict";function getScalePadFilters(width,height,aspect,color){return[{filter:"scale",options:{w:"if(gt(a,"+aspect+"),"+width+",trunc("+height+"*a/2)*2)",h:"if(lt(a,"+aspect+"),"+height+",trunc("+width+"/a/2)*2)"}},{filter:"pad",options:{w:width,h:height,x:"if(gt(a,"+aspect+"),0,("+width+"-iw)/2)",y:"if(lt(a,"+aspect+"),0,("+height+"-ih)/2)",color:color}}]}function createSizeFilters(output,key,value){var data=output.sizeData=output.sizeData||{};data[key]=value;if(!("size"in data)){return[]}var fixedSize=data.size.match(/([0-9]+)x([0-9]+)/);var fixedWidth=data.size.match(/([0-9]+)x\?/);var fixedHeight=data.size.match(/\?x([0-9]+)/);var percentRatio=data.size.match(/\b([0-9]{1,3})%/);var width,height,aspect;if(percentRatio){var ratio=Number(percentRatio[1])/100;return[{filter:"scale",options:{w:"trunc(iw*"+ratio+"/2)*2",h:"trunc(ih*"+ratio+"/2)*2"}}]}else if(fixedSize){width=Math.round(Number(fixedSize[1])/2)*2;height=Math.round(Number(fixedSize[2])/2)*2;aspect=width/height;if(data.pad){return getScalePadFilters(width,height,aspect,data.pad)}else{return[{filter:"scale",options:{w:width,h:height}}]}}else if(fixedWidth||fixedHeight){if("aspect"in data){width=fixedWidth?fixedWidth[1]:Math.round(Number(fixedHeight[1])*data.aspect);height=fixedHeight?fixedHeight[1]:Math.round(Number(fixedWidth[1])/data.aspect);width=Math.round(width/2)*2;height=Math.round(height/2)*2;if(data.pad){return getScalePadFilters(width,height,data.aspect,data.pad)}else{return[{filter:"scale",options:{w:width,h:height}}]}}else{if(fixedWidth){return[{filter:"scale",options:{w:Math.round(Number(fixedWidth[1])/2)*2,h:"trunc(ow/a/2)*2"}}]}else{return[{filter:"scale",options:{w:"trunc(oh*a/2)*2",h:Math.round(Number(fixedHeight[1])/2)*2}}]}}}else{throw new Error("Invalid size specified: "+data.size)}}module.exports=function(proto){proto.keepPixelAspect=proto.keepDisplayAspect=proto.keepDisplayAspectRatio=proto.keepDAR=function(){return this.videoFilters([{filter:"scale",options:{w:"if(gt(sar,1),iw*sar,iw)",h:"if(lt(sar,1),ih/sar,ih)"}},{filter:"setsar",options:"1"}])};proto.withSize=proto.setSize=proto.size=function(size){var filters=createSizeFilters(this._currentOutput,"size",size);this._currentOutput.sizeFilters.clear();this._currentOutput.sizeFilters(filters);return this};proto.withAspect=proto.withAspectRatio=proto.setAspect=proto.setAspectRatio=proto.aspect=proto.aspectRatio=function(aspect){var a=Number(aspect);if(isNaN(a)){var match=aspect.match(/^(\d+):(\d+)$/);if(match){a=Number(match[1])/Number(match[2])}else{throw new Error("Invalid aspect ratio: "+aspect)}}var filters=createSizeFilters(this._currentOutput,"aspect",a);this._currentOutput.sizeFilters.clear();this._currentOutput.sizeFilters(filters);return this};proto.applyAutopadding=proto.applyAutoPadding=proto.applyAutopad=proto.applyAutoPad=proto.withAutopadding=proto.withAutoPadding=proto.withAutopad=proto.withAutoPad=proto.autoPad=proto.autopad=function(pad,color){if(typeof pad==="string"){color=pad;pad=true}if(typeof pad==="undefined"){pad=true}var filters=createSizeFilters(this._currentOutput,"pad",pad?color||"black":false);this._currentOutput.sizeFilters.clear();this._currentOutput.sizeFilters(filters);return this}}},{}],14:[function(require,module,exports){"use strict";var spawn=require("child_process").spawn;var path=require("path");var fs=require("fs");var async=require("async");var utils=require("./utils");var nlRegexp=/\r\n|\r|\n/g;function runFfprobe(command){const inputProbeIndex=0;if(command._inputs[inputProbeIndex].isStream){return}command.ffprobe(inputProbeIndex,(function(err,data){command._ffprobeData=data}))}module.exports=function(proto){proto._spawnFfmpeg=function(args,options,processCB,endCB){if(typeof options==="function"){endCB=processCB;processCB=options;options={}}if(typeof endCB==="undefined"){endCB=processCB;processCB=function(){}}var maxLines="stdoutLines"in options?options.stdoutLines:this.options.stdoutLines;this._getFfmpegPath((function(err,command){if(err){return endCB(err)}else if(!command||command.length===0){return endCB(new Error("Cannot find ffmpeg"))}if(options.niceness&&options.niceness!==0&&!utils.isWindows){args.unshift("-n",options.niceness,command);command="nice"}var stdoutRing=utils.linesRing(maxLines);var stdoutClosed=false;var stderrRing=utils.linesRing(maxLines);var stderrClosed=false;var ffmpegProc=spawn(command,args,options);if(ffmpegProc.stderr){ffmpegProc.stderr.setEncoding("utf8")}ffmpegProc.on("error",(function(err){endCB(err)}));var exitError=null;function handleExit(err){if(err){exitError=err}if(processExited&&(stdoutClosed||!options.captureStdout)&&stderrClosed){endCB(exitError,stdoutRing,stderrRing)}}var processExited=false;ffmpegProc.on("exit",(function(code,signal){processExited=true;if(signal){handleExit(new Error("ffmpeg was killed with signal "+signal))}else if(code){handleExit(new Error("ffmpeg exited with code "+code))}else{handleExit()}}));if(options.captureStdout){ffmpegProc.stdout.on("data",(function(data){stdoutRing.append(data)}));ffmpegProc.stdout.on("close",(function(){stdoutRing.close();stdoutClosed=true;handleExit()}))}ffmpegProc.stderr.on("data",(function(data){stderrRing.append(data)}));ffmpegProc.stderr.on("close",(function(){stderrRing.close();stderrClosed=true;handleExit()}));processCB(ffmpegProc,stdoutRing,stderrRing)}))};proto._getArguments=function(){var complexFilters=this._complexFilters.get();var fileOutput=this._outputs.some((function(output){return output.isFile}));return[].concat(this._inputs.reduce((function(args,input){var source=typeof input.source==="string"?input.source:"pipe:0";return args.concat(input.options.get(),["-i",source])}),[]),this._global.get(),fileOutput?["-y"]:[],complexFilters,this._outputs.reduce((function(args,output){var sizeFilters=utils.makeFilterStrings(output.sizeFilters.get());var audioFilters=output.audioFilters.get();var videoFilters=output.videoFilters.get().concat(sizeFilters);var outputArg;if(!output.target){outputArg=[]}else if(typeof output.target==="string"){outputArg=[output.target]}else{outputArg=["pipe:1"]}return args.concat(output.audio.get(),audioFilters.length?["-filter:a",audioFilters.join(",")]:[],output.video.get(),videoFilters.length?["-filter:v",videoFilters.join(",")]:[],output.options.get(),outputArg)}),[]))};proto._prepare=function(callback,readMetadata){var self=this;async.waterfall([function(cb){self._checkCapabilities(cb)},function(cb){if(!readMetadata){return cb()}self.ffprobe(0,(function(err,data){if(!err){self._ffprobeData=data}cb()}))},function(cb){var flvmeta=self._outputs.some((function(output){if(output.flags.flvmeta&&!output.isFile){self.logger.warn("Updating flv metadata is only supported for files");output.flags.flvmeta=false}return output.flags.flvmeta}));if(flvmeta){self._getFlvtoolPath((function(err){cb(err)}))}else{cb()}},function(cb){var args;try{args=self._getArguments()}catch(e){return cb(e)}cb(null,args)},function(args,cb){self.availableEncoders((function(err,encoders){for(var i=0;i<args.length;i++){if(args[i]==="-acodec"||args[i]==="-vcodec"){i++;if(args[i]in encoders&&encoders[args[i]].experimental){args.splice(i+1,0,"-strict","experimental");i+=2}}}cb(null,args)}))}],callback);if(!readMetadata){if(this.listeners("progress").length>0){runFfprobe(this)}else{this.once("newListener",(function(event){if(event==="progress"){runFfprobe(this)}}))}}};proto.exec=proto.execute=proto.run=function(){var self=this;var outputPresent=this._outputs.some((function(output){return"target"in output}));if(!outputPresent){throw new Error("No output specified")}var outputStream=this._outputs.filter((function(output){return typeof output.target!=="string"}))[0];var inputStream=this._inputs.filter((function(input){return typeof input.source!=="string"}))[0];var ended=false;function emitEnd(err,stdout,stderr){if(!ended){ended=true;if(err){self.emit("error",err,stdout,stderr)}else{self.emit("end",stdout,stderr)}}}self._prepare((function(err,args){if(err){return emitEnd(err)}self._spawnFfmpeg(args,{captureStdout:!outputStream,niceness:self.options.niceness,cwd:self.options.cwd},(function processCB(ffmpegProc,stdoutRing,stderrRing){self.ffmpegProc=ffmpegProc;self.emit("start","ffmpeg "+args.join(" "));if(inputStream){inputStream.source.on("error",(function(err){var reportingErr=new Error("Input stream error: "+err.message);reportingErr.inputStreamError=err;emitEnd(reportingErr);ffmpegProc.kill()}));inputStream.source.resume();inputStream.source.pipe(ffmpegProc.stdin);ffmpegProc.stdin.on("error",(function(){}))}var processTimer;if(self.options.timeout){processTimer=setTimeout((function(){var msg="process ran into a timeout ("+self.options.timeout+"s)";emitEnd(new Error(msg),stdoutRing.get(),stderrRing.get());ffmpegProc.kill()}),self.options.timeout*1e3)}if(outputStream){ffmpegProc.stdout.pipe(outputStream.target,outputStream.pipeopts);outputStream.target.on("close",(function(){self.logger.debug("Output stream closed, scheduling kill for ffmpeg process");setTimeout((function(){emitEnd(new Error("Output stream closed"));ffmpegProc.kill()}),20)}));outputStream.target.on("error",(function(err){self.logger.debug("Output stream error, killing ffmpeg process");var reportingErr=new Error("Output stream error: "+err.message);reportingErr.outputStreamError=err;emitEnd(reportingErr,stdoutRing.get(),stderrRing.get());ffmpegProc.kill("SIGKILL")}))}if(stderrRing){if(self.listeners("stderr").length){stderrRing.callback((function(line){self.emit("stderr",line)}))}if(self.listeners("codecData").length){var codecDataSent=false;var codecObject={};stderrRing.callback((function(line){if(!codecDataSent)codecDataSent=utils.extractCodecData(self,line,codecObject)}))}if(self.listeners("progress").length){stderrRing.callback((function(line){utils.extractProgress(self,line)}))}}}),(function endCB(err,stdoutRing,stderrRing){delete self.ffmpegProc;if(err){if(err.message.match(/ffmpeg exited with code/)){err.message+=": "+utils.extractError(stderrRing.get())}emitEnd(err,stdoutRing.get(),stderrRing.get())}else{var flvmeta=self._outputs.filter((function(output){return output.flags.flvmeta}));if(flvmeta.length){self._getFlvtoolPath((function(err,flvtool){if(err){return emitEnd(err)}async.each(flvmeta,(function(output,cb){spawn(flvtool,["-U",output.target]).on("error",(function(err){cb(new Error("Error running "+flvtool+" on "+output.target+": "+err.message))})).on("exit",(function(code,signal){if(code!==0||signal){cb(new Error(flvtool+" "+(signal?"received signal "+signal:"exited with code "+code))+" when running on "+output.target)}else{cb()}}))}),(function(err){if(err){emitEnd(err)}else{emitEnd(null,stdoutRing.get(),stderrRing.get())}}))}))}else{emitEnd(null,stdoutRing.get(),stderrRing.get())}}}))}))};proto.renice=function(niceness){if(!utils.isWindows){niceness=niceness||0;if(niceness<-20||niceness>20){this.logger.warn("Invalid niceness value: "+niceness+", must be between -20 and 20")}niceness=Math.min(20,Math.max(-20,niceness));this.options.niceness=niceness;if(this.ffmpegProc){var logger=this.logger;var pid=this.ffmpegProc.pid;var renice=spawn("renice",[niceness,"-p",pid]);renice.on("error",(function(err){logger.warn("could not renice process "+pid+": "+err.message)}));renice.on("exit",(function(code,signal){if(signal){logger.warn("could not renice process "+pid+": renice was killed by signal "+signal)}else if(code){logger.warn("could not renice process "+pid+": renice exited with "+code)}else{logger.info("successfully reniced process "+pid+" to "+niceness+" niceness")}}))}}return this};proto.kill=function(signal){if(!this.ffmpegProc){this.logger.warn("No running ffmpeg process, cannot send signal")}else{this.ffmpegProc.kill(signal||"SIGKILL")}return this}}},{"./utils":16,async:2,child_process:undefined,fs:undefined,path:undefined}],15:[function(require,module,exports){"use strict";var fs=require("fs");var path=require("path");var PassThrough=require("stream").PassThrough;var async=require("async");var utils=require("./utils");module.exports=function recipes(proto){proto.saveToFile=proto.save=function(output){this.output(output).run();return this};proto.writeToStream=proto.pipe=proto.stream=function(stream,options){if(stream&&!("writable"in stream)){options=stream;stream=undefined}if(!stream){if(process.version.match(/v0\.8\./)){throw new Error("PassThrough stream is not supported on node v0.8")}stream=new PassThrough}this.output(stream,options).run();return stream};proto.takeScreenshots=proto.thumbnail=proto.thumbnails=proto.screenshot=proto.screenshots=function(config,folder){var self=this;var source=this._currentInput.source;config=config||{count:1};if(typeof config==="number"){config={count:config}}if(!("folder"in config)){config.folder=folder||"."}if("timestamps"in config){config.timemarks=config.timestamps}if(!("timemarks"in config)){if(!config.count){throw new Error("Cannot take screenshots: neither a count nor a timemark list are specified")}var interval=100/(1+config.count);config.timemarks=[];for(var i=0;i<config.count;i++){config.timemarks.push(interval*(i+1)+"%")}}if("size"in config){var fixedSize=config.size.match(/^(\d+)x(\d+)$/);var fixedWidth=config.size.match(/^(\d+)x\?$/);var fixedHeight=config.size.match(/^\?x(\d+)$/);var percentSize=config.size.match(/^(\d+)%$/);if(!fixedSize&&!fixedWidth&&!fixedHeight&&!percentSize){throw new Error("Invalid size parameter: "+config.size)}}var metadata;function getMetadata(cb){if(metadata){cb(null,metadata)}else{self.ffprobe((function(err,meta){metadata=meta;cb(err,meta)}))}}async.waterfall([function computeTimemarks(next){if(config.timemarks.some((function(t){return(""+t).match(/^[\d.]+%$/)}))){if(typeof source!=="string"){return next(new Error("Cannot compute screenshot timemarks with an input stream, please specify fixed timemarks"))}getMetadata((function(err,meta){if(err){next(err)}else{var vstream=meta.streams.reduce((function(biggest,stream){if(stream.codec_type==="video"&&stream.width*stream.height>biggest.width*biggest.height){return stream}else{return biggest}}),{width:0,height:0});if(vstream.width===0){return next(new Error("No video stream in input, cannot take screenshots"))}var duration=Number(vstream.duration);if(isNaN(duration)){duration=Number(meta.format.duration)}if(isNaN(duration)){return next(new Error("Could not get input duration, please specify fixed timemarks"))}config.timemarks=config.timemarks.map((function(mark){if((""+mark).match(/^([\d.]+)%$/)){return duration*parseFloat(mark)/100}else{return mark}}));next()}}))}else{next()}},function normalizeTimemarks(next){config.timemarks=config.timemarks.map((function(mark){return utils.timemarkToSeconds(mark)})).sort((function(a,b){return a-b}));next()},function fixPattern(next){var pattern=config.filename||"tn.png";if(pattern.indexOf(".")===-1){pattern+=".png"}if(config.timemarks.length>1&&!pattern.match(/%(s|0*i)/)){var ext=path.extname(pattern);pattern=path.join(path.dirname(pattern),path.basename(pattern,ext)+"_%i"+ext)}next(null,pattern)},function replaceFilenameTokens(pattern,next){if(pattern.match(/%[bf]/)){if(typeof source!=="string"){return next(new Error("Cannot replace %f or %b when using an input stream"))}pattern=pattern.replace(/%f/g,path.basename(source)).replace(/%b/g,path.basename(source,path.extname(source)))}next(null,pattern)},function getSize(pattern,next){if(pattern.match(/%[whr]/)){if(fixedSize){return next(null,pattern,fixedSize[1],fixedSize[2])}getMetadata((function(err,meta){if(err){return next(new Error("Could not determine video resolution to replace %w, %h or %r"))}var vstream=meta.streams.reduce((function(biggest,stream){if(stream.codec_type==="video"&&stream.width*stream.height>biggest.width*biggest.height){return stream}else{return biggest}}),{width:0,height:0});if(vstream.width===0){return next(new Error("No video stream in input, cannot replace %w, %h or %r"))}var width=vstream.width;var height=vstream.height;if(fixedWidth){height=height*Number(fixedWidth[1])/width;width=Number(fixedWidth[1])}else if(fixedHeight){width=width*Number(fixedHeight[1])/height;height=Number(fixedHeight[1])}else if(percentSize){width=width*Number(percentSize[1])/100;height=height*Number(percentSize[1])/100}next(null,pattern,Math.round(width/2)*2,Math.round(height/2)*2)}))}else{next(null,pattern,-1,-1)}},function replaceSizeTokens(pattern,width,height,next){pattern=pattern.replace(/%r/g,"%wx%h").replace(/%w/g,width).replace(/%h/g,height);next(null,pattern)},function replaceVariableTokens(pattern,next){var filenames=config.timemarks.map((function(t,i){return pattern.replace(/%s/g,utils.timemarkToSeconds(t)).replace(/%(0*)i/g,(function(match,padding){var idx=""+(i+1);return padding.substr(0,Math.max(0,padding.length+1-idx.length))+idx}))}));self.emit("filenames",filenames);next(null,filenames)},function createDirectory(filenames,next){fs.exists(config.folder,(function(exists){if(!exists){fs.mkdir(config.folder,(function(err){if(err){next(err)}else{next(null,filenames)}}))}else{next(null,filenames)}}))}],(function runCommand(err,filenames){if(err){return self.emit("error",err)}var count=config.timemarks.length;var split;var filters=[split={filter:"split",options:count,outputs:[]}];if("size"in config){self.size(config.size);var sizeFilters=self._currentOutput.sizeFilters.get().map((function(f,i){if(i>0){f.inputs="size"+(i-1)}f.outputs="size"+i;return f}));split.inputs="size"+(sizeFilters.length-1);filters=sizeFilters.concat(filters);self._currentOutput.sizeFilters.clear()}var first=0;for(var i=0;i<count;i++){var stream="screen"+i;split.outputs.push(stream);if(i===0){first=config.timemarks[i];self.seekInput(first)}self.output(path.join(config.folder,filenames[i])).frames(1).map(stream);if(i>0){self.seek(config.timemarks[i]-first)}}self.complexFilter(filters);self.run()}));return this};proto.mergeToFile=proto.concatenate=proto.concat=function(target,options){var fileInput=this._inputs.filter((function(input){return!input.isStream}))[0];var self=this;this.ffprobe(this._inputs.indexOf(fileInput),(function(err,data){if(err){return self.emit("error",err)}var hasAudioStreams=data.streams.some((function(stream){return stream.codec_type==="audio"}));var hasVideoStreams=data.streams.some((function(stream){return stream.codec_type==="video"}));self.output(target,options).complexFilter({filter:"concat",options:{n:self._inputs.length,v:hasVideoStreams?1:0,a:hasAudioStreams?1:0}}).run()}));return this}}},{"./utils":16,async:2,fs:undefined,path:undefined,stream:undefined}],16:[function(require,module,exports){"use strict";var exec=require("child_process").exec;var isWindows=require("os").platform().match(/win(32|64)/);var which=require("which");var nlRegexp=/\r\n|\r|\n/g;var streamRegexp=/^\[?(.*?)\]?$/;var filterEscapeRegexp=/[,]/;var whichCache={};function parseProgressLine(line){var progress={};line=line.replace(/=\s+/g,"=").trim();var progressParts=line.split(" ");for(var i=0;i<progressParts.length;i++){var progressSplit=progressParts[i].split("=",2);var key=progressSplit[0];var value=progressSplit[1];if(typeof value==="undefined")return null;progress[key]=value}return progress}var utils=module.exports={isWindows:isWindows,streamRegexp:streamRegexp,copy:function(source,dest){Object.keys(source).forEach((function(key){dest[key]=source[key]}))},args:function(){var list=[];var argfunc=function(){if(arguments.length===1&&Array.isArray(arguments[0])){list=list.concat(arguments[0])}else{list=list.concat([].slice.call(arguments))}};argfunc.clear=function(){list=[]};argfunc.get=function(){return list};argfunc.find=function(arg,count){var index=list.indexOf(arg);if(index!==-1){return list.slice(index+1,index+1+(count||0))}};argfunc.remove=function(arg,count){var index=list.indexOf(arg);if(index!==-1){list.splice(index,(count||0)+1)}};argfunc.clone=function(){var cloned=utils.args();cloned(list);return cloned};return argfunc},makeFilterStrings:function(filters){return filters.map((function(filterSpec){if(typeof filterSpec==="string"){return filterSpec}var filterString="";if(Array.isArray(filterSpec.inputs)){filterString+=filterSpec.inputs.map((function(streamSpec){return streamSpec.replace(streamRegexp,"[$1]")})).join("")}else if(typeof filterSpec.inputs==="string"){filterString+=filterSpec.inputs.replace(streamRegexp,"[$1]")}filterString+=filterSpec.filter;if(filterSpec.options){if(typeof filterSpec.options==="string"||typeof filterSpec.options==="number"){filterString+="="+filterSpec.options}else if(Array.isArray(filterSpec.options)){filterString+="="+filterSpec.options.map((function(option){if(typeof option==="string"&&option.match(filterEscapeRegexp)){return"'"+option+"'"}else{return option}})).join(":")}else if(Object.keys(filterSpec.options).length){filterString+="="+Object.keys(filterSpec.options).map((function(option){var value=filterSpec.options[option];if(typeof value==="string"&&value.match(filterEscapeRegexp)){value="'"+value+"'"}return option+"="+value})).join(":")}}if(Array.isArray(filterSpec.outputs)){filterString+=filterSpec.outputs.map((function(streamSpec){return streamSpec.replace(streamRegexp,"[$1]")})).join("")}else if(typeof filterSpec.outputs==="string"){filterString+=filterSpec.outputs.replace(streamRegexp,"[$1]")}return filterString}))},which:function(name,callback){if(name in whichCache){return callback(null,whichCache[name])}which(name,(function(err,result){if(err){return callback(null,whichCache[name]="")}callback(null,whichCache[name]=result)}))},timemarkToSeconds:function(timemark){if(typeof timemark==="number"){return timemark}if(timemark.indexOf(":")===-1&&timemark.indexOf(".")>=0){return Number(timemark)}var parts=timemark.split(":");var secs=Number(parts.pop());if(parts.length){secs+=Number(parts.pop())*60}if(parts.length){secs+=Number(parts.pop())*3600}return secs},extractCodecData:function(command,stderrLine,codecsObject){var inputPattern=/Input #[0-9]+, ([^ ]+),/;var durPattern=/Duration\: ([^,]+)/;var audioPattern=/Audio\: (.*)/;var videoPattern=/Video\: (.*)/;if(!("inputStack"in codecsObject)){codecsObject.inputStack=[];codecsObject.inputIndex=-1;codecsObject.inInput=false}var inputStack=codecsObject.inputStack;var inputIndex=codecsObject.inputIndex;var inInput=codecsObject.inInput;var format,dur,audio,video;if(format=stderrLine.match(inputPattern)){inInput=codecsObject.inInput=true;inputIndex=codecsObject.inputIndex=codecsObject.inputIndex+1;inputStack[inputIndex]={format:format[1],audio:"",video:"",duration:""}}else if(inInput&&(dur=stderrLine.match(durPattern))){inputStack[inputIndex].duration=dur[1]}else if(inInput&&(audio=stderrLine.match(audioPattern))){audio=audio[1].split(", ");inputStack[inputIndex].audio=audio[0];inputStack[inputIndex].audio_details=audio}else if(inInput&&(video=stderrLine.match(videoPattern))){video=video[1].split(", ");inputStack[inputIndex].video=video[0];inputStack[inputIndex].video_details=video}else if(/Output #\d+/.test(stderrLine)){inInput=codecsObject.inInput=false}else if(/Stream mapping:|Press (\[q\]|ctrl-c) to stop/.test(stderrLine)){command.emit.apply(command,["codecData"].concat(inputStack));return true}return false},extractProgress:function(command,stderrLine){var progress=parseProgressLine(stderrLine);if(progress){var ret={frames:parseInt(progress.frame,10),currentFps:parseInt(progress.fps,10),currentKbps:progress.bitrate?parseFloat(progress.bitrate.replace("kbits/s","")):0,targetSize:parseInt(progress.size||progress.Lsize,10),timemark:progress.time};if(command._ffprobeData&&command._ffprobeData.format&&command._ffprobeData.format.duration){var duration=Number(command._ffprobeData.format.duration);if(!isNaN(duration))ret.percent=utils.timemarkToSeconds(ret.timemark)/duration*100}command.emit("progress",ret)}},extractError:function(stderr){return stderr.split(nlRegexp).reduce((function(messages,message){if(message.charAt(0)===" "||message.charAt(0)==="["){return[]}else{messages.push(message);return messages}}),[]).join("\n")},linesRing:function(maxLines){var cbs=[];var lines=[];var current=null;var closed=false;var max=maxLines-1;function emit(line){cbs.forEach((function(cb){cb(line)}))}return{callback:function(cb){lines.forEach((function(l){cb(l)}));cbs.push(cb)},append:function(str){if(closed)return;if(str instanceof Buffer)str=""+str;if(!str||str.length===0)return;var newLines=str.split(nlRegexp);if(newLines.length===1){if(current!==null){current=current+newLines.shift()}else{current=newLines.shift()}}else{if(current!==null){current=current+newLines.shift();emit(current);lines.push(current)}current=newLines.pop();newLines.forEach((function(l){emit(l);lines.push(l)}));if(max>-1&&lines.length>max){lines.splice(0,lines.length-max)}}},get:function(){if(current!==null){return lines.concat([current]).join("\n")}else{return lines.join("\n")}},close:function(){if(closed)return;if(current!==null){emit(current);lines.push(current);if(max>-1&&lines.length>max){lines.shift()}current=null}closed=true}}}}},{child_process:undefined,os:undefined,which:30}],17:[function(require,module,exports){var fs=require("fs");var core;if(process.platform==="win32"||global.TESTING_WINDOWS){core=require("./windows.js")}else{core=require("./mode.js")}module.exports=isexe;isexe.sync=sync;function isexe(path,options,cb){if(typeof options==="function"){cb=options;options={}}if(!cb){if(typeof Promise!=="function"){throw new TypeError("callback not provided")}return new Promise((function(resolve,reject){isexe(path,options||{},(function(er,is){if(er){reject(er)}else{resolve(is)}}))}))}core(path,options||{},(function(er,is){if(er){if(er.code==="EACCES"||options&&options.ignoreErrors){er=null;is=false}}cb(er,is)}))}function sync(path,options){try{return core.sync(path,options||{})}catch(er){if(options&&options.ignoreErrors||er.code==="EACCES"){return false}else{throw er}}}},{"./mode.js":18,"./windows.js":19,fs:undefined}],18:[function(require,module,exports){module.exports=isexe;isexe.sync=sync;var fs=require("fs");function isexe(path,options,cb){fs.stat(path,(function(er,stat){cb(er,er?false:checkStat(stat,options))}))}function sync(path,options){return checkStat(fs.statSync(path),options)}function checkStat(stat,options){return stat.isFile()&&checkMode(stat,options)}function checkMode(stat,options){var mod=stat.mode;var uid=stat.uid;var gid=stat.gid;var myUid=options.uid!==undefined?options.uid:process.getuid&&process.getuid();var myGid=options.gid!==undefined?options.gid:process.getgid&&process.getgid();var u=parseInt("100",8);var g=parseInt("010",8);var o=parseInt("001",8);var ug=u|g;var ret=mod&o||mod&g&&gid===myGid||mod&u&&uid===myUid||mod&ug&&myUid===0;return ret}},{fs:undefined}],19:[function(require,module,exports){module.exports=isexe;isexe.sync=sync;var fs=require("fs");function checkPathExt(path,options){var pathext=options.pathExt!==undefined?options.pathExt:process.env.PATHEXT;if(!pathext){return true}pathext=pathext.split(";");if(pathext.indexOf("")!==-1){return true}for(var i=0;i<pathext.length;i++){var p=pathext[i].toLowerCase();if(p&&path.substr(-p.length).toLowerCase()===p){return true}}return false}function checkStat(stat,path,options){if(!stat.isSymbolicLink()&&!stat.isFile()){return false}return checkPathExt(path,options)}function isexe(path,options,cb){fs.stat(path,(function(er,stat){cb(er,er?false:checkStat(stat,path,options))}))}function sync(path,options){return checkStat(fs.statSync(path),path,options)}},{fs:undefined}],20:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const stream_1=require("stream");const sax_1=__importDefault(require("sax"));const parse_time_1=require("./parse-time");class DashMPDParser extends stream_1.Writable{constructor(targetID){super();this._parser=sax_1.default.createStream(false,{lowercase:true});this._parser.on("error",this.destroy.bind(this));let lastTag;let currtime=0;let seq=0;let segmentTemplate;let timescale,offset,duration,baseURL;let timeline=[];let getSegments=false;let gotSegments=false;let isStatic;let treeLevel;let periodStart;const tmpl=str=>{const context={RepresentationID:targetID,Number:seq,Time:currtime};return str.replace(/\$(\w+)\$/g,((m,p1)=>`${context[p1]}`))};this._parser.on("opentag",(node=>{switch(node.name){case"mpd":currtime=node.attributes.availabilitystarttime?new Date(node.attributes.availabilitystarttime).getTime():0;isStatic=node.attributes.type!=="dynamic";break;case"period":seq=0;timescale=1e3;duration=0;offset=0;baseURL=[];treeLevel=0;periodStart=parse_time_1.durationStr(node.attributes.start)||0;break;case"segmentlist":seq=parseInt(node.attributes.startnumber)||seq;timescale=parseInt(node.attributes.timescale)||timescale;duration=parseInt(node.attributes.duration)||duration;offset=parseInt(node.attributes.presentationtimeoffset)||offset;break;case"segmenttemplate":segmentTemplate=node.attributes;seq=parseInt(node.attributes.startnumber)||seq;timescale=parseInt(node.attributes.timescale)||timescale;break;case"segmenttimeline":case"baseurl":lastTag=node.name;break;case"s":timeline.push({duration:parseInt(node.attributes.d),repeat:parseInt(node.attributes.r),time:parseInt(node.attributes.t)});break;case"adaptationset":case"representation":treeLevel++;if(!targetID){targetID=node.attributes.id}getSegments=node.attributes.id===`${targetID}`;if(getSegments){if(periodStart){currtime+=periodStart}if(offset){currtime-=offset/timescale*1e3}this.emit("starttime",currtime)}break;case"initialization":if(getSegments){this.emit("item",{url:baseURL.filter((s=>!!s)).join("")+node.attributes.sourceurl,seq:seq,init:true,duration:0})}break;case"segmenturl":if(getSegments){gotSegments=true;let tl=timeline.shift();let segmentDuration=((tl===null||tl===void 0?void 0:tl.duration)||duration)/timescale*1e3;this.emit("item",{url:baseURL.filter((s=>!!s)).join("")+node.attributes.media,seq:seq++,duration:segmentDuration});currtime+=segmentDuration}break}}));const onEnd=()=>{if(isStatic){this.emit("endlist")}if(!getSegments){this.destroy(Error(`Representation '${targetID}' not found`))}else{this.emit("end")}};this._parser.on("closetag",(tagName=>{switch(tagName){case"adaptationset":case"representation":treeLevel--;if(segmentTemplate&&timeline.length){gotSegments=true;if(segmentTemplate.initialization){this.emit("item",{url:baseURL.filter((s=>!!s)).join("")+tmpl(segmentTemplate.initialization),seq:seq,init:true,duration:0})}for(let{duration:itemDuration,repeat:repeat,time:time}of timeline){itemDuration=itemDuration/timescale*1e3;repeat=repeat||1;currtime=time||currtime;for(let i=0;i<repeat;i++){this.emit("item",{url:baseURL.filter((s=>!!s)).join("")+tmpl(segmentTemplate.media),seq:seq++,duration:itemDuration});currtime+=itemDuration}}}if(gotSegments){this.emit("endearly");onEnd();this._parser.removeAllListeners();this.removeAllListeners("finish")}break}}));this._parser.on("text",(text=>{if(lastTag==="baseurl"){baseURL[treeLevel]=text;lastTag=null}}));this.on("finish",onEnd)}_write(chunk,encoding,callback){this._parser.write(chunk);callback()}}exports.default=DashMPDParser},{"./parse-time":23,sax:27,stream:undefined}],21:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};const stream_1=require("stream");const miniget_1=__importDefault(require("miniget"));const m3u8_parser_1=__importDefault(require("./m3u8-parser"));const dash_mpd_parser_1=__importDefault(require("./dash-mpd-parser"));const queue_1=require("./queue");const parse_time_1=require("./parse-time");const supportedParsers={m3u8:m3u8_parser_1.default,"dash-mpd":dash_mpd_parser_1.default};let m3u8stream=(playlistURL,options={})=>{const stream=new stream_1.PassThrough({highWaterMark:options.highWaterMark});const chunkReadahead=options.chunkReadahead||3;const liveBuffer=options.liveBuffer||2e4;const requestOptions=options.requestOptions;const Parser=supportedParsers[options.parser||(/\.mpd$/.test(playlistURL)?"dash-mpd":"m3u8")];if(!Parser){throw TypeError(`parser '${options.parser}' not supported`)}let begin=0;if(typeof options.begin!=="undefined"){begin=typeof options.begin==="string"?parse_time_1.humanStr(options.begin):Math.max(options.begin-liveBuffer,0)}const forwardEvents=req=>{for(let event of["abort","request","response","redirect","retry","reconnect"]){req.on(event,stream.emit.bind(stream,event))}};let currSegment;const streamQueue=new queue_1.Queue(((req,callback)=>{currSegment=req;let size=0;req.on("data",(chunk=>size+=chunk.length));req.pipe(stream,{end:false});req.on("end",(()=>callback(null,size)))}),{concurrency:1});let segmentNumber=0;let downloaded=0;const requestQueue=new queue_1.Queue(((segment,callback)=>{let reqOptions=Object.assign({},requestOptions);if(segment.range){reqOptions.headers=Object.assign({},reqOptions.headers,{Range:`bytes=${segment.range.start}-${segment.range.end}`})}let req=miniget_1.default(new URL(segment.url,playlistURL).toString(),reqOptions);req.on("error",callback);forwardEvents(req);streamQueue.push(req,((_,size)=>{downloaded+=+size;stream.emit("progress",{num:++segmentNumber,size:size,duration:segment.duration,url:segment.url},requestQueue.total,downloaded);callback(null)}))}),{concurrency:chunkReadahead});const onError=err=>{stream.emit("error",err);stream.end()};let refreshThreshold;let minRefreshTime;let refreshTimeout;let fetchingPlaylist=true;let ended=false;let isStatic=false;let lastRefresh;const onQueuedEnd=err=>{currSegment=null;if(err){onError(err)}else if(!fetchingPlaylist&&!ended&&!isStatic&&requestQueue.tasks.length+requestQueue.active<=refreshThreshold){let ms=Math.max(0,minRefreshTime-(Date.now()-lastRefresh));fetchingPlaylist=true;refreshTimeout=setTimeout(refreshPlaylist,ms)}else if((ended||isStatic)&&!requestQueue.tasks.length&&!requestQueue.active){stream.end()}};let currPlaylist;let lastSeq;let starttime=0;const refreshPlaylist=()=>{lastRefresh=Date.now();currPlaylist=miniget_1.default(playlistURL,requestOptions);currPlaylist.on("error",onError);forwardEvents(currPlaylist);const parser=currPlaylist.pipe(new Parser(options.id));parser.on("starttime",(a=>{if(starttime){return}starttime=a;if(typeof options.begin==="string"&&begin>=0){begin+=starttime}}));parser.on("endlist",(()=>{isStatic=true}));parser.on("endearly",currPlaylist.unpipe.bind(currPlaylist,parser));let addedItems=[];const addItem=item=>{if(!item.init){if(item.seq<=lastSeq){return}lastSeq=item.seq}begin=item.time;requestQueue.push(item,onQueuedEnd);addedItems.push(item)};let tailedItems=[],tailedItemsDuration=0;parser.on("item",(item=>{let timedItem=Object.assign({time:starttime},item);if(begin<=timedItem.time){addItem(timedItem)}else{tailedItems.push(timedItem);tailedItemsDuration+=timedItem.duration;while(tailedItems.length>1&&tailedItemsDuration-tailedItems[0].duration>liveBuffer){const lastItem=tailedItems.shift();tailedItemsDuration-=lastItem.duration}}starttime+=timedItem.duration}));parser.on("end",(()=>{currPlaylist=null;if(!addedItems.length&&tailedItems.length){tailedItems.forEach((item=>{addItem(item)}))}refreshThreshold=Math.max(1,Math.ceil(addedItems.length*.01));minRefreshTime=addedItems.reduce(((total,item)=>item.duration+total),0);fetchingPlaylist=false;onQueuedEnd(null)}))};refreshPlaylist();stream.end=()=>{ended=true;streamQueue.die();requestQueue.die();clearTimeout(refreshTimeout);currPlaylist===null||currPlaylist===void 0?void 0:currPlaylist.destroy();currSegment===null||currSegment===void 0?void 0:currSegment.destroy();stream_1.PassThrough.prototype.end.call(stream,null);return stream};return stream};m3u8stream.parseTimestamp=parse_time_1.humanStr;module.exports=m3u8stream},{"./dash-mpd-parser":20,"./m3u8-parser":22,"./parse-time":23,"./queue":24,miniget:25,stream:undefined}],22:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const stream_1=require("stream");class m3u8Parser extends stream_1.Writable{constructor(){super();this._lastLine="";this._seq=0;this._nextItemDuration=null;this._nextItemRange=null;this._lastItemRangeEnd=0;this.on("finish",(()=>{this._parseLine(this._lastLine);this.emit("end")}))}_parseAttrList(value){let attrs={};let regex=/([A-Z0-9-]+)=(?:"([^"]*?)"|([^,]*?))/g;let match;while((match=regex.exec(value))!==null){attrs[match[1]]=match[2]||match[3]}return attrs}_parseRange(value){if(!value)return null;let svalue=value.split("@");let start=svalue[1]?parseInt(svalue[1]):this._lastItemRangeEnd+1;let end=start+parseInt(svalue[0])-1;let range={start:start,end:end};this._lastItemRangeEnd=range.end;return range}_parseLine(line){let match=line.match(/^#(EXT[A-Z0-9-]+)(?::(.*))?/);if(match){const tag=match[1];const value=match[2]||"";switch(tag){case"EXT-X-PROGRAM-DATE-TIME":this.emit("starttime",new Date(value).getTime());break;case"EXT-X-MEDIA-SEQUENCE":this._seq=parseInt(value);break;case"EXT-X-MAP":{let attrs=this._parseAttrList(value);if(!attrs.URI){this.destroy(new Error("`EXT-X-MAP` found without required attribute `URI`"));return}this.emit("item",{url:attrs.URI,seq:this._seq,init:true,duration:0,range:this._parseRange(attrs.BYTERANGE)});break}case"EXT-X-BYTERANGE":{this._nextItemRange=this._parseRange(value);break}case"EXTINF":this._nextItemDuration=Math.round(parseFloat(value.split(",")[0])*1e3);break;case"EXT-X-ENDLIST":this.emit("endlist");break}}else if(!/^#/.test(line)&&line.trim()){this.emit("item",{url:line.trim(),seq:this._seq++,duration:this._nextItemDuration,range:this._nextItemRange});this._nextItemRange=null}}_write(chunk,encoding,callback){let lines=chunk.toString("utf8").split("\n");if(this._lastLine){lines[0]=this._lastLine+lines[0]}lines.forEach(((line,i)=>{if(this.destroyed)return;if(i<lines.length-1){this._parseLine(line)}else{this._lastLine=line}}));callback()}}exports.default=m3u8Parser},{stream:undefined}],23:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.durationStr=exports.humanStr=void 0;const numberFormat=/^\d+$/;const timeFormat=/^(?:(?:(\d+):)?(\d{1,2}):)?(\d{1,2})(?:\.(\d{3}))?$/;const timeUnits={ms:1,s:1e3,m:6e4,h:36e5};exports.humanStr=time=>{if(typeof time==="number"){return time}if(numberFormat.test(time)){return+time}const firstFormat=timeFormat.exec(time);if(firstFormat){return+(firstFormat[1]||0)*timeUnits.h+ +(firstFormat[2]||0)*timeUnits.m+ +firstFormat[3]*timeUnits.s+ +(firstFormat[4]||0)}else{let total=0;const r=/(-?\d+)(ms|s|m|h)/g;let rs;while((rs=r.exec(time))!==null){total+=+rs[1]*timeUnits[rs[2]]}return total}};exports.durationStr=time=>{let total=0;const r=/(\d+(?:\.\d+)?)(S|M|H)/g;let rs;while((rs=r.exec(time))!==null){total+=+rs[1]*timeUnits[rs[2].toLowerCase()]}return total}},{}],24:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Queue=void 0;class Queue{constructor(worker,options={}){this._worker=worker;this._concurrency=options.concurrency||1;this.tasks=[];this.total=0;this.active=0}push(item,callback){this.tasks.push({item:item,callback:callback});this.total++;this._next()}_next(){if(this.active>=this._concurrency||!this.tasks.length){return}const{item:item,callback:callback}=this.tasks.shift();let callbackCalled=false;this.active++;this._worker(item,((err,result)=>{if(callbackCalled){return}this.active--;callbackCalled=true;callback===null||callback===void 0?void 0:callback(err,result);this._next()}))}die(){this.tasks=[]}}exports.Queue=Queue},{}],25:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};const http_1=__importDefault(require("http"));const https_1=__importDefault(require("https"));const stream_1=require("stream");const httpLibs={"http:":http_1.default,"https:":https_1.default};const redirectStatusCodes=new Set([301,302,303,307,308]);const retryStatusCodes=new Set([429,503]);const requestEvents=["connect","continue","information","socket","timeout","upgrade"];const responseEvents=["aborted"];Miniget.MinigetError=class MinigetError extends Error{constructor(message,statusCode){super(message);this.statusCode=statusCode}};Miniget.defaultOptions={maxRedirects:10,maxRetries:2,maxReconnects:0,backoff:{inc:100,max:1e4}};function Miniget(url,options={}){var _a;const opts=Object.assign({},Miniget.defaultOptions,options);const stream=new stream_1.PassThrough({highWaterMark:opts.highWaterMark});stream.destroyed=stream.aborted=false;let activeRequest;let activeResponse;let activeDecodedStream;let redirects=0;let retries=0;let retryTimeout;let reconnects=0;let contentLength;let acceptRanges=false;let rangeStart=0,rangeEnd;let downloaded=0;if((_a=opts.headers)===null||_a===void 0?void 0:_a.Range){let r=/bytes=(\d+)-(\d+)?/.exec(`${opts.headers.Range}`);if(r){rangeStart=parseInt(r[1],10);rangeEnd=parseInt(r[2],10)}}if(opts.acceptEncoding){opts.headers=Object.assign({"Accept-Encoding":Object.keys(opts.acceptEncoding).join(", ")},opts.headers)}const downloadHasStarted=()=>activeDecodedStream&&downloaded>0;const downloadComplete=()=>!acceptRanges||downloaded===contentLength;const reconnect=err=>{activeDecodedStream=null;retries=0;let inc=opts.backoff.inc;let ms=Math.min(inc,opts.backoff.max);retryTimeout=setTimeout(doDownload,ms);stream.emit("reconnect",reconnects,err)};const reconnectIfEndedEarly=err=>{if(options.method!=="HEAD"&&!downloadComplete()&&reconnects++<opts.maxReconnects){reconnect(err);return true}return false};const retryRequest=retryOptions=>{if(stream.destroyed){return false}if(downloadHasStarted()){return reconnectIfEndedEarly(retryOptions.err)}else if((!retryOptions.err||retryOptions.err.message==="ENOTFOUND")&&retries++<opts.maxRetries){let ms=retryOptions.retryAfter||Math.min(retries*opts.backoff.inc,opts.backoff.max);retryTimeout=setTimeout(doDownload,ms);stream.emit("retry",retries,retryOptions.err);return true}return false};const forwardEvents=(ee,events)=>{for(let event of events){ee.on(event,stream.emit.bind(stream,event))}};const doDownload=()=>{let parsed={},httpLib;try{let urlObj=typeof url==="string"?new URL(url):url;parsed=Object.assign({},{host:urlObj.host,hostname:urlObj.hostname,path:urlObj.pathname+urlObj.search+urlObj.hash,port:urlObj.port,protocol:urlObj.protocol});if(urlObj.username){parsed.auth=`${urlObj.username}:${urlObj.password}`}httpLib=httpLibs[String(parsed.protocol)]}catch(err){}if(!httpLib){stream.emit("error",new Miniget.MinigetError(`Invalid URL: ${url}`));return}Object.assign(parsed,opts);if(acceptRanges&&downloaded>0){let start=downloaded+rangeStart;let end=rangeEnd||"";parsed.headers=Object.assign({},parsed.headers,{Range:`bytes=${start}-${end}`})}if(opts.transform){try{parsed=opts.transform(parsed)}catch(err){stream.emit("error",err);return}if(!parsed||parsed.protocol){httpLib=httpLibs[String(parsed===null||parsed===void 0?void 0:parsed.protocol)];if(!httpLib){stream.emit("error",new Miniget.MinigetError("Invalid URL object from `transform` function"));return}}}const onError=err=>{if(stream.destroyed||stream.readableEnded){return}cleanup();if(!retryRequest({err:err})){stream.emit("error",err)}else{activeRequest.removeListener("close",onRequestClose)}};const onRequestClose=()=>{cleanup();retryRequest({})};const cleanup=()=>{activeRequest.removeListener("close",onRequestClose);activeResponse===null||activeResponse===void 0?void 0:activeResponse.removeListener("data",onData);activeDecodedStream===null||activeDecodedStream===void 0?void 0:activeDecodedStream.removeListener("end",onEnd)};const onData=chunk=>{downloaded+=chunk.length};const onEnd=()=>{cleanup();if(!reconnectIfEndedEarly()){stream.end()}};activeRequest=httpLib.request(parsed,(res=>{if(stream.destroyed){return}if(redirectStatusCodes.has(res.statusCode)){if(redirects++>=opts.maxRedirects){stream.emit("error",new Miniget.MinigetError("Too many redirects"))}else{if(res.headers.location){url=res.headers.location}else{let err=new Miniget.MinigetError("Redirect status code given with no location",res.statusCode);stream.emit("error",err);cleanup();return}setTimeout(doDownload,parseInt(res.headers["retry-after"]||"0",10)*1e3);stream.emit("redirect",url)}cleanup();return}else if(retryStatusCodes.has(res.statusCode)){if(!retryRequest({retryAfter:parseInt(res.headers["retry-after"]||"0",10)})){let err=new Miniget.MinigetError(`Status code: ${res.statusCode}`,res.statusCode);stream.emit("error",err)}cleanup();return}else if(res.statusCode&&(res.statusCode<200||res.statusCode>=400)){let err=new Miniget.MinigetError(`Status code: ${res.statusCode}`,res.statusCode);if(res.statusCode>=500){onError(err)}else{stream.emit("error",err)}cleanup();return}activeDecodedStream=res;if(opts.acceptEncoding&&res.headers["content-encoding"]){for(let enc of res.headers["content-encoding"].split(", ").reverse()){let fn=opts.acceptEncoding[enc];if(fn){activeDecodedStream=activeDecodedStream.pipe(fn());activeDecodedStream.on("error",onError)}}}if(!contentLength){contentLength=parseInt(`${res.headers["content-length"]}`,10);acceptRanges=res.headers["accept-ranges"]==="bytes"&&contentLength>0&&opts.maxReconnects>0}res.on("data",onData);activeDecodedStream.on("end",onEnd);activeDecodedStream.pipe(stream,{end:!acceptRanges});activeResponse=res;stream.emit("response",res);res.on("error",onError);forwardEvents(res,responseEvents)}));activeRequest.on("error",onError);activeRequest.on("close",onRequestClose);forwardEvents(activeRequest,requestEvents);if(stream.destroyed){streamDestroy(...destroyArgs)}stream.emit("request",activeRequest);activeRequest.end()};stream.abort=err=>{console.warn("`MinigetStream#abort()` has been deprecated in favor of `MinigetStream#destroy()`");stream.aborted=true;stream.emit("abort");stream.destroy(err)};let destroyArgs;const streamDestroy=err=>{activeRequest.destroy(err);activeDecodedStream===null||activeDecodedStream===void 0?void 0:activeDecodedStream.unpipe(stream);activeDecodedStream===null||activeDecodedStream===void 0?void 0:activeDecodedStream.destroy();clearTimeout(retryTimeout)};stream._destroy=(...args)=>{stream.destroyed=true;if(activeRequest){streamDestroy(...args)}else{destroyArgs=args}};stream.text=()=>new Promise(((resolve,reject)=>{let body="";stream.setEncoding("utf8");stream.on("data",(chunk=>body+=chunk));stream.on("end",(()=>resolve(body)));stream.on("error",reject)}));process.nextTick(doDownload);return stream}module.exports=Miniget},{http:undefined,https:undefined,stream:undefined}],26:[function(require,module,exports){"use strict";var truncate=require("truncate-utf8-bytes");var illegalRe=/[\/\?<>\\:\*\|"]/g;var controlRe=/[\x00-\x1f\x80-\x9f]/g;var reservedRe=/^\.+$/;var windowsReservedRe=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i;var windowsTrailingRe=/[\. ]+$/;function sanitize(input,replacement){if(typeof input!=="string"){throw new Error("Input must be string")}var sanitized=input.replace(illegalRe,replacement).replace(controlRe,replacement).replace(reservedRe,replacement).replace(windowsReservedRe,replacement).replace(windowsTrailingRe,replacement);return truncate(sanitized,255)}module.exports=function(input,options){var replacement=options&&options.replacement||"";var output=sanitize(input,replacement);if(replacement===""){return output}return sanitize(output,"")}},{"truncate-utf8-bytes":28}],27:[function(require,module,exports){(function(sax){sax.parser=function(strict,opt){return new SAXParser(strict,opt)};sax.SAXParser=SAXParser;sax.SAXStream=SAXStream;sax.createStream=createStream;sax.MAX_BUFFER_LENGTH=64*1024;var buffers=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];sax.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"];function SAXParser(strict,opt){if(!(this instanceof SAXParser)){return new SAXParser(strict,opt)}var parser=this;clearBuffers(parser);parser.q=parser.c="";parser.bufferCheckPosition=sax.MAX_BUFFER_LENGTH;parser.opt=opt||{};parser.opt.lowercase=parser.opt.lowercase||parser.opt.lowercasetags;parser.looseCase=parser.opt.lowercase?"toLowerCase":"toUpperCase";parser.tags=[];parser.closed=parser.closedRoot=parser.sawRoot=false;parser.tag=parser.error=null;parser.strict=!!strict;parser.noscript=!!(strict||parser.opt.noscript);parser.state=S.BEGIN;parser.strictEntities=parser.opt.strictEntities;parser.ENTITIES=parser.strictEntities?Object.create(sax.XML_ENTITIES):Object.create(sax.ENTITIES);parser.attribList=[];if(parser.opt.xmlns){parser.ns=Object.create(rootNS)}parser.trackPosition=parser.opt.position!==false;if(parser.trackPosition){parser.position=parser.line=parser.column=0}emit(parser,"onready")}if(!Object.create){Object.create=function(o){function F(){}F.prototype=o;var newf=new F;return newf}}if(!Object.keys){Object.keys=function(o){var a=[];for(var i in o)if(o.hasOwnProperty(i))a.push(i);return a}}function checkBufferLength(parser){var maxAllowed=Math.max(sax.MAX_BUFFER_LENGTH,10);var maxActual=0;for(var i=0,l=buffers.length;i<l;i++){var len=parser[buffers[i]].length;if(len>maxAllowed){switch(buffers[i]){case"textNode":closeText(parser);break;case"cdata":emitNode(parser,"oncdata",parser.cdata);parser.cdata="";break;case"script":emitNode(parser,"onscript",parser.script);parser.script="";break;default:error(parser,"Max buffer length exceeded: "+buffers[i])}}maxActual=Math.max(maxActual,len)}var m=sax.MAX_BUFFER_LENGTH-maxActual;parser.bufferCheckPosition=m+parser.position}function clearBuffers(parser){for(var i=0,l=buffers.length;i<l;i++){parser[buffers[i]]=""}}function flushBuffers(parser){closeText(parser);if(parser.cdata!==""){emitNode(parser,"oncdata",parser.cdata);parser.cdata=""}if(parser.script!==""){emitNode(parser,"onscript",parser.script);parser.script=""}}SAXParser.prototype={end:function(){end(this)},write:write,resume:function(){this.error=null;return this},close:function(){return this.write(null)},flush:function(){flushBuffers(this)}};var Stream;try{Stream=require("stream").Stream}catch(ex){Stream=function(){}}var streamWraps=sax.EVENTS.filter((function(ev){return ev!=="error"&&ev!=="end"}));function createStream(strict,opt){return new SAXStream(strict,opt)}function SAXStream(strict,opt){if(!(this instanceof SAXStream)){return new SAXStream(strict,opt)}Stream.apply(this);this._parser=new SAXParser(strict,opt);this.writable=true;this.readable=true;var me=this;this._parser.onend=function(){me.emit("end")};this._parser.onerror=function(er){me.emit("error",er);me._parser.error=null};this._decoder=null;streamWraps.forEach((function(ev){Object.defineProperty(me,"on"+ev,{get:function(){return me._parser["on"+ev]},set:function(h){if(!h){me.removeAllListeners(ev);me._parser["on"+ev]=h;return h}me.on(ev,h)},enumerable:true,configurable:false})}))}SAXStream.prototype=Object.create(Stream.prototype,{constructor:{value:SAXStream}});SAXStream.prototype.write=function(data){if(typeof Buffer==="function"&&typeof Buffer.isBuffer==="function"&&Buffer.isBuffer(data)){if(!this._decoder){var SD=require("string_decoder").StringDecoder;this._decoder=new SD("utf8")}data=this._decoder.write(data)}this._parser.write(data.toString());this.emit("data",data);return true};SAXStream.prototype.end=function(chunk){if(chunk&&chunk.length){this.write(chunk)}this._parser.end();return true};SAXStream.prototype.on=function(ev,handler){var me=this;if(!me._parser["on"+ev]&&streamWraps.indexOf(ev)!==-1){me._parser["on"+ev]=function(){var args=arguments.length===1?[arguments[0]]:Array.apply(null,arguments);args.splice(0,0,ev);me.emit.apply(me,args)}}return Stream.prototype.on.call(me,ev,handler)};var CDATA="[CDATA[";var DOCTYPE="DOCTYPE";var XML_NAMESPACE="http://www.w3.org/XML/1998/namespace";var XMLNS_NAMESPACE="http://www.w3.org/2000/xmlns/";var rootNS={xml:XML_NAMESPACE,xmlns:XMLNS_NAMESPACE};var nameStart=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/;var nameBody=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;var entityStart=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/;var entityBody=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function isWhitespace(c){return c===" "||c==="\n"||c==="\r"||c==="\t"}function isQuote(c){return c==='"'||c==="'"}function isAttribEnd(c){return c===">"||isWhitespace(c)}function isMatch(regex,c){return regex.test(c)}function notMatch(regex,c){return!isMatch(regex,c)}var S=0;sax.STATE={BEGIN:S++,BEGIN_WHITESPACE:S++,TEXT:S++,TEXT_ENTITY:S++,OPEN_WAKA:S++,SGML_DECL:S++,SGML_DECL_QUOTED:S++,DOCTYPE:S++,DOCTYPE_QUOTED:S++,DOCTYPE_DTD:S++,DOCTYPE_DTD_QUOTED:S++,COMMENT_STARTING:S++,COMMENT:S++,COMMENT_ENDING:S++,COMMENT_ENDED:S++,CDATA:S++,CDATA_ENDING:S++,CDATA_ENDING_2:S++,PROC_INST:S++,PROC_INST_BODY:S++,PROC_INST_ENDING:S++,OPEN_TAG:S++,OPEN_TAG_SLASH:S++,ATTRIB:S++,ATTRIB_NAME:S++,ATTRIB_NAME_SAW_WHITE:S++,ATTRIB_VALUE:S++,ATTRIB_VALUE_QUOTED:S++,ATTRIB_VALUE_CLOSED:S++,ATTRIB_VALUE_UNQUOTED:S++,ATTRIB_VALUE_ENTITY_Q:S++,ATTRIB_VALUE_ENTITY_U:S++,CLOSE_TAG:S++,CLOSE_TAG_SAW_WHITE:S++,SCRIPT:S++,SCRIPT_ENDING:S++};sax.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"};sax.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830};Object.keys(sax.ENTITIES).forEach((function(key){var e=sax.ENTITIES[key];var s=typeof e==="number"?String.fromCharCode(e):e;sax.ENTITIES[key]=s}));for(var s in sax.STATE){sax.STATE[sax.STATE[s]]=s}S=sax.STATE;function emit(parser,event,data){parser[event]&&parser[event](data)}function emitNode(parser,nodeType,data){if(parser.textNode)closeText(parser);emit(parser,nodeType,data)}function closeText(parser){parser.textNode=textopts(parser.opt,parser.textNode);if(parser.textNode)emit(parser,"ontext",parser.textNode);parser.textNode=""}function textopts(opt,text){if(opt.trim)text=text.trim();if(opt.normalize)text=text.replace(/\s+/g," ");return text}function error(parser,er){closeText(parser);if(parser.trackPosition){er+="\nLine: "+parser.line+"\nColumn: "+parser.column+"\nChar: "+parser.c}er=new Error(er);parser.error=er;emit(parser,"onerror",er);return parser}function end(parser){if(parser.sawRoot&&!parser.closedRoot)strictFail(parser,"Unclosed root tag");if(parser.state!==S.BEGIN&&parser.state!==S.BEGIN_WHITESPACE&&parser.state!==S.TEXT){error(parser,"Unexpected end")}closeText(parser);parser.c="";parser.closed=true;emit(parser,"onend");SAXParser.call(parser,parser.strict,parser.opt);return parser}function strictFail(parser,message){if(typeof parser!=="object"||!(parser instanceof SAXParser)){throw new Error("bad call to strictFail")}if(parser.strict){error(parser,message)}}function newTag(parser){if(!parser.strict)parser.tagName=parser.tagName[parser.looseCase]();var parent=parser.tags[parser.tags.length-1]||parser;var tag=parser.tag={name:parser.tagName,attributes:{}};if(parser.opt.xmlns){tag.ns=parent.ns}parser.attribList.length=0;emitNode(parser,"onopentagstart",tag)}function qname(name,attribute){var i=name.indexOf(":");var qualName=i<0?["",name]:name.split(":");var prefix=qualName[0];var local=qualName[1];if(attribute&&name==="xmlns"){prefix="xmlns";local=""}return{prefix:prefix,local:local}}function attrib(parser){if(!parser.strict){parser.attribName=parser.attribName[parser.looseCase]()}if(parser.attribList.indexOf(parser.attribName)!==-1||parser.tag.attributes.hasOwnProperty(parser.attribName)){parser.attribName=parser.attribValue="";return}if(parser.opt.xmlns){var qn=qname(parser.attribName,true);var prefix=qn.prefix;var local=qn.local;if(prefix==="xmlns"){if(local==="xml"&&parser.attribValue!==XML_NAMESPACE){strictFail(parser,"xml: prefix must be bound to "+XML_NAMESPACE+"\n"+"Actual: "+parser.attribValue)}else if(local==="xmlns"&&parser.attribValue!==XMLNS_NAMESPACE){strictFail(parser,"xmlns: prefix must be bound to "+XMLNS_NAMESPACE+"\n"+"Actual: "+parser.attribValue)}else{var tag=parser.tag;var parent=parser.tags[parser.tags.length-1]||parser;if(tag.ns===parent.ns){tag.ns=Object.create(parent.ns)}tag.ns[local]=parser.attribValue}}parser.attribList.push([parser.attribName,parser.attribValue])}else{parser.tag.attributes[parser.attribName]=parser.attribValue;emitNode(parser,"onattribute",{name:parser.attribName,value:parser.attribValue})}parser.attribName=parser.attribValue=""}function openTag(parser,selfClosing){if(parser.opt.xmlns){var tag=parser.tag;var qn=qname(parser.tagName);tag.prefix=qn.prefix;tag.local=qn.local;tag.uri=tag.ns[qn.prefix]||"";if(tag.prefix&&!tag.uri){strictFail(parser,"Unbound namespace prefix: "+JSON.stringify(parser.tagName));tag.uri=qn.prefix}var parent=parser.tags[parser.tags.length-1]||parser;if(tag.ns&&parent.ns!==tag.ns){Object.keys(tag.ns).forEach((function(p){emitNode(parser,"onopennamespace",{prefix:p,uri:tag.ns[p]})}))}for(var i=0,l=parser.attribList.length;i<l;i++){var nv=parser.attribList[i];var name=nv[0];var value=nv[1];var qualName=qname(name,true);var prefix=qualName.prefix;var local=qualName.local;var uri=prefix===""?"":tag.ns[prefix]||"";var a={name:name,value:value,prefix:prefix,local:local,uri:uri};if(prefix&&prefix!=="xmlns"&&!uri){strictFail(parser,"Unbound namespace prefix: "+JSON.stringify(prefix));a.uri=prefix}parser.tag.attributes[name]=a;emitNode(parser,"onattribute",a)}parser.attribList.length=0}parser.tag.isSelfClosing=!!selfClosing;parser.sawRoot=true;parser.tags.push(parser.tag);emitNode(parser,"onopentag",parser.tag);if(!selfClosing){if(!parser.noscript&&parser.tagName.toLowerCase()==="script"){parser.state=S.SCRIPT}else{parser.state=S.TEXT}parser.tag=null;parser.tagName=""}parser.attribName=parser.attribValue="";parser.attribList.length=0}function closeTag(parser){if(!parser.tagName){strictFail(parser,"Weird empty close tag.");parser.textNode+="</>";parser.state=S.TEXT;return}if(parser.script){if(parser.tagName!=="script"){parser.script+="</"+parser.tagName+">";parser.tagName="";parser.state=S.SCRIPT;return}emitNode(parser,"onscript",parser.script);parser.script=""}var t=parser.tags.length;var tagName=parser.tagName;if(!parser.strict){tagName=tagName[parser.looseCase]()}var closeTo=tagName;while(t--){var close=parser.tags[t];if(close.name!==closeTo){strictFail(parser,"Unexpected close tag")}else{break}}if(t<0){strictFail(parser,"Unmatched closing tag: "+parser.tagName);parser.textNode+="</"+parser.tagName+">";parser.state=S.TEXT;return}parser.tagName=tagName;var s=parser.tags.length;while(s-- >t){var tag=parser.tag=parser.tags.pop();parser.tagName=parser.tag.name;emitNode(parser,"onclosetag",parser.tagName);var x={};for(var i in tag.ns){x[i]=tag.ns[i]}var parent=parser.tags[parser.tags.length-1]||parser;if(parser.opt.xmlns&&tag.ns!==parent.ns){Object.keys(tag.ns).forEach((function(p){var n=tag.ns[p];emitNode(parser,"onclosenamespace",{prefix:p,uri:n})}))}}if(t===0)parser.closedRoot=true;parser.tagName=parser.attribValue=parser.attribName="";parser.attribList.length=0;parser.state=S.TEXT}function parseEntity(parser){var entity=parser.entity;var entityLC=entity.toLowerCase();var num;var numStr="";if(parser.ENTITIES[entity]){return parser.ENTITIES[entity]}if(parser.ENTITIES[entityLC]){return parser.ENTITIES[entityLC]}entity=entityLC;if(entity.charAt(0)==="#"){if(entity.charAt(1)==="x"){entity=entity.slice(2);num=parseInt(entity,16);numStr=num.toString(16)}else{entity=entity.slice(1);num=parseInt(entity,10);numStr=num.toString(10)}}entity=entity.replace(/^0+/,"");if(isNaN(num)||numStr.toLowerCase()!==entity){strictFail(parser,"Invalid character entity");return"&"+parser.entity+";"}return String.fromCodePoint(num)}function beginWhiteSpace(parser,c){if(c==="<"){parser.state=S.OPEN_WAKA;parser.startTagPosition=parser.position}else if(!isWhitespace(c)){strictFail(parser,"Non-whitespace before first tag.");parser.textNode=c;parser.state=S.TEXT}}function charAt(chunk,i){var result="";if(i<chunk.length){result=chunk.charAt(i)}return result}function write(chunk){var parser=this;if(this.error){throw this.error}if(parser.closed){return error(parser,"Cannot write after close. Assign an onready handler.")}if(chunk===null){return end(parser)}if(typeof chunk==="object"){chunk=chunk.toString()}var i=0;var c="";while(true){c=charAt(chunk,i++);parser.c=c;if(!c){break}if(parser.trackPosition){parser.position++;if(c==="\n"){parser.line++;parser.column=0}else{parser.column++}}switch(parser.state){case S.BEGIN:parser.state=S.BEGIN_WHITESPACE;if(c==="\ufeff"){continue}beginWhiteSpace(parser,c);continue;case S.BEGIN_WHITESPACE:beginWhiteSpace(parser,c);continue;case S.TEXT:if(parser.sawRoot&&!parser.closedRoot){var starti=i-1;while(c&&c!=="<"&&c!=="&"){c=charAt(chunk,i++);if(c&&parser.trackPosition){parser.position++;if(c==="\n"){parser.line++;parser.column=0}else{parser.column++}}}parser.textNode+=chunk.substring(starti,i-1)}if(c==="<"&&!(parser.sawRoot&&parser.closedRoot&&!parser.strict)){parser.state=S.OPEN_WAKA;parser.startTagPosition=parser.position}else{if(!isWhitespace(c)&&(!parser.sawRoot||parser.closedRoot)){strictFail(parser,"Text data outside of root node.")}if(c==="&"){parser.state=S.TEXT_ENTITY}else{parser.textNode+=c}}continue;case S.SCRIPT:if(c==="<"){parser.state=S.SCRIPT_ENDING}else{parser.script+=c}continue;case S.SCRIPT_ENDING:if(c==="/"){parser.state=S.CLOSE_TAG}else{parser.script+="<"+c;parser.state=S.SCRIPT}continue;case S.OPEN_WAKA:if(c==="!"){parser.state=S.SGML_DECL;parser.sgmlDecl=""}else if(isWhitespace(c)){}else if(isMatch(nameStart,c)){parser.state=S.OPEN_TAG;parser.tagName=c}else if(c==="/"){parser.state=S.CLOSE_TAG;parser.tagName=""}else if(c==="?"){parser.state=S.PROC_INST;parser.procInstName=parser.procInstBody=""}else{strictFail(parser,"Unencoded <");if(parser.startTagPosition+1<parser.position){var pad=parser.position-parser.startTagPosition;c=new Array(pad).join(" ")+c}parser.textNode+="<"+c;parser.state=S.TEXT}continue;case S.SGML_DECL:if((parser.sgmlDecl+c).toUpperCase()===CDATA){emitNode(parser,"onopencdata");parser.state=S.CDATA;parser.sgmlDecl="";parser.cdata=""}else if(parser.sgmlDecl+c==="--"){parser.state=S.COMMENT;parser.comment="";parser.sgmlDecl=""}else if((parser.sgmlDecl+c).toUpperCase()===DOCTYPE){parser.state=S.DOCTYPE;if(parser.doctype||parser.sawRoot){strictFail(parser,"Inappropriately located doctype declaration")}parser.doctype="";parser.sgmlDecl=""}else if(c===">"){emitNode(parser,"onsgmldeclaration",parser.sgmlDecl);parser.sgmlDecl="";parser.state=S.TEXT}else if(isQuote(c)){parser.state=S.SGML_DECL_QUOTED;parser.sgmlDecl+=c}else{parser.sgmlDecl+=c}continue;case S.SGML_DECL_QUOTED:if(c===parser.q){parser.state=S.SGML_DECL;parser.q=""}parser.sgmlDecl+=c;continue;case S.DOCTYPE:if(c===">"){parser.state=S.TEXT;emitNode(parser,"ondoctype",parser.doctype);parser.doctype=true}else{parser.doctype+=c;if(c==="["){parser.state=S.DOCTYPE_DTD}else if(isQuote(c)){parser.state=S.DOCTYPE_QUOTED;parser.q=c}}continue;case S.DOCTYPE_QUOTED:parser.doctype+=c;if(c===parser.q){parser.q="";parser.state=S.DOCTYPE}continue;case S.DOCTYPE_DTD:parser.doctype+=c;if(c==="]"){parser.state=S.DOCTYPE}else if(isQuote(c)){parser.state=S.DOCTYPE_DTD_QUOTED;parser.q=c}continue;case S.DOCTYPE_DTD_QUOTED:parser.doctype+=c;if(c===parser.q){parser.state=S.DOCTYPE_DTD;parser.q=""}continue;case S.COMMENT:if(c==="-"){parser.state=S.COMMENT_ENDING}else{parser.comment+=c}continue;case S.COMMENT_ENDING:if(c==="-"){parser.state=S.COMMENT_ENDED;parser.comment=textopts(parser.opt,parser.comment);if(parser.comment){emitNode(parser,"oncomment",parser.comment)}parser.comment=""}else{parser.comment+="-"+c;parser.state=S.COMMENT}continue;case S.COMMENT_ENDED:if(c!==">"){strictFail(parser,"Malformed comment");parser.comment+="--"+c;parser.state=S.COMMENT}else{parser.state=S.TEXT}continue;case S.CDATA:if(c==="]"){parser.state=S.CDATA_ENDING}else{parser.cdata+=c}continue;case S.CDATA_ENDING:if(c==="]"){parser.state=S.CDATA_ENDING_2}else{parser.cdata+="]"+c;parser.state=S.CDATA}continue;case S.CDATA_ENDING_2:if(c===">"){if(parser.cdata){emitNode(parser,"oncdata",parser.cdata)}emitNode(parser,"onclosecdata");parser.cdata="";parser.state=S.TEXT}else if(c==="]"){parser.cdata+="]"}else{parser.cdata+="]]"+c;parser.state=S.CDATA}continue;case S.PROC_INST:if(c==="?"){parser.state=S.PROC_INST_ENDING}else if(isWhitespace(c)){parser.state=S.PROC_INST_BODY}else{parser.procInstName+=c}continue;case S.PROC_INST_BODY:if(!parser.procInstBody&&isWhitespace(c)){continue}else if(c==="?"){parser.state=S.PROC_INST_ENDING}else{parser.procInstBody+=c}continue;case S.PROC_INST_ENDING:if(c===">"){emitNode(parser,"onprocessinginstruction",{name:parser.procInstName,body:parser.procInstBody});parser.procInstName=parser.procInstBody="";parser.state=S.TEXT}else{parser.procInstBody+="?"+c;parser.state=S.PROC_INST_BODY}continue;case S.OPEN_TAG:if(isMatch(nameBody,c)){parser.tagName+=c}else{newTag(parser);if(c===">"){openTag(parser)}else if(c==="/"){parser.state=S.OPEN_TAG_SLASH}else{if(!isWhitespace(c)){strictFail(parser,"Invalid character in tag name")}parser.state=S.ATTRIB}}continue;case S.OPEN_TAG_SLASH:if(c===">"){openTag(parser,true);closeTag(parser)}else{strictFail(parser,"Forward-slash in opening tag not followed by >");parser.state=S.ATTRIB}continue;case S.ATTRIB:if(isWhitespace(c)){continue}else if(c===">"){openTag(parser)}else if(c==="/"){parser.state=S.OPEN_TAG_SLASH}else if(isMatch(nameStart,c)){parser.attribName=c;parser.attribValue="";parser.state=S.ATTRIB_NAME}else{strictFail(parser,"Invalid attribute name")}continue;case S.ATTRIB_NAME:if(c==="="){parser.state=S.ATTRIB_VALUE}else if(c===">"){strictFail(parser,"Attribute without value");parser.attribValue=parser.attribName;attrib(parser);openTag(parser)}else if(isWhitespace(c)){parser.state=S.ATTRIB_NAME_SAW_WHITE}else if(isMatch(nameBody,c)){parser.attribName+=c}else{strictFail(parser,"Invalid attribute name")}continue;case S.ATTRIB_NAME_SAW_WHITE:if(c==="="){parser.state=S.ATTRIB_VALUE}else if(isWhitespace(c)){continue}else{strictFail(parser,"Attribute without value");parser.tag.attributes[parser.attribName]="";parser.attribValue="";emitNode(parser,"onattribute",{name:parser.attribName,value:""});parser.attribName="";if(c===">"){openTag(parser)}else if(isMatch(nameStart,c)){parser.attribName=c;parser.state=S.ATTRIB_NAME}else{strictFail(parser,"Invalid attribute name");parser.state=S.ATTRIB}}continue;case S.ATTRIB_VALUE:if(isWhitespace(c)){continue}else if(isQuote(c)){parser.q=c;parser.state=S.ATTRIB_VALUE_QUOTED}else{strictFail(parser,"Unquoted attribute value");parser.state=S.ATTRIB_VALUE_UNQUOTED;parser.attribValue=c}continue;case S.ATTRIB_VALUE_QUOTED:if(c!==parser.q){if(c==="&"){parser.state=S.ATTRIB_VALUE_ENTITY_Q}else{parser.attribValue+=c}continue}attrib(parser);parser.q="";parser.state=S.ATTRIB_VALUE_CLOSED;continue;case S.ATTRIB_VALUE_CLOSED:if(isWhitespace(c)){parser.state=S.ATTRIB}else if(c===">"){openTag(parser)}else if(c==="/"){parser.state=S.OPEN_TAG_SLASH}else if(isMatch(nameStart,c)){strictFail(parser,"No whitespace between attributes");parser.attribName=c;parser.attribValue="";parser.state=S.ATTRIB_NAME}else{strictFail(parser,"Invalid attribute name")}continue;case S.ATTRIB_VALUE_UNQUOTED:if(!isAttribEnd(c)){if(c==="&"){parser.state=S.ATTRIB_VALUE_ENTITY_U}else{parser.attribValue+=c}continue}attrib(parser);if(c===">"){openTag(parser)}else{parser.state=S.ATTRIB}continue;case S.CLOSE_TAG:if(!parser.tagName){if(isWhitespace(c)){continue}else if(notMatch(nameStart,c)){if(parser.script){parser.script+="</"+c;parser.state=S.SCRIPT}else{strictFail(parser,"Invalid tagname in closing tag.")}}else{parser.tagName=c}}else if(c===">"){closeTag(parser)}else if(isMatch(nameBody,c)){parser.tagName+=c}else if(parser.script){parser.script+="</"+parser.tagName;parser.tagName="";parser.state=S.SCRIPT}else{if(!isWhitespace(c)){strictFail(parser,"Invalid tagname in closing tag")}parser.state=S.CLOSE_TAG_SAW_WHITE}continue;case S.CLOSE_TAG_SAW_WHITE:if(isWhitespace(c)){continue}if(c===">"){closeTag(parser)}else{strictFail(parser,"Invalid characters in closing tag")}continue;case S.TEXT_ENTITY:case S.ATTRIB_VALUE_ENTITY_Q:case S.ATTRIB_VALUE_ENTITY_U:var returnState;var buffer;switch(parser.state){case S.TEXT_ENTITY:returnState=S.TEXT;buffer="textNode";break;case S.ATTRIB_VALUE_ENTITY_Q:returnState=S.ATTRIB_VALUE_QUOTED;buffer="attribValue";break;case S.ATTRIB_VALUE_ENTITY_U:returnState=S.ATTRIB_VALUE_UNQUOTED;buffer="attribValue";break}if(c===";"){parser[buffer]+=parseEntity(parser);parser.entity="";parser.state=returnState}else if(isMatch(parser.entity.length?entityBody:entityStart,c)){parser.entity+=c}else{strictFail(parser,"Invalid character in entity name");parser[buffer]+="&"+parser.entity+c;parser.entity="";parser.state=returnState}continue;default:throw new Error(parser,"Unknown state: "+parser.state)}}if(parser.position>=parser.bufferCheckPosition){checkBufferLength(parser)}return parser}
/*! http://mths.be/fromcodepoint v0.1.0 by @mathias */if(!String.fromCodePoint){(function(){var stringFromCharCode=String.fromCharCode;var floor=Math.floor;var fromCodePoint=function(){var MAX_SIZE=16384;var codeUnits=[];var highSurrogate;var lowSurrogate;var index=-1;var length=arguments.length;if(!length){return""}var result="";while(++index<length){var codePoint=Number(arguments[index]);if(!isFinite(codePoint)||codePoint<0||codePoint>1114111||floor(codePoint)!==codePoint){throw RangeError("Invalid code point: "+codePoint)}if(codePoint<=65535){codeUnits.push(codePoint)}else{codePoint-=65536;highSurrogate=(codePoint>>10)+55296;lowSurrogate=codePoint%1024+56320;codeUnits.push(highSurrogate,lowSurrogate)}if(index+1===length||codeUnits.length>MAX_SIZE){result+=stringFromCharCode.apply(null,codeUnits);codeUnits.length=0}}return result};if(Object.defineProperty){Object.defineProperty(String,"fromCodePoint",{value:fromCodePoint,configurable:true,writable:true})}else{String.fromCodePoint=fromCodePoint}})()}})(typeof exports==="undefined"?this.sax={}:exports)},{stream:undefined,string_decoder:undefined}],28:[function(require,module,exports){"use strict";var truncate=require("./lib/truncate");var getLength=Buffer.byteLength.bind(Buffer);module.exports=truncate.bind(null,getLength)},{"./lib/truncate":29}],29:[function(require,module,exports){"use strict";function isHighSurrogate(codePoint){return codePoint>=55296&&codePoint<=56319}function isLowSurrogate(codePoint){return codePoint>=56320&&codePoint<=57343}module.exports=function truncate(getLength,string,byteLength){if(typeof string!=="string"){throw new Error("Input must be string")}var charLength=string.length;var curByteLength=0;var codePoint;var segment;for(var i=0;i<charLength;i+=1){codePoint=string.charCodeAt(i);segment=string[i];if(isHighSurrogate(codePoint)&&isLowSurrogate(string.charCodeAt(i+1))){i+=1;segment+=string[i]}curByteLength+=getLength(segment);if(curByteLength===byteLength){return string.slice(0,i+1)}else if(curByteLength>byteLength){return string.slice(0,i-segment.length+1)}}return string}},{}],30:[function(require,module,exports){module.exports=which;which.sync=whichSync;var isWindows=process.platform==="win32"||process.env.OSTYPE==="cygwin"||process.env.OSTYPE==="msys";var path=require("path");var COLON=isWindows?";":":";var isexe=require("isexe");function getNotFoundError(cmd){var er=new Error("not found: "+cmd);er.code="ENOENT";return er}function getPathInfo(cmd,opt){var colon=opt.colon||COLON;var pathEnv=opt.path||process.env.PATH||"";var pathExt=[""];pathEnv=pathEnv.split(colon);var pathExtExe="";if(isWindows){pathEnv.unshift(process.cwd());pathExtExe=opt.pathExt||process.env.PATHEXT||".EXE;.CMD;.BAT;.COM";pathExt=pathExtExe.split(colon);if(cmd.indexOf(".")!==-1&&pathExt[0]!=="")pathExt.unshift("")}if(cmd.match(/\//)||isWindows&&cmd.match(/\\/))pathEnv=[""];return{env:pathEnv,ext:pathExt,extExe:pathExtExe}}function which(cmd,opt,cb){if(typeof opt==="function"){cb=opt;opt={}}var info=getPathInfo(cmd,opt);var pathEnv=info.env;var pathExt=info.ext;var pathExtExe=info.extExe;var found=[];(function F(i,l){if(i===l){if(opt.all&&found.length)return cb(null,found);else return cb(getNotFoundError(cmd))}var pathPart=pathEnv[i];if(pathPart.charAt(0)==='"'&&pathPart.slice(-1)==='"')pathPart=pathPart.slice(1,-1);var p=path.join(pathPart,cmd);if(!pathPart&&/^\.[\\\/]/.test(cmd)){p=cmd.slice(0,2)+p}(function E(ii,ll){if(ii===ll)return F(i+1,l);var ext=pathExt[ii];isexe(p+ext,{pathExt:pathExtExe},(function(er,is){if(!er&&is){if(opt.all)found.push(p+ext);else return cb(null,p+ext)}return E(ii+1,ll)}))})(0,pathExt.length)})(0,pathEnv.length)}function whichSync(cmd,opt){opt=opt||{};var info=getPathInfo(cmd,opt);var pathEnv=info.env;var pathExt=info.ext;var pathExtExe=info.extExe;var found=[];for(var i=0,l=pathEnv.length;i<l;i++){var pathPart=pathEnv[i];if(pathPart.charAt(0)==='"'&&pathPart.slice(-1)==='"')pathPart=pathPart.slice(1,-1);var p=path.join(pathPart,cmd);if(!pathPart&&/^\.[\\\/]/.test(cmd)){p=cmd.slice(0,2)+p}for(var j=0,ll=pathExt.length;j<ll;j++){var cur=p+pathExt[j];var is;try{is=isexe.sync(cur,{pathExt:pathExtExe});if(is){if(opt.all)found.push(cur);else return cur}}catch(ex){}}}if(opt.all&&found.length)return found;if(opt.nothrow)return null;throw getNotFoundError(cmd)}},{isexe:17,path:undefined}],31:[function(require,module,exports){const{setTimeout:setTimeout}=require("timers");module.exports=class Cache extends Map{constructor(timeout=1e3){super();this.timeout=timeout}set(key,value){if(this.has(key)){clearTimeout(super.get(key).tid)}super.set(key,{tid:setTimeout(this.delete.bind(this,key),this.timeout).unref(),value:value})}get(key){let entry=super.get(key);if(entry){return entry.value}return null}getOrSet(key,fn){if(this.has(key)){return this.get(key)}else{let value=fn();this.set(key,value);(async()=>{try{await value}catch(err){this.delete(key)}})();return value}}delete(key){let entry=super.get(key);if(entry){clearTimeout(entry.tid);super.delete(key)}}clear(){for(let entry of this.values()){clearTimeout(entry.tid)}super.clear()}}},{timers:undefined}],32:[function(require,module,exports){const utils=require("./utils");const FORMATS=require("./formats");const audioEncodingRanks=["mp4a","mp3","vorbis","aac","opus","flac"];const videoEncodingRanks=["mp4v","avc1","Sorenson H.283","MPEG-4 Visual","VP8","VP9","H.264"];const getVideoBitrate=format=>format.bitrate||0;const getVideoEncodingRank=format=>videoEncodingRanks.findIndex((enc=>format.codecs&&format.codecs.includes(enc)));const getAudioBitrate=format=>format.audioBitrate||0;const getAudioEncodingRank=format=>audioEncodingRanks.findIndex((enc=>format.codecs&&format.codecs.includes(enc)));const sortFormatsBy=(a,b,sortBy)=>{let res=0;for(let fn of sortBy){res=fn(b)-fn(a);if(res!==0){break}}return res};const sortFormatsByVideo=(a,b)=>sortFormatsBy(a,b,[format=>parseInt(format.qualityLabel),getVideoBitrate,getVideoEncodingRank]);const sortFormatsByAudio=(a,b)=>sortFormatsBy(a,b,[getAudioBitrate,getAudioEncodingRank]);exports.sortFormats=(a,b)=>sortFormatsBy(a,b,[format=>+!!format.isHLS,format=>+!!format.isDashMPD,format=>+(format.contentLength>0),format=>+(format.hasVideo&&format.hasAudio),format=>+format.hasVideo,format=>parseInt(format.qualityLabel)||0,getVideoBitrate,getAudioBitrate,getVideoEncodingRank,getAudioEncodingRank]);exports.chooseFormat=(formats,options)=>{if(typeof options.format==="object"){if(!options.format.url){throw Error("Invalid format given, did you use `ytdl.getInfo()`?")}return options.format}if(options.filter){formats=exports.filterFormats(formats,options.filter)}if(formats.some((fmt=>fmt.isHLS))){formats=formats.filter((fmt=>fmt.isHLS||!fmt.isLive))}let format;const quality=options.quality||"highest";switch(quality){case"highest":format=formats[0];break;case"lowest":format=formats[formats.length-1];break;case"highestaudio":{formats=exports.filterFormats(formats,"audio");formats.sort(sortFormatsByAudio);const bestAudioFormat=formats[0];formats=formats.filter((f=>sortFormatsByAudio(bestAudioFormat,f)===0));const worstVideoQuality=formats.map((f=>parseInt(f.qualityLabel)||0)).sort(((a,b)=>a-b))[0];format=formats.find((f=>(parseInt(f.qualityLabel)||0)===worstVideoQuality));break}case"lowestaudio":formats=exports.filterFormats(formats,"audio");formats.sort(sortFormatsByAudio);format=formats[formats.length-1];break;case"highestvideo":{formats=exports.filterFormats(formats,"video");formats.sort(sortFormatsByVideo);const bestVideoFormat=formats[0];formats=formats.filter((f=>sortFormatsByVideo(bestVideoFormat,f)===0));const worstAudioQuality=formats.map((f=>f.audioBitrate||0)).sort(((a,b)=>a-b))[0];format=formats.find((f=>(f.audioBitrate||0)===worstAudioQuality));break}case"lowestvideo":formats=exports.filterFormats(formats,"video");formats.sort(sortFormatsByVideo);format=formats[formats.length-1];break;default:format=getFormatByQuality(quality,formats);break}if(!format){throw Error(`No such format found: ${quality}`)}return format};const getFormatByQuality=(quality,formats)=>{let getFormat=itag=>formats.find((format=>`${format.itag}`===`${itag}`));if(Array.isArray(quality)){return getFormat(quality.find((q=>getFormat(q))))}else{return getFormat(quality)}};exports.filterFormats=(formats,filter)=>{let fn;switch(filter){case"videoandaudio":case"audioandvideo":fn=format=>format.hasVideo&&format.hasAudio;break;case"video":fn=format=>format.hasVideo;break;case"videoonly":fn=format=>format.hasVideo&&!format.hasAudio;break;case"audio":fn=format=>format.hasAudio;break;case"audioonly":fn=format=>!format.hasVideo&&format.hasAudio;break;default:if(typeof filter==="function"){fn=filter}else{throw TypeError(`Given filter (${filter}) is not supported`)}}return formats.filter((format=>!!format.url&&fn(format)))};exports.addFormatMeta=format=>{format=Object.assign({},FORMATS[format.itag],format);format.hasVideo=!!format.qualityLabel;format.hasAudio=!!format.audioBitrate;format.container=format.mimeType?format.mimeType.split(";")[0].split("/")[1]:null;format.codecs=format.mimeType?utils.between(format.mimeType,'codecs="','"'):null;format.videoCodec=format.hasVideo&&format.codecs?format.codecs.split(", ")[0]:null;format.audioCodec=format.hasAudio&&format.codecs?format.codecs.split(", ").slice(-1)[0]:null;format.isLive=/\bsource[/=]yt_live_broadcast\b/.test(format.url);format.isHLS=/\/manifest\/hls_(variant|playlist)\//.test(format.url);format.isDashMPD=/\/manifest\/dash\//.test(format.url);return format}},{"./formats":33,"./utils":39}],33:[function(require,module,exports){module.exports={5:{mimeType:'video/flv; codecs="Sorenson H.283, mp3"',qualityLabel:"240p",bitrate:25e4,audioBitrate:64},6:{mimeType:'video/flv; codecs="Sorenson H.263, mp3"',qualityLabel:"270p",bitrate:8e5,audioBitrate:64},13:{mimeType:'video/3gp; codecs="MPEG-4 Visual, aac"',qualityLabel:null,bitrate:5e5,audioBitrate:null},17:{mimeType:'video/3gp; codecs="MPEG-4 Visual, aac"',qualityLabel:"144p",bitrate:5e4,audioBitrate:24},18:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"360p",bitrate:5e5,audioBitrate:96},22:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"720p",bitrate:2e6,audioBitrate:192},34:{mimeType:'video/flv; codecs="H.264, aac"',qualityLabel:"360p",bitrate:5e5,audioBitrate:128},35:{mimeType:'video/flv; codecs="H.264, aac"',qualityLabel:"480p",bitrate:8e5,audioBitrate:128},36:{mimeType:'video/3gp; codecs="MPEG-4 Visual, aac"',qualityLabel:"240p",bitrate:175e3,audioBitrate:32},37:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"1080p",bitrate:3e6,audioBitrate:192},38:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"3072p",bitrate:35e5,audioBitrate:192},43:{mimeType:'video/webm; codecs="VP8, vorbis"',qualityLabel:"360p",bitrate:5e5,audioBitrate:128},44:{mimeType:'video/webm; codecs="VP8, vorbis"',qualityLabel:"480p",bitrate:1e6,audioBitrate:128},45:{mimeType:'video/webm; codecs="VP8, vorbis"',qualityLabel:"720p",bitrate:2e6,audioBitrate:192},46:{mimeType:'audio/webm; codecs="vp8, vorbis"',qualityLabel:"1080p",bitrate:null,audioBitrate:192},82:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"360p",bitrate:5e5,audioBitrate:96},83:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"240p",bitrate:5e5,audioBitrate:96},84:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"720p",bitrate:2e6,audioBitrate:192},85:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"1080p",bitrate:3e6,audioBitrate:192},91:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"144p",bitrate:1e5,audioBitrate:48},92:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"240p",bitrate:15e4,audioBitrate:48},93:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"360p",bitrate:5e5,audioBitrate:128},94:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"480p",bitrate:8e5,audioBitrate:128},95:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"720p",bitrate:15e5,audioBitrate:256},96:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"1080p",bitrate:25e5,audioBitrate:256},100:{mimeType:'audio/webm; codecs="VP8, vorbis"',qualityLabel:"360p",bitrate:null,audioBitrate:128},101:{mimeType:'audio/webm; codecs="VP8, vorbis"',qualityLabel:"360p",bitrate:null,audioBitrate:192},102:{mimeType:'audio/webm; codecs="VP8, vorbis"',qualityLabel:"720p",bitrate:null,audioBitrate:192},120:{mimeType:'video/flv; codecs="H.264, aac"',qualityLabel:"720p",bitrate:2e6,audioBitrate:128},127:{mimeType:'audio/ts; codecs="aac"',qualityLabel:null,bitrate:null,audioBitrate:96},128:{mimeType:'audio/ts; codecs="aac"',qualityLabel:null,bitrate:null,audioBitrate:96},132:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"240p",bitrate:15e4,audioBitrate:48},133:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"240p",bitrate:2e5,audioBitrate:null},134:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"360p",bitrate:3e5,audioBitrate:null},135:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"480p",bitrate:5e5,audioBitrate:null},136:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"720p",bitrate:1e6,audioBitrate:null},137:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"1080p",bitrate:25e5,audioBitrate:null},138:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"4320p",bitrate:135e5,audioBitrate:null},139:{mimeType:'audio/mp4; codecs="aac"',qualityLabel:null,bitrate:null,audioBitrate:48},140:{mimeType:'audio/m4a; codecs="aac"',qualityLabel:null,bitrate:null,audioBitrate:128},141:{mimeType:'audio/mp4; codecs="aac"',qualityLabel:null,bitrate:null,audioBitrate:256},151:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"720p",bitrate:5e4,audioBitrate:24},160:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"144p",bitrate:1e5,audioBitrate:null},171:{mimeType:'audio/webm; codecs="vorbis"',qualityLabel:null,bitrate:null,audioBitrate:128},172:{mimeType:'audio/webm; codecs="vorbis"',qualityLabel:null,bitrate:null,audioBitrate:192},242:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"240p",bitrate:1e5,audioBitrate:null},243:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"360p",bitrate:25e4,audioBitrate:null},244:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"480p",bitrate:5e5,audioBitrate:null},247:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"720p",bitrate:7e5,audioBitrate:null},248:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"1080p",bitrate:15e5,audioBitrate:null},249:{mimeType:'audio/webm; codecs="opus"',qualityLabel:null,bitrate:null,audioBitrate:48},250:{mimeType:'audio/webm; codecs="opus"',qualityLabel:null,bitrate:null,audioBitrate:64},251:{mimeType:'audio/webm; codecs="opus"',qualityLabel:null,bitrate:null,audioBitrate:160},264:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"1440p",bitrate:4e6,audioBitrate:null},266:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"2160p",bitrate:125e5,audioBitrate:null},271:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"1440p",bitrate:9e6,audioBitrate:null},272:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"4320p",bitrate:2e7,audioBitrate:null},278:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"144p 30fps",bitrate:8e4,audioBitrate:null},298:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"720p",bitrate:3e6,audioBitrate:null},299:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"1080p",bitrate:55e5,audioBitrate:null},300:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"720p",bitrate:1318e3,audioBitrate:48},302:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"720p HFR",bitrate:25e5,audioBitrate:null},303:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"1080p HFR",bitrate:5e6,audioBitrate:null},308:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"1440p HFR",bitrate:1e7,audioBitrate:null},313:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"2160p",bitrate:13e6,audioBitrate:null},315:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"2160p HFR",bitrate:2e7,audioBitrate:null},330:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"144p HDR, HFR",bitrate:8e4,audioBitrate:null},331:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"240p HDR, HFR",bitrate:1e5,audioBitrate:null},332:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"360p HDR, HFR",bitrate:25e4,audioBitrate:null},333:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"240p HDR, HFR",bitrate:5e5,audioBitrate:null},334:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"720p HDR, HFR",bitrate:1e6,audioBitrate:null},335:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"1080p HDR, HFR",bitrate:15e5,audioBitrate:null},336:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"1440p HDR, HFR",bitrate:5e6,audioBitrate:null},337:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"2160p HDR, HFR",bitrate:12e6,audioBitrate:null}}},{}],34:[function(require,module,exports){const PassThrough=require("stream").PassThrough;const getInfo=require("./info");const utils=require("./utils");const formatUtils=require("./format-utils");const urlUtils=require("./url-utils");const sig=require("./sig");const miniget=require("miniget");const m3u8stream=require("m3u8stream");const{parseTimestamp:parseTimestamp}=require("m3u8stream");const ytdl=(link,options)=>{const stream=createStream(options);ytdl.getInfo(link,options).then((info=>{downloadFromInfoCallback(stream,info,options)}),stream.emit.bind(stream,"error"));return stream};module.exports=ytdl;ytdl.getBasicInfo=getInfo.getBasicInfo;ytdl.getInfo=getInfo.getInfo;ytdl.chooseFormat=formatUtils.chooseFormat;ytdl.filterFormats=formatUtils.filterFormats;ytdl.validateID=urlUtils.validateID;ytdl.validateURL=urlUtils.validateURL;ytdl.getURLVideoID=urlUtils.getURLVideoID;ytdl.getVideoID=urlUtils.getVideoID;ytdl.cache={sig:sig.cache,info:getInfo.cache,watch:getInfo.watchPageCache,cookie:getInfo.cookieCache};ytdl.version=require("../package.json").version;const createStream=options=>{const stream=new PassThrough({highWaterMark:options&&options.highWaterMark||1024*512});stream._destroy=()=>{stream.destroyed=true};return stream};const pipeAndSetEvents=(req,stream,end)=>{["abort","request","response","error","redirect","retry","reconnect"].forEach((event=>{req.prependListener(event,stream.emit.bind(stream,event))}));req.pipe(stream,{end:end})};const downloadFromInfoCallback=(stream,info,options)=>{options=options||{};let err=utils.playError(info.player_response,["UNPLAYABLE","LIVE_STREAM_OFFLINE","LOGIN_REQUIRED"]);if(err){stream.emit("error",err);return}if(!info.formats.length){stream.emit("error",Error("This video is unavailable"));return}let format;try{format=formatUtils.chooseFormat(info.formats,options)}catch(e){stream.emit("error",e);return}stream.emit("info",info,format);if(stream.destroyed){return}let contentLength,downloaded=0;const ondata=chunk=>{downloaded+=chunk.length;stream.emit("progress",chunk.length,downloaded,contentLength)};const dlChunkSize=options.dlChunkSize||1024*1024*10;let req;let shouldEnd=true;if(format.isHLS||format.isDashMPD){req=m3u8stream(format.url,{chunkReadahead:+info.live_chunk_readahead,begin:options.begin||format.isLive&&Date.now(),liveBuffer:options.liveBuffer,requestOptions:options.requestOptions,parser:format.isDashMPD?"dash-mpd":"m3u8",id:format.itag});req.on("progress",((segment,totalSegments)=>{stream.emit("progress",segment.size,segment.num,totalSegments)}));pipeAndSetEvents(req,stream,shouldEnd)}else{const requestOptions=Object.assign({},options.requestOptions,{maxReconnects:6,maxRetries:3,backoff:{inc:500,max:1e4}});let shouldBeChunked=dlChunkSize!==0&&(!format.hasAudio||!format.hasVideo);if(shouldBeChunked){let start=options.range&&options.range.start||0;let end=start+dlChunkSize;const rangeEnd=options.range&&options.range.end;contentLength=options.range?(rangeEnd?rangeEnd+1:parseInt(format.contentLength))-start:parseInt(format.contentLength);const getNextChunk=()=>{if(!rangeEnd&&end>=contentLength)end=0;if(rangeEnd&&end>rangeEnd)end=rangeEnd;shouldEnd=!end||end===rangeEnd;requestOptions.headers=Object.assign({},requestOptions.headers,{Range:`bytes=${start}-${end||""}`});req=miniget(format.url,requestOptions);req.on("data",ondata);req.on("end",(()=>{if(stream.destroyed){return}if(end&&end!==rangeEnd){start=end+1;end+=dlChunkSize;getNextChunk()}}));pipeAndSetEvents(req,stream,shouldEnd)};getNextChunk()}else{if(options.begin){format.url+=`&begin=${parseTimestamp(options.begin)}`}if(options.range&&(options.range.start||options.range.end)){requestOptions.headers=Object.assign({},requestOptions.headers,{Range:`bytes=${options.range.start||"0"}-${options.range.end||""}`})}req=miniget(format.url,requestOptions);req.on("response",(res=>{if(stream.destroyed){return}contentLength=contentLength||parseInt(res.headers["content-length"])}));req.on("data",ondata);pipeAndSetEvents(req,stream,shouldEnd)}}stream._destroy=()=>{stream.destroyed=true;req.destroy();req.end()}};ytdl.downloadFromInfo=(info,options)=>{const stream=createStream(options);if(!info.full){throw Error("Cannot use `ytdl.downloadFromInfo()` when called "+"with info from `ytdl.getBasicInfo()`")}setImmediate((()=>{downloadFromInfoCallback(stream,info,options)}));return stream}},{"../package.json":40,"./format-utils":32,"./info":36,"./sig":37,"./url-utils":38,"./utils":39,m3u8stream:21,miniget:25,stream:undefined}],35:[function(require,module,exports){const utils=require("./utils");const qs=require("querystring");const{parseTimestamp:parseTimestamp}=require("m3u8stream");const BASE_URL="https://www.youtube.com/watch?v=";const TITLE_TO_CATEGORY={song:{name:"Music",url:"https://music.youtube.com/"}};const getText=obj=>obj?obj.runs?obj.runs[0].text:obj.simpleText:null;exports.getMedia=info=>{let media={};let results=[];try{results=info.response.contents.twoColumnWatchNextResults.results.results.contents}catch(err){}let result=results.find((v=>v.videoSecondaryInfoRenderer));if(!result){return{}}try{let metadataRows=(result.metadataRowContainer||result.videoSecondaryInfoRenderer.metadataRowContainer).metadataRowContainerRenderer.rows;for(let row of metadataRows){if(row.metadataRowRenderer){let title=getText(row.metadataRowRenderer.title).toLowerCase();let contents=row.metadataRowRenderer.contents[0];media[title]=getText(contents);let runs=contents.runs;if(runs&&runs[0].navigationEndpoint){media[`${title}_url`]=new URL(runs[0].navigationEndpoint.commandMetadata.webCommandMetadata.url,BASE_URL).toString()}if(title in TITLE_TO_CATEGORY){media.category=TITLE_TO_CATEGORY[title].name;media.category_url=TITLE_TO_CATEGORY[title].url}}else if(row.richMetadataRowRenderer){let contents=row.richMetadataRowRenderer.contents;let boxArt=contents.filter((meta=>meta.richMetadataRenderer.style==="RICH_METADATA_RENDERER_STYLE_BOX_ART"));for(let{richMetadataRenderer:richMetadataRenderer}of boxArt){let meta=richMetadataRenderer;media.year=getText(meta.subtitle);let type=getText(meta.callToAction).split(" ")[1];media[type]=getText(meta.title);media[`${type}_url`]=new URL(meta.endpoint.commandMetadata.webCommandMetadata.url,BASE_URL).toString();media.thumbnails=meta.thumbnail.thumbnails}let topic=contents.filter((meta=>meta.richMetadataRenderer.style==="RICH_METADATA_RENDERER_STYLE_TOPIC"));for(let{richMetadataRenderer:richMetadataRenderer}of topic){let meta=richMetadataRenderer;media.category=getText(meta.title);media.category_url=new URL(meta.endpoint.commandMetadata.webCommandMetadata.url,BASE_URL).toString()}}}}catch(err){}return media};const isVerified=badges=>!!(badges&&badges.find((b=>b.metadataBadgeRenderer.tooltip==="Verified")));exports.getAuthor=info=>{let channelId,thumbnails=[],subscriberCount,verified=false;try{let results=info.response.contents.twoColumnWatchNextResults.results.results.contents;let v=results.find((v2=>v2.videoSecondaryInfoRenderer&&v2.videoSecondaryInfoRenderer.owner&&v2.videoSecondaryInfoRenderer.owner.videoOwnerRenderer));let videoOwnerRenderer=v.videoSecondaryInfoRenderer.owner.videoOwnerRenderer;channelId=videoOwnerRenderer.navigationEndpoint.browseEndpoint.browseId;thumbnails=videoOwnerRenderer.thumbnail.thumbnails.map((thumbnail=>{thumbnail.url=new URL(thumbnail.url,BASE_URL).toString();return thumbnail}));subscriberCount=utils.parseAbbreviatedNumber(getText(videoOwnerRenderer.subscriberCountText));verified=isVerified(videoOwnerRenderer.badges)}catch(err){}try{let videoDetails=info.player_response.microformat&&info.player_response.microformat.playerMicroformatRenderer;let id=videoDetails&&videoDetails.channelId||channelId||info.player_response.videoDetails.channelId;let author={id:id,name:videoDetails?videoDetails.ownerChannelName:info.player_response.videoDetails.author,user:videoDetails?videoDetails.ownerProfileUrl.split("/").slice(-1)[0]:null,channel_url:`https://www.youtube.com/channel/${id}`,external_channel_url:videoDetails?`https://www.youtube.com/channel/${videoDetails.externalChannelId}`:"",user_url:videoDetails?new URL(videoDetails.ownerProfileUrl,BASE_URL).toString():"",thumbnails:thumbnails,verified:verified,subscriber_count:subscriberCount};if(thumbnails.length){utils.deprecate(author,"avatar",author.thumbnails[0].url,"author.avatar","author.thumbnails[0].url")}return author}catch(err){return{}}};const parseRelatedVideo=(details,rvsParams)=>{if(!details)return;try{let viewCount=getText(details.viewCountText);let shortViewCount=getText(details.shortViewCountText);let rvsDetails=rvsParams.find((elem=>elem.id===details.videoId));if(!/^\d/.test(shortViewCount)){shortViewCount=rvsDetails&&rvsDetails.short_view_count_text||""}viewCount=(/^\d/.test(viewCount)?viewCount:shortViewCount).split(" ")[0];let browseEndpoint=details.shortBylineText.runs[0].navigationEndpoint.browseEndpoint;let channelId=browseEndpoint.browseId;let name=getText(details.shortBylineText);let user=(browseEndpoint.canonicalBaseUrl||"").split("/").slice(-1)[0];let video={id:details.videoId,title:getText(details.title),published:getText(details.publishedTimeText),author:{id:channelId,name:name,user:user,channel_url:`https://www.youtube.com/channel/${channelId}`,user_url:`https://www.youtube.com/user/${user}`,thumbnails:details.channelThumbnail.thumbnails.map((thumbnail=>{thumbnail.url=new URL(thumbnail.url,BASE_URL).toString();return thumbnail})),verified:isVerified(details.ownerBadges),[Symbol.toPrimitive](){console.warn(`\`relatedVideo.author\` will be removed in a near future release, `+`use \`relatedVideo.author.name\` instead.`);return video.author.name}},short_view_count_text:shortViewCount.split(" ")[0],view_count:viewCount.replace(/,/g,""),length_seconds:details.lengthText?Math.floor(parseTimestamp(getText(details.lengthText))/1e3):rvsParams&&`${rvsParams.length_seconds}`,thumbnails:details.thumbnail.thumbnails,richThumbnails:details.richThumbnail?details.richThumbnail.movingThumbnailRenderer.movingThumbnailDetails.thumbnails:[],isLive:!!(details.badges&&details.badges.find((b=>b.metadataBadgeRenderer.label==="LIVE NOW")))};utils.deprecate(video,"author_thumbnail",video.author.thumbnails[0].url,"relatedVideo.author_thumbnail","relatedVideo.author.thumbnails[0].url");utils.deprecate(video,"ucid",video.author.id,"relatedVideo.ucid","relatedVideo.author.id");utils.deprecate(video,"video_thumbnail",video.thumbnails[0].url,"relatedVideo.video_thumbnail","relatedVideo.thumbnails[0].url");return video}catch(err){}};exports.getRelatedVideos=info=>{let rvsParams=[],secondaryResults=[];try{rvsParams=info.response.webWatchNextResponseExtensionData.relatedVideoArgs.split(",").map((e=>qs.parse(e)))}catch(err){}try{secondaryResults=info.response.contents.twoColumnWatchNextResults.secondaryResults.secondaryResults.results}catch(err){return[]}let videos=[];for(let result of secondaryResults||[]){let details=result.compactVideoRenderer;if(details){let video=parseRelatedVideo(details,rvsParams);if(video)videos.push(video)}else{let autoplay=result.compactAutoplayRenderer||result.itemSectionRenderer;if(!autoplay||!Array.isArray(autoplay.contents))continue;for(let content of autoplay.contents){let video=parseRelatedVideo(content.compactVideoRenderer,rvsParams);if(video)videos.push(video)}}}return videos};exports.getLikes=info=>{try{let contents=info.response.contents.twoColumnWatchNextResults.results.results.contents;let video=contents.find((r=>r.videoPrimaryInfoRenderer));let buttons=video.videoPrimaryInfoRenderer.videoActions.menuRenderer.topLevelButtons;let like=buttons.find((b=>b.toggleButtonRenderer&&b.toggleButtonRenderer.defaultIcon.iconType==="LIKE"));return parseInt(like.toggleButtonRenderer.defaultText.accessibility.accessibilityData.label.replace(/\D+/g,""))}catch(err){return null}};exports.getDislikes=info=>{try{let contents=info.response.contents.twoColumnWatchNextResults.results.results.contents;let video=contents.find((r=>r.videoPrimaryInfoRenderer));let buttons=video.videoPrimaryInfoRenderer.videoActions.menuRenderer.topLevelButtons;let dislike=buttons.find((b=>b.toggleButtonRenderer&&b.toggleButtonRenderer.defaultIcon.iconType==="DISLIKE"));return parseInt(dislike.toggleButtonRenderer.defaultText.accessibility.accessibilityData.label.replace(/\D+/g,""))}catch(err){return null}};exports.cleanVideoDetails=(videoDetails,info)=>{videoDetails.thumbnails=videoDetails.thumbnail.thumbnails;delete videoDetails.thumbnail;utils.deprecate(videoDetails,"thumbnail",{thumbnails:videoDetails.thumbnails},"videoDetails.thumbnail.thumbnails","videoDetails.thumbnails");videoDetails.description=videoDetails.shortDescription||getText(videoDetails.description);delete videoDetails.shortDescription;utils.deprecate(videoDetails,"shortDescription",videoDetails.description,"videoDetails.shortDescription","videoDetails.description");videoDetails.lengthSeconds=info.player_response.microformat&&info.player_response.microformat.playerMicroformatRenderer.lengthSeconds||info.player_response.videoDetails.lengthSeconds;return videoDetails};exports.getStoryboards=info=>{const parts=info.player_response.storyboards&&info.player_response.storyboards.playerStoryboardSpecRenderer&&info.player_response.storyboards.playerStoryboardSpecRenderer.spec&&info.player_response.storyboards.playerStoryboardSpecRenderer.spec.split("|");if(!parts)return[];const url=new URL(parts.shift());return parts.map(((part,i)=>{let[thumbnailWidth,thumbnailHeight,thumbnailCount,columns,rows,interval,nameReplacement,sigh]=part.split("#");url.searchParams.set("sigh",sigh);thumbnailCount=parseInt(thumbnailCount,10);columns=parseInt(columns,10);rows=parseInt(rows,10);const storyboardCount=Math.ceil(thumbnailCount/(columns*rows));return{templateUrl:url.toString().replace("$L",i).replace("$N",nameReplacement),thumbnailWidth:parseInt(thumbnailWidth,10),thumbnailHeight:parseInt(thumbnailHeight,10),thumbnailCount:thumbnailCount,interval:parseInt(interval,10),columns:columns,rows:rows,storyboardCount:storyboardCount}}))};exports.getChapters=info=>{const playerOverlayRenderer=info.response&&info.response.playerOverlays&&info.response.playerOverlays.playerOverlayRenderer;const playerBar=playerOverlayRenderer&&playerOverlayRenderer.decoratedPlayerBarRenderer&&playerOverlayRenderer.decoratedPlayerBarRenderer.decoratedPlayerBarRenderer&&playerOverlayRenderer.decoratedPlayerBarRenderer.decoratedPlayerBarRenderer.playerBar;const markersMap=playerBar&&playerBar.multiMarkersPlayerBarRenderer&&playerBar.multiMarkersPlayerBarRenderer.markersMap;const marker=Array.isArray(markersMap)&&markersMap.find((m=>m.value&&Array.isArray(m.value.chapters)));if(!marker)return[];const chapters=marker.value.chapters;return chapters.map((chapter=>({title:getText(chapter.chapterRenderer.title),start_time:chapter.chapterRenderer.timeRangeStartMillis/1e3})))}},{"./utils":39,m3u8stream:21,querystring:undefined}],36:[function(require,module,exports){const querystring=require("querystring");const sax=require("sax");const miniget=require("miniget");const utils=require("./utils");const{setTimeout:setTimeout}=require("timers");const formatUtils=require("./format-utils");const urlUtils=require("./url-utils");const extras=require("./info-extras");const sig=require("./sig");const Cache=require("./cache");const BASE_URL="https://www.youtube.com/watch?v=";exports.cache=new Cache;exports.cookieCache=new Cache(1e3*60*60*24);exports.watchPageCache=new Cache;let cver="2.20210622.10.00";class UnrecoverableError extends Error{}const AGE_RESTRICTED_URLS=["support.google.com/youtube/?p=age_restrictions","youtube.com/t/community_guidelines"];exports.getBasicInfo=async(id,options)=>{const retryOptions=Object.assign({},miniget.defaultOptions,options.requestOptions);options.requestOptions=Object.assign({},options.requestOptions,{});options.requestOptions.headers=Object.assign({},{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.101 Safari/537.36"},options.requestOptions.headers);const validate=info=>{let playErr=utils.playError(info.player_response,["ERROR"],UnrecoverableError);let privateErr=privateVideoError(info.player_response);if(playErr||privateErr){throw playErr||privateErr}return info&&info.player_response&&(info.player_response.streamingData||isRental(info.player_response)||isNotYetBroadcasted(info.player_response))};let info=await pipeline([id,options],validate,retryOptions,[getWatchHTMLPage,getWatchJSONPage,getVideoInfoPage]);Object.assign(info,{formats:parseFormats(info.player_response),related_videos:extras.getRelatedVideos(info)});const media=extras.getMedia(info);const additional={author:extras.getAuthor(info),media:media,likes:extras.getLikes(info),dislikes:extras.getDislikes(info),age_restricted:!!(media&&media.notice_url&&AGE_RESTRICTED_URLS.some((url=>media.notice_url.includes(url)))),video_url:BASE_URL+id,storyboards:extras.getStoryboards(info),chapters:extras.getChapters(info)};info.videoDetails=extras.cleanVideoDetails(Object.assign({},info.player_response&&info.player_response.microformat&&info.player_response.microformat.playerMicroformatRenderer,info.player_response&&info.player_response.videoDetails,additional),info);return info};const privateVideoError=player_response=>{let playability=player_response&&player_response.playabilityStatus;if(playability&&playability.status==="LOGIN_REQUIRED"&&playability.messages&&playability.messages.filter((m=>/This is a private video/.test(m))).length){return new UnrecoverableError(playability.reason||playability.messages&&playability.messages[0])}else{return null}};const isRental=player_response=>{let playability=player_response.playabilityStatus;return playability&&playability.status==="UNPLAYABLE"&&playability.errorScreen&&playability.errorScreen.playerLegacyDesktopYpcOfferRenderer};const isNotYetBroadcasted=player_response=>{let playability=player_response.playabilityStatus;return playability&&playability.status==="LIVE_STREAM_OFFLINE"};const getWatchHTMLURL=(id,options)=>`${BASE_URL+id}&hl=${options.lang||"en"}`;const getWatchHTMLPageBody=(id,options)=>{const url=getWatchHTMLURL(id,options);return exports.watchPageCache.getOrSet(url,(()=>utils.exposedMiniget(url,options).text()))};const EMBED_URL="https://www.youtube.com/embed/";const getEmbedPageBody=(id,options)=>{const embedUrl=`${EMBED_URL+id}?hl=${options.lang||"en"}`;return utils.exposedMiniget(embedUrl,options).text()};const getHTML5player=body=>{let html5playerRes=/<script\s+src="([^"]+)"(?:\s+type="text\/javascript")?\s+name="player_ias\/base"\s*>|"jsUrl":"([^"]+)"/.exec(body);return html5playerRes?html5playerRes[1]||html5playerRes[2]:null};const getIdentityToken=(id,options,key,throwIfNotFound)=>exports.cookieCache.getOrSet(key,(async()=>{let page=await getWatchHTMLPageBody(id,options);let match=page.match(/(["'])ID_TOKEN\1[:,]\s?"([^"]+)"/);if(!match&&throwIfNotFound){throw new UnrecoverableError("Cookie header used in request, but unable to find YouTube identity token")}return match&&match[2]}));const pipeline=async(args,validate,retryOptions,endpoints)=>{let info;for(let func of endpoints){try{const newInfo=await retryFunc(func,args.concat([info]),retryOptions);if(newInfo.player_response){newInfo.player_response.videoDetails=assign(info&&info.player_response&&info.player_response.videoDetails,newInfo.player_response.videoDetails);newInfo.player_response=assign(info&&info.player_response,newInfo.player_response)}info=assign(info,newInfo);if(validate(info,false)){break}}catch(err){if(err instanceof UnrecoverableError||func===endpoints[endpoints.length-1]){throw err}}}return info};const assign=(target,source)=>{if(!target||!source){return target||source}for(let[key,value]of Object.entries(source)){if(value!==null&&value!==undefined){target[key]=value}}return target};const retryFunc=async(func,args,options)=>{let currentTry=0,result;while(currentTry<=options.maxRetries){try{result=await func(...args);break}catch(err){if(err instanceof UnrecoverableError||err instanceof miniget.MinigetError&&err.statusCode<500||currentTry>=options.maxRetries){throw err}let wait=Math.min(++currentTry*options.backoff.inc,options.backoff.max);await new Promise((resolve=>setTimeout(resolve,wait)))}}return result};const jsonClosingChars=/^[)\]}'\s]+/;const parseJSON=(source,varName,json)=>{if(!json||typeof json==="object"){return json}else{try{json=json.replace(jsonClosingChars,"");return JSON.parse(json)}catch(err){throw Error(`Error parsing ${varName} in ${source}: ${err.message}`)}}};const findJSON=(source,varName,body,left,right,prependJSON)=>{let jsonStr=utils.between(body,left,right);if(!jsonStr){throw Error(`Could not find ${varName} in ${source}`)}return parseJSON(source,varName,utils.cutAfterJSON(`${prependJSON}${jsonStr}`))};const findPlayerResponse=(source,info)=>{const player_response=info&&(info.args&&info.args.player_response||info.player_response||info.playerResponse||info.embedded_player_response);return parseJSON(source,"player_response",player_response)};const getWatchJSONURL=(id,options)=>`${getWatchHTMLURL(id,options)}&pbj=1`;const getWatchJSONPage=async(id,options)=>{const reqOptions=Object.assign({headers:{}},options.requestOptions);let cookie=reqOptions.headers.Cookie||reqOptions.headers.cookie;reqOptions.headers=Object.assign({"x-youtube-client-name":"1","x-youtube-client-version":cver,"x-youtube-identity-token":exports.cookieCache.get(cookie||"browser")||""},reqOptions.headers);const setIdentityToken=async(key,throwIfNotFound)=>{if(reqOptions.headers["x-youtube-identity-token"]){return}reqOptions.headers["x-youtube-identity-token"]=await getIdentityToken(id,options,key,throwIfNotFound)};if(cookie){await setIdentityToken(cookie,true)}const jsonUrl=getWatchJSONURL(id,options);const body=await utils.exposedMiniget(jsonUrl,options,reqOptions).text();let parsedBody=parseJSON("watch.json","body",body);if(parsedBody.reload==="now"){await setIdentityToken("browser",false)}if(parsedBody.reload==="now"||!Array.isArray(parsedBody)){throw Error("Unable to retrieve video metadata in watch.json")}let info=parsedBody.reduce(((part,curr)=>Object.assign(curr,part)),{});info.player_response=findPlayerResponse("watch.json",info);info.html5player=info.player&&info.player.assets&&info.player.assets.js;return info};const getWatchHTMLPage=async(id,options)=>{let body=await getWatchHTMLPageBody(id,options);let info={page:"watch"};try{cver=utils.between(body,'{"key":"cver","value":"','"}');info.player_response=findJSON("watch.html","player_response",body,/\bytInitialPlayerResponse\s*=\s*\{/i,"<\/script>","{")}catch(err){let args=findJSON("watch.html","player_response",body,/\bytplayer\.config\s*=\s*{/,"<\/script>","{");info.player_response=findPlayerResponse("watch.html",args)}info.response=findJSON("watch.html","response",body,/\bytInitialData("\])?\s*=\s*\{/i,"<\/script>","{");info.html5player=getHTML5player(body);return info};const INFO_HOST="www.youtube.com";const INFO_PATH="/get_video_info";const VIDEO_EURL="https://youtube.googleapis.com/v/";const getVideoInfoPage=async(id,options)=>{const url=new URL(`https://${INFO_HOST}${INFO_PATH}`);url.searchParams.set("video_id",id);url.searchParams.set("c","TVHTML5");url.searchParams.set("cver",`7${cver.substr(1)}`);url.searchParams.set("eurl",VIDEO_EURL+id);url.searchParams.set("ps","default");url.searchParams.set("gl","US");url.searchParams.set("hl",options.lang||"en");url.searchParams.set("html5","1");const body=await utils.exposedMiniget(url.toString(),options).text();let info=querystring.parse(body);info.player_response=findPlayerResponse("get_video_info",info);return info};const parseFormats=player_response=>{let formats=[];if(player_response&&player_response.streamingData){formats=formats.concat(player_response.streamingData.formats||[]).concat(player_response.streamingData.adaptiveFormats||[])}return formats};exports.getInfo=async(id,options)=>{let info=await exports.getBasicInfo(id,options);const hasManifest=info.player_response&&info.player_response.streamingData&&(info.player_response.streamingData.dashManifestUrl||info.player_response.streamingData.hlsManifestUrl);let funcs=[];if(info.formats.length){info.html5player=info.html5player||getHTML5player(await getWatchHTMLPageBody(id,options))||getHTML5player(await getEmbedPageBody(id,options));if(!info.html5player){throw Error("Unable to find html5player file")}const html5player=new URL(info.html5player,BASE_URL).toString();funcs.push(sig.decipherFormats(info.formats,html5player,options))}if(hasManifest&&info.player_response.streamingData.dashManifestUrl){let url=info.player_response.streamingData.dashManifestUrl;funcs.push(getDashManifest(url,options))}if(hasManifest&&info.player_response.streamingData.hlsManifestUrl){let url=info.player_response.streamingData.hlsManifestUrl;funcs.push(getM3U8(url,options))}let results=await Promise.all(funcs);info.formats=Object.values(Object.assign({},...results));info.formats=info.formats.map(formatUtils.addFormatMeta);info.formats.sort(formatUtils.sortFormats);info.full=true;return info};const getDashManifest=(url,options)=>new Promise(((resolve,reject)=>{let formats={};const parser=sax.parser(false);parser.onerror=reject;let adaptationSet;parser.onopentag=node=>{if(node.name==="ADAPTATIONSET"){adaptationSet=node.attributes}else if(node.name==="REPRESENTATION"){const itag=parseInt(node.attributes.ID);if(!isNaN(itag)){formats[url]=Object.assign({itag:itag,url:url,bitrate:parseInt(node.attributes.BANDWIDTH),mimeType:`${adaptationSet.MIMETYPE}; codecs="${node.attributes.CODECS}"`},node.attributes.HEIGHT?{width:parseInt(node.attributes.WIDTH),height:parseInt(node.attributes.HEIGHT),fps:parseInt(node.attributes.FRAMERATE)}:{audioSampleRate:node.attributes.AUDIOSAMPLINGRATE})}}};parser.onend=()=>{resolve(formats)};const req=utils.exposedMiniget(new URL(url,BASE_URL).toString(),options);req.setEncoding("utf8");req.on("error",reject);req.on("data",(chunk=>{parser.write(chunk)}));req.on("end",parser.close.bind(parser))}));const getM3U8=async(url,options)=>{url=new URL(url,BASE_URL);const body=await utils.exposedMiniget(url.toString(),options).text();let formats={};body.split("\n").filter((line=>/^https?:\/\//.test(line))).forEach((line=>{const itag=parseInt(line.match(/\/itag\/(\d+)\//)[1]);formats[line]={itag:itag,url:line}}));return formats};for(let funcName of["getBasicInfo","getInfo"]){const func=exports[funcName];exports[funcName]=async(link,options={})=>{utils.checkForUpdates();let id=await urlUtils.getVideoID(link);const key=[funcName,id,options.lang].join("-");return exports.cache.getOrSet(key,(()=>func(id,options)))}}exports.validateID=urlUtils.validateID;exports.validateURL=urlUtils.validateURL;exports.getURLVideoID=urlUtils.getURLVideoID;exports.getVideoID=urlUtils.getVideoID},{"./cache":31,"./format-utils":32,"./info-extras":35,"./sig":37,"./url-utils":38,"./utils":39,miniget:25,querystring:undefined,sax:27,timers:undefined}],37:[function(require,module,exports){const querystring=require("querystring");const Cache=require("./cache");const utils=require("./utils");const vm=require("vm");exports.cache=new Cache;exports.getFunctions=(html5playerfile,options)=>exports.cache.getOrSet(html5playerfile,(async()=>{const body=await utils.exposedMiniget(html5playerfile,options).text();const functions=exports.extractFunctions(body);if(!functions||!functions.length){throw Error("Could not extract functions")}exports.cache.set(html5playerfile,functions);return functions}));exports.extractFunctions=body=>{const functions=[];const extractManipulations=caller=>{const functionName=utils.between(caller,`a=a.split("");`,`.`);if(!functionName)return"";const functionStart=`var ${functionName}={`;const ndx=body.indexOf(functionStart);if(ndx<0)return"";const subBody=body.slice(ndx+functionStart.length-1);return`var ${functionName}=${utils.cutAfterJSON(subBody)}`};const extractDecipher=()=>{const functionName=utils.between(body,`a.set("alr","yes");c&&(c=`,`(decodeURIC`);if(functionName&&functionName.length){const functionStart=`${functionName}=function(a)`;const ndx=body.indexOf(functionStart);if(ndx>=0){const subBody=body.slice(ndx+functionStart.length);let functionBody=`var ${functionStart}${utils.cutAfterJSON(subBody)}`;functionBody=`${extractManipulations(functionBody)};${functionBody};${functionName}(sig);`;functions.push(functionBody)}}};const extractNCode=()=>{let functionName=utils.between(body,`&&(b=a.get("n"))&&(b=`,`(b)`);if(functionName.includes("["))functionName=utils.between(body,`${functionName.split("[")[0]}=[`,`]`);if(functionName&&functionName.length){const functionStart=`${functionName}=function(a)`;const ndx=body.indexOf(functionStart);if(ndx>=0){const subBody=body.slice(ndx+functionStart.length);const functionBody=`var ${functionStart}${utils.cutAfterJSON(subBody)};${functionName}(ncode);`;functions.push(functionBody)}}};extractDecipher();extractNCode();return functions};exports.setDownloadURL=(format,decipherScript,nTransformScript)=>{const decipher=url=>{const args=querystring.parse(url);if(!args.s||!decipherScript)return args.url;const components=new URL(decodeURIComponent(args.url));components.searchParams.set(args.sp?args.sp:"signature",decipherScript.runInNewContext({sig:decodeURIComponent(args.s)}));return components.toString()};const ncode=url=>{const components=new URL(decodeURIComponent(url));const n=components.searchParams.get("n");if(!n||!nTransformScript)return url;components.searchParams.set("n",nTransformScript.runInNewContext({ncode:n}));return components.toString()};const cipher=!format.url;const url=format.url||format.signatureCipher||format.cipher;format.url=cipher?ncode(decipher(url)):ncode(url);delete format.signatureCipher;delete format.cipher};exports.decipherFormats=async(formats,html5player,options)=>{let decipheredFormats={};let functions=await exports.getFunctions(html5player,options);const decipherScript=functions.length?new vm.Script(functions[0]):null;const nTransformScript=functions.length>1?new vm.Script(functions[1]):null;formats.forEach((format=>{exports.setDownloadURL(format,decipherScript,nTransformScript);decipheredFormats[format.url]=format}));return decipheredFormats}},{"./cache":31,"./utils":39,querystring:undefined,vm:undefined}],38:[function(require,module,exports){const validQueryDomains=new Set(["youtube.com","www.youtube.com","m.youtube.com","music.youtube.com","gaming.youtube.com"]);const validPathDomains=/^https?:\/\/(youtu\.be\/|(www\.)?youtube\.com\/(embed|v|shorts)\/)/;exports.getURLVideoID=link=>{const parsed=new URL(link);let id=parsed.searchParams.get("v");if(validPathDomains.test(link)&&!id){const paths=parsed.pathname.split("/");id=parsed.host==="youtu.be"?paths[1]:paths[2]}else if(parsed.hostname&&!validQueryDomains.has(parsed.hostname)){throw Error("Not a YouTube domain")}if(!id){throw Error(`No video id found: ${link}`)}id=id.substring(0,11);if(!exports.validateID(id)){throw TypeError(`Video id (${id}) does not match expected `+`format (${idRegex.toString()})`)}return id};const urlRegex=/^https?:\/\//;exports.getVideoID=str=>{if(exports.validateID(str)){return str}else if(urlRegex.test(str)){return exports.getURLVideoID(str)}else{throw Error(`No video id found: ${str}`)}};const idRegex=/^[a-zA-Z0-9-_]{11}$/;exports.validateID=id=>idRegex.test(id);exports.validateURL=string=>{try{exports.getURLVideoID(string);return true}catch(e){return false}}},{}],39:[function(require,module,exports){const miniget=require("miniget");exports.between=(haystack,left,right)=>{let pos;if(left instanceof RegExp){const match=haystack.match(left);if(!match){return""}pos=match.index+match[0].length}else{pos=haystack.indexOf(left);if(pos===-1){return""}pos+=left.length}haystack=haystack.slice(pos);pos=haystack.indexOf(right);if(pos===-1){return""}haystack=haystack.slice(0,pos);return haystack};exports.parseAbbreviatedNumber=string=>{const match=string.replace(",",".").replace(" ","").match(/([\d,.]+)([MK]?)/);if(match){let[,num,multi]=match;num=parseFloat(num);return Math.round(multi==="M"?num*1e6:multi==="K"?num*1e3:num)}return null};exports.cutAfterJSON=mixedJson=>{let open,close;if(mixedJson[0]==="["){open="[";close="]"}else if(mixedJson[0]==="{"){open="{";close="}"}if(!open){throw new Error(`Can't cut unsupported JSON (need to begin with [ or { ) but got: ${mixedJson[0]}`)}let isString=false;let isEscaped=false;let counter=0;let i;for(i=0;i<mixedJson.length;i++){if(mixedJson[i]==='"'&&!isEscaped){isString=!isString;continue}isEscaped=mixedJson[i]==="\\"&&!isEscaped;if(isString)continue;if(mixedJson[i]===open){counter++}else if(mixedJson[i]===close){counter--}if(counter===0){return mixedJson.substr(0,i+1)}}throw Error("Can't cut unsupported JSON (no matching closing bracket found)")};exports.playError=(player_response,statuses,ErrorType=Error)=>{let playability=player_response&&player_response.playabilityStatus;if(playability&&statuses.includes(playability.status)){return new ErrorType(playability.reason||playability.messages&&playability.messages[0])}return null};exports.exposedMiniget=(url,options={},requestOptionsOverwrite)=>{const req=miniget(url,requestOptionsOverwrite||options.requestOptions);if(typeof options.requestCallback==="function")options.requestCallback(req);return req};exports.deprecate=(obj,prop,value,oldPath,newPath)=>{Object.defineProperty(obj,prop,{get:()=>{console.warn(`\`${oldPath}\` will be removed in a near future release, `+`use \`${newPath}\` instead.`);return value}})};const pkg=require("../package.json");const UPDATE_INTERVAL=1e3*60*60*12;exports.lastUpdateCheck=0;exports.checkForUpdates=()=>{if(!process.env.YTDL_NO_UPDATE&&!pkg.version.startsWith("0.0.0-")&&Date.now()-exports.lastUpdateCheck>=UPDATE_INTERVAL){exports.lastUpdateCheck=Date.now();return miniget("https://api.github.com/repos/fent/node-ytdl-core/releases/latest",{headers:{"User-Agent":"ytdl-core"}}).text().then((response=>{if(JSON.parse(response).tag_name!==`v${pkg.version}`){console.warn('[33mWARNING:[0m ytdl-core is out of date! Update with "npm install ytdl-core@latest".')}}),(err=>{console.warn("Error checking for updates:",err.message);console.warn("You can disable this check by setting the `YTDL_NO_UPDATE` env variable.")}))}return null}},{"../package.json":40,miniget:25}],40:[function(require,module,exports){module.exports={name:"ytdl-core",description:"YouTube video downloader in pure javascript.",keywords:["youtube","video","download"],version:"4.10.1",repository:{type:"git",url:"git://github.com/fent/node-ytdl-core.git"},author:"fent <fentbox@gmail.com> (https://github.com/fent)",contributors:["Tobias Kutscha (https://github.com/TimeForANinja)","Andrew Kelley (https://github.com/andrewrk)","Mauricio Allende (https://github.com/mallendeo)","Rodrigo Altamirano (https://github.com/raltamirano)","Jim Buck (https://github.com/JimmyBoh)"],main:"./lib/index.js",types:"./typings/index.d.ts",files:["lib","typings"],scripts:{test:"nyc --reporter=lcov --reporter=text-summary npm run test:unit","test:unit":"mocha --ignore test/irl-test.js test/*-test.js --timeout 4000","test:irl":"mocha --timeout 16000 test/irl-test.js",lint:"eslint ./","lint:fix":"eslint --fix ./","lint:typings":"tslint typings/index.d.ts","lint:typings:fix":"tslint --fix typings/index.d.ts"},dependencies:{m3u8stream:"^0.8.6",miniget:"^4.0.0",sax:"^1.1.3"},devDependencies:{"@types/node":"^13.1.0","assert-diff":"^3.0.1",dtslint:"^3.6.14",eslint:"^6.8.0",mocha:"^7.0.0","muk-require":"^1.2.0",nock:"^13.0.4",nyc:"^15.0.0",sinon:"^9.0.0","stream-equal":"~1.1.0",typescript:"^3.9.7"},engines:{node:">=10"},license:"MIT"}},{}]},{},[1]);
